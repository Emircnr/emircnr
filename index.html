<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GLOBAL RTS — Online Prototip</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#111a2f; --text:#e6edf6; --muted:#9fb0c8; --accent:#22d3ee; --good:#34d399; --warn:#f59e0b; --bad:#ef4444; --beam:#ff7a00;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 30% 10%, #12203a 0%, #0b1220 55%, #070c17 100%);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial}
    #app{height:100%;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    header .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    header .brand .dot{width:10px;height:10px;border-radius:50%;background:conic-gradient(from 0deg,#22d3ee,#34d399,#60a5fa,#22d3ee)}
    header .right{display:flex;gap:10px;align-items:center}

    /* Panels */
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.3);border-radius:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;font-weight:600;border-radius:10px;border:1px solid rgba(255,255,255,.15);padding:8px 12px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));color:var(--text);cursor:pointer}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,#22d3ee,#0ea5e9)}
    .row{display:flex;gap:10px;align-items:center}

    /* Layout */
    #gameWrap{position:relative;height:100%;}
    #canvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:#08101e}

    /* HUD */
    #hud{position:absolute;left:12px;top:70px;display:flex;flex-direction:column;gap:8px;z-index:5}
    #res{padding:10px 12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    #res .chip{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09)}
    #res .chip b{font-weight:800}
    #buildPanel{padding:8px 10px;display:grid;grid-template-columns:repeat(3, minmax(150px, 1fr));gap:8px;max-width:520px}
    .tile{padding:10px;border-radius:12px;background:rgba(17,26,47,.85);border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .tile:hover{outline:2px solid rgba(34,211,238,.6)}
    .tile small{display:block;color:var(--muted)}

    /* Right panels */
    #rightPanels{position:absolute;right:12px;top:70px;display:flex;flex-direction:column;gap:10px;z-index:5}
    #selection{padding:10px;width:280px}
    #trainPanel{padding:10px;width:320px}

    /* Lobby */
    #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(10,15,28,.8), rgba(10,15,28,.8));backdrop-filter:blur(6px);z-index:20}
    #login{width:min(920px, 96vw);display:grid;grid-template-columns:1.2fr .8fr;gap:18px;padding:20px}
    #login .col{padding:18px}
    #login h2{margin:0 0 10px;font-size:26px}
    #login label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    #login input, #login select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0c1428;color:var(--text)}

    /* Player list */
    #players{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;padding:8px;z-index:5}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06)}

    /* Tooltips */
    .muted{color:var(--muted)}

    /* Mini help */
    #help{position:absolute;right:12px;bottom:12px;padding:10px 12px;max-width:420px;z-index:6}

    /* Contextless right click */
    body.nocontext{ -webkit-touch-callout:none; -webkit-user-select:none; -khtml-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none }
  </style>
</head>
<body class="nocontext">
<div id="app">
  <header>
    <div class="brand"><div class="dot"></div> GLOBAL RTS <span class="muted" style="font-weight:600">— Firebase Online</span></div>
    <div class="right">
      <div id="roomChip" class="pill">Oda: <b id="roomIdLabel">-</b></div>
      <button class="btn" id="leaveBtn" title="Odayı terk et">Çıkış</button>
    </div>
  </header>

  <div id="gameWrap">
    <canvas id="canvas"></canvas>

    <!-- HUD Left -->
    <div id="hud">
      <div id="res" class="glass">
        <div class="chip">🍞 <span>Yiyecek:</span> <b id="r_food">0</b></div>
        <div class="chip">⛏️ <span>Demir:</span> <b id="r_iron">0</b></div>
        <div class="chip">🪙 <span>Altın:</span> <b id="r_gold">0</b></div>
        <div class="chip">🛢️ <span>Petrol:</span> <b id="r_oil">0</b></div>
      </div>
      <div id="buildPanel" class="glass"></div>
    </div>

    <!-- HUD Right -->
    <div id="rightPanels">
      <div id="selection" class="glass">
        <div style="font-weight:800">Seçim</div>
        <div id="selectionBody" class="muted">Bir birim veya bina seçiniz.</div>
      </div>
      <div id="trainPanel" class="glass">
        <div style="font-weight:800">Üretim</div>
        <div id="trainBody" class="muted">Uygun bina seçildiğinde birim üretilebilir.</div>
      </div>
    </div>

    <div id="players" class="glass"></div>

    <div id="help" class="glass">
      <div style="font-weight:800">Kontroller</div>
      <div class="muted">Sol tık: seç / inşa. Sağ tık: hareket / saldır. WASD: kamera. Tekerlek: yakınlaştır. Hücre başına en fazla 2 bina. Seçili birimde şeffaf halka menzilini gösterir. Düşman menzile girince otomatik ateş açılır (turuncu ışın). Köprüler su geçişlerini sağlar.</div>
    </div>

    <!-- LOBBY OVERLAY -->
    <div id="overlay">
      <div id="login" class="glass">
        <div class="col">
          <h2>Oyun Girişi</h2>
          <label>İsim</label>
          <input id="nameInput" placeholder="Komutan adı" maxlength="18"/>
          <div class="row" style="margin-top:10px; gap:12px">
            <div style="flex:1">
              <label>Ülke / Bayrak</label>
              <select id="flagSelect"></select>
            </div>
          </div>
          <div class="row" style="margin-top:14px">
            <button class="btn primary" id="authBtn">Giriş Yap</button>
          </div>
        </div>
        <div class="col">
          <h2>Oda</h2>
          <label>Oda Kodu (örn: 4H7Q)</label>
          <input id="roomInput" placeholder="Mevcut odaya katıl" maxlength="8"/>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="joinBtn">Odaya Katıl</button>
            <button class="btn primary" id="createBtn">Yeni Oda Oluştur</button>
          </div>
          <div class="muted" style="margin-top:12px;font-size:13px">Arkadaşlarınla aynı oda kodunu paylaş.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script>
// ==========================
//  Firebase INIT
// ==========================
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com",
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.firebasestorage.app",
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ==========================
//  Basic Helpers
// ==========================
const randId = (n=8)=>Math.random().toString(36).slice(2,2+n).toUpperCase();
const clamp=(v,a,b)=>v<a?a:(v>b?b:v);
const lerp=(a,b,t)=>a+(b-a)*t;
const now=()=>performance.now();
const countryList = [
  ['TR','🇹🇷 Türkiye'],['US','🇺🇸 USA'],['GB','🇬🇧 UK'],['DE','🇩🇪 Almanya'],['FR','🇫🇷 Fransa'],['IT','🇮🇹 İtalya'],
  ['ES','🇪🇸 İspanya'],['RU','🇷🇺 Rusya'],['UA','🇺🇦 Ukrayna'],['CN','🇨🇳 Çin'],['JP','🇯🇵 Japonya'],['KR','🇰🇷 Kore'],
  ['SA','🇸🇦 S.Arabistan'],['AE','🇦🇪 BAE'],['IR','🇮🇷 İran'],['AZ','🇦🇿 Azerbaycan'],['GR','🇬🇷 Yunanistan'],['BR','🇧🇷 Brezilya']
];

// ==========================
//  GAME DATA
// ==========================
const WORLD_SIZE = 2000; // px
const GRID = 20; // 20x20 = 400 kare
const CELL = WORLD_SIZE/GRID; // 100px
const CAMERA = {x: WORLD_SIZE/2-450, y: WORLD_SIZE/2-280, z: 1.0};

// Map regions (sea/desert) & bridges
const WATER_RECTS = [ // [x,y,w,h]
  [600,0,300,1000], // dikey deniz/nehir
  [0,1200,1200,300] // yatay deniz/nehir
];
const BRIDGES = [ // geçilebilir köprü dikdörtgenleri
  {x:720, y:480, w:60, h:40}, // dikey su üstü köprü
  {x:540, y:1210, w:160, h:40} // yatay su üstü köprü
];
const DESERT_RECTS = [ [1200,200,700,700], [1300,1050,600,500] ];

// Resources per player
const START_RES = {food:300, iron:200, gold:150, oil:100};

// Buildings definition (name, cost, prod/sec, category)
const BUILDINGS = {
  HQ:{name:'Ana Üs', cost:{food:0,iron:0,gold:0,oil:0}, hp:2500, allowTrain:false},
  MILL:{name:'Değirmen', cost:{food:80,iron:40,gold:0,oil:0}, prod:{food:1.2}, hp:900, allowTrain:false},
  REFINERY:{name:'Rafineri', cost:{food:40,iron:90,gold:40,oil:0}, prod:{oil:1.0, gold:0.2}, hp:1000, allowTrain:false},
  IRON_MINE:{name:'Demir Madeni', cost:{food:40,iron:60,gold:20,oil:0}, prod:{iron:1.4}, hp:900, allowTrain:false},
  GOLD_MINE:{name:'Altın Madeni', cost:{food:60,iron:80,gold:0,oil:0}, prod:{gold:0.6}, hp:800, allowTrain:false},
  TANK_FAC:{name:'Tank Fabrikası', cost:{food:60,iron:140,gold:60,oil:40}, hp:1200, allowTrain:true, trains:['IFV','MBT','SPG','MLRS']},
  MISSILE_FAC:{name:'Füze Fabrikası', cost:{food:60,iron:120,gold:80,oil:80}, hp:1100, allowTrain:true, trains:['SAM','ATGM_TRUCK']},
  BARRACKS:{name:'Kışla', cost:{food:80,iron:80,gold:20,oil:0}, hp:900, allowTrain:true, trains:['INF','RPG','ENG']},
  AIRBASE:{name:'Hava Üssü', cost:{food:60,iron:120,gold:100,oil:100}, hp:1300, allowTrain:true, trains:['FIGHTER','BOMBER','HELO']},
  UAV_FAC:{name:'SİHA Üretim', cost:{food:40,iron:80,gold:80,oil:80}, hp:1000, allowTrain:true, trains:['UAV','UCAV']},
  WALL:{name:'Sur', cost:{food:0,iron:20,gold:0,oil:0}, hp:600, wall:true, allowTrain:false},
  AA_TOWER:{name:'Hava Savunma', cost:{food:20,iron:120,gold:40,oil:0}, hp:900, allowTrain:false, turret:'AA'}
};

// Units (≥15 çeşit). Statlar gerçek dünyayla orantılı mantıkta.
// speed px/s, range px, dps damage/s, role
const UNITS = {
  INF:      {name:'Piyade', speed:80, range:120, dps:18,  hp:120,  cost:{food:60, iron:10, gold:0, oil:0}, role:'land'},
  RPG:      {name:'Tanksavar Tim', speed:75, range:160, dps:45,  hp:110,  cost:{food:70, iron:20, gold:10, oil:0}, role:'land'},
  ENG:      {name:'İşçi', speed:85, range:0,  dps:0,   hp:100,  cost:{food:40, iron:10, gold:0, oil:0}, role:'land'},
  IFV:      {name:'Zırhlı Araç', speed:120,range:180, dps:38,  hp:420,  cost:{food:40, iron:120, gold:20, oil:50}, role:'land'},
  MBT:      {name:'Ana Muh.Tank', speed:95, range:220, dps:75,  hp:800,  cost:{food:60, iron:200, gold:40, oil:80}, role:'land'},
  SPG:      {name:'Kundağı Motorlu Obüs', speed:90, range:420, dps:80,  hp:520,  cost:{food:50, iron:180, gold:60, oil:70}, role:'artillery'},
  MLRS:     {name:'ÇNRA', speed:100,range:520, dps:120, hp:450,  cost:{food:60, iron:200, gold:80, oil:90}, role:'artillery'},
  ATGM_TRUCK:{name:'ATGM Araç', speed:110,range:300, dps:95,  hp:300,  cost:{food:50, iron:160, gold:40, oil:60}, role:'land'},
  SAM:      {name:'SAM (HSS)', speed:80, range:520, dps:130, hp:400,  cost:{food:50, iron:180, gold:80, oil:80}, role:'aa'},
  AA:       {name:'AA Kule', speed:0,  range:400, dps:90,  hp:650,  cost:{food:30, iron:150, gold:40, oil:0}, role:'aa', static:true},
  HELO:     {name:'Taarruz Helikopteri', speed:220,range:240, dps:110, hp:380,  cost:{food:60, iron:160, gold:120, oil:140}, role:'air'},
  FIGHTER:  {name:'Savaş Uçağı', speed:380,range:260, dps:150, hp:400,  cost:{food:70, iron:200, gold:200, oil:200}, role:'air'},
  BOMBER:   {name:'Bombardıman', speed:320,range:300, dps:180, hp:500,  cost:{food:80, iron:240, gold:240, oil:240}, role:'air'},
  UAV:      {name:'Keşif İHA', speed:240,range:0,   dps:0,   hp:120,  cost:{food:30, iron:60, gold:60, oil:60}, role:'air'},
  UCAV:     {name:'SİHA', speed:240,range:280, dps:90,  hp:260,  cost:{food:50, iron:120, gold:140, oil:120}, role:'air'}
};

// Which building trains which units (fallback from BUILDINGS)
const TRAIN_OPTIONS = {
  BARRACKS:['INF','RPG','ENG'],
  TANK_FAC:['IFV','MBT','SPG','MLRS','ATGM_TRUCK'],
  MISSILE_FAC:['SAM'],
  AIRBASE:['FIGHTER','BOMBER','HELO'],
  UAV_FAC:['UAV','UCAV']
};

// ==========================
//  STATE
// ==========================
const S = {
  uid:null, me:null, roomId:null, isAuthed:false,
  players:{}, resources:{}, structures:{}, units:{},
  selection:null, selectionType:null, lastFire:0,
  buildingCounts: new Map(),
};

// ==========================
//  UI Elements
// ==========================
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

document.addEventListener('contextmenu', e=> e.preventDefault());

const flagSelect = document.getElementById('flagSelect');
countryList.forEach(([code,label])=>{ const o=document.createElement('option'); o.value=code; o.textContent=label; flagSelect.appendChild(o) });

const overlay = document.getElementById('overlay');
const nameInput = document.getElementById('nameInput');
const roomInput = document.getElementById('roomInput');
const authBtn = document.getElementById('authBtn');
const joinBtn = document.getElementById('joinBtn');
const createBtn = document.getElementById('createBtn');
const leaveBtn = document.getElementById('leaveBtn');
const roomIdLabel = document.getElementById('roomIdLabel');

const resEls = {food: document.getElementById('r_food'), iron:document.getElementById('r_iron'), gold:document.getElementById('r_gold'), oil:document.getElementById('r_oil')};
const buildPanel = document.getElementById('buildPanel');
const selectionBody = document.getElementById('selectionBody');
const trainBody = document.getElementById('trainBody');
const playersPanel = document.getElementById('players');

// ==========================
//  AUTH & LOBBY
// ==========================
let cachedName = '', cachedFlag='TR';
authBtn.onclick = async()=>{
  cachedName = (nameInput.value||'Komutan').trim().slice(0,18);
  cachedFlag = flagSelect.value||'TR';
  try{
    await auth.signInAnonymously();
    S.isAuthed = true;
    alert('Giriş başarılı. Oda seçin veya oluşturun.');
  }catch(err){ console.error(err); alert('Giriş hatası: '+err.message) }
};

createBtn.onclick = async()=>{
  if(!S.isAuthed){ alert('Önce giriş yap.'); return; }
  const rid = randId(4);
  await joinRoom(rid, true);
};
joinBtn.onclick = async()=>{
  if(!S.isAuthed){ alert('Önce giriş yap.'); return; }
  const rid = (roomInput.value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8);
  if(!rid){ alert('Oda kodu gir.'); return; }
  await joinRoom(rid, false);
};
leaveBtn.onclick = ()=>{ if(!S.roomId) return; location.reload() };

auth.onAuthStateChanged(async(user)=>{
  if(user){ S.uid=user.uid; console.log('UID', S.uid); }
});

async function joinRoom(roomId, creating){
  const roomRef = db.ref('rooms/'+roomId);
  const snap = await roomRef.child('createdAt').get();
  if(!snap.exists() && !creating){ alert('Böyle bir oda yok.'); return; }
  const updates = {};
  if(!snap.exists()){
    updates['createdAt'] = firebase.database.ServerValue.TIMESTAMP;
    updates['host'] = S.uid;
    updates['structures'] = {}; updates['units']={};
  }
  // add player
  const color = '#'+(Math.random()*0xffffff|0).toString(16).padStart(6,'0');
  updates['players/'+S.uid] = {name: cachedName||'Komutan', flag: flagSelect.value||'TR', color};
  updates['resources/'+S.uid] = START_RES;
  await roomRef.update(updates);
  S.roomId = roomId;
  roomIdLabel.textContent = roomId;
  overlay.style.display='none';

  // Presence: mark online
  const myRef = roomRef.child('players/'+S.uid);
  myRef.onDisconnect().remove();

  bindRoom(roomId);
  // Spawn HQ near a spawn point if not exists
  ensureHQ(roomId);
}

async function ensureHQ(roomId){
  const list = Object.values(S.structures||{}).filter(s=> s.owner===S.uid && s.type==='HQ');
  if(list.length>0) return;
  const pos = pickSpawn();
  await createStructure('HQ', pos.x, pos.y);
}

function bindRoom(roomId){
  const base = db.ref('rooms/'+roomId);
  base.child('players').on('value', s=>{ S.players = s.val()||{}; renderPlayers() });
  base.child('resources').on('value', s=>{ S.resources = s.val()||{}; updateResUI() });
  base.child('structures').on('value', s=>{ S.structures = s.val()||{}; rebuildBuildingCounts() });
  base.child('units').on('value', s=>{ S.units = s.val()||{}; });
}

function updateResUI(){ const r = S.resources[S.uid]||START_RES; for(const k in resEls) resEls[k].textContent = Math.floor(r[k]||0); }
function renderPlayers(){
  playersPanel.innerHTML='';
  Object.entries(S.players).forEach(([uid,p])=>{
    const d=document.createElement('div'); d.className='pill'; d.style.borderColor=p.color; d.textContent = (flagEmoji(p.flag)+" "+p.name);
    playersPanel.appendChild(d);
  })
}

function flagEmoji(cc){ // cc like 'TR'
  const base=127397; return cc.replace(/./g, ch=> String.fromCodePoint(base+ch.charCodeAt(0)) );
}

// ==========================
//  MAP UTILS
// ==========================
function worldToScreen(x,y){ return {x:(x-CAMERA.x)*CAMERA.z, y:(y-CAMERA.y)*CAMERA.z}; }
function screenToWorld(x,y){ return {x: x/CAMERA.z + CAMERA.x, y: y/CAMERA.z + CAMERA.y}; }
function inRect(x,y,[rx,ry,rw,rh]){ return x>=rx && y>=ry && x<=rx+rw && y<=ry+rh }
function inWater(x,y){
  for(const r of WATER_RECTS){ if(inRect(x,y,r)) return !BRIDGES.some(b=>inRect(x,y,[b.x,b.y,b.w,b.h])); }
  return false;
}
function isPassable(x,y){ return !inWater(x,y); }

function pickSpawn(){
  const spots = [ {x:200,y:200}, {x:1800,y:1800}, {x:1800,y:200}, {x:200,y:1800}, {x:1000,y:1000} ];
  return spots[Math.floor(Math.random()*spots.length)];
}

// ==========================
//  GAME: CREATE / COMMANDS
// ==========================
async function createStructure(type, x, y){
  if(!S.roomId) return;
  // grid cap: max 2 per cell
  const cellX = Math.floor(x/CELL), cellY = Math.floor(y/CELL);
  const key = cellX+','+cellY;
  const count = S.buildingCounts.get(key)||0;
  if(count>=2 && type!=='WALL'){ alert('Bu hücre dolu (2/2).'); return; }
  // costs
  const cost = BUILDINGS[type].cost||{}; if(!canAfford(cost)){ alert('Yetersiz kaynak.'); return; }
  spend(cost);
  const id = db.ref().push().key;
  const st = {id, type, x, y, cellX, cellY, hp: BUILDINGS[type].hp, owner:S.uid};
  await db.ref(`rooms/${S.roomId}/structures/${id}`).set(st);
}

async function createUnit(type, x, y){
  if(!S.roomId) return;
  const conf = UNITS[type];
  if(!conf){ alert('Bilinmeyen birim'); return; }
  const cost = conf.cost||{}; if(!canAfford(cost)){ alert('Yetersiz kaynak.'); return; }
  spend(cost);
  const id = db.ref().push().key;
  const u = {id, type, x, y, vx:0, vy:0, hp: conf.hp, owner:S.uid, targetId:null, tx:x, ty:y, tFire:0};
  await db.ref(`rooms/${S.roomId}/units/${id}`).set(u);
}

function canAfford(cost){ const r=S.resources[S.uid]||START_RES; for(const k of ['food','iron','gold','oil']){ if((cost[k]||0) > (r[k]||0)) return false } return true }
function spend(cost){ const r=Object.assign({}, S.resources[S.uid]||START_RES); ['food','iron','gold','oil'].forEach(k=> r[k]=(r[k]||0)-(cost[k]||0) ); db.ref(`rooms/${S.roomId}/resources/${S.uid}`).set(r); }

// Production from buildings (tick)
let lastProd=now();
function economyTick(){
  const t=now(); if(t-lastProd<1000) return; lastProd=t;
  if(!S.roomId||!S.uid) return;
  const r=Object.assign({food:0,iron:0,gold:0,oil:0}, S.resources[S.uid]||START_RES);
  for(const id in S.structures){ const s=S.structures[id]; if(s.owner!==S.uid) continue; const b=BUILDINGS[s.type]; if(!b||!b.prod) continue; for(const k in b.prod){ r[k]+=b.prod[k]; } }
  db.ref(`rooms/${S.roomId}/resources/${S.uid}`).set(r);
}

function rebuildBuildingCounts(){ S.buildingCounts.clear(); for(const id in S.structures){ const s=S.structures[id]; const key=s.cellX+','+s.cellY; S.buildingCounts.set(key,(S.buildingCounts.get(key)||0)+1) } }

// ==========================
//  INPUT & SELECTION
// ==========================
let mouse={x:0,y:0, down:false, rdown:false};
canvas.addEventListener('mousemove', e=>{ mouse.x=e.offsetX; mouse.y=e.offsetY; });
canvas.addEventListener('mousedown', e=>{ if(e.button===0) onLeftDown(e); if(e.button===2) onRightDown(e) });
window.addEventListener('mouseup', e=>{ mouse.down=false; mouse.rdown=false; });

function onLeftDown(e){
  const pos = screenToWorld(e.offsetX,e.offsetY);
  // click selection: check units mine first, then buildings (any)
  const u = pickUnit(pos.x,pos.y);
  if(u){ S.selection=u; S.selectionType='unit'; refreshSelectionUI(); return; }
  const s = pickStructure(pos.x,pos.y);
  if(s){ S.selection=s; S.selectionType='structure'; refreshSelectionUI(); return; }
  // If build mode? Use buildPanel tiles.
}

function onRightDown(e){
  const pos = screenToWorld(e.offsetX,e.offsetY);
  if(S.selectionType==='unit' && S.selection && S.selection.owner===S.uid){
    // attack-move if clicked enemy
    const enemy = pickUnit(pos.x,pos.y, /*onlyEnemy*/ true);
    if(enemy){ commandAttack(S.selection, enemy.id); return; }
    // else move
    commandMove(S.selection, pos.x,pos.y);
  }
}

function pickUnit(x,y,onlyEnemy=false){
  // simple circle hit
  let found=null, best=1e9; const R=14;
  for(const id in S.units){ const u=S.units[id]; if(onlyEnemy && u.owner===S.uid) continue; const d2=(u.x-x)*(u.x-x)+(u.y-y)*(u.y-y); if(d2<R*R && d2<best){ found=u; best=d2; } }
  return found;
}
function pickStructure(x,y){
  for(const id in S.structures){ const s=S.structures[id]; const sz= (BUILDINGS[s.type]?.wall? 30: 40); if(Math.abs(s.x-x)<sz && Math.abs(s.y-y)<sz) return s; }
  return null;
}

function commandMove(unit, x,y){ if(!isPassable(x,y)){ /* quick bridge route: head to first bridge center */ const b=BRIDGES[0]; x=b.x+b.w/2; y=b.y+b.h/2; }
  db.ref(`rooms/${S.roomId}/units/${unit.id}`).update({tx:x,ty:y}); }
function commandAttack(unit, targetId){ db.ref(`rooms/${S.roomId}/units/${unit.id}`).update({targetId}); }

function refreshSelectionUI(){
  if(!S.selection){ selectionBody.textContent='Seçim yok.'; trainBody.innerHTML=''; return; }
  if(S.selectionType==='unit'){
    const u=UNITS[S.selection.type];
    selectionBody.innerHTML = `<div style="font-weight:700">${u.name}</div>
      <div class="muted">HP: ${S.selection.hp} | Menzil: ${u.range} | DPS: ${u.dps} | Hız: ${u.speed}</div>`;
    trainBody.innerHTML = '<div class="muted">Üretim için bina seçiniz.</div>';
  }else if(S.selectionType==='structure'){
    const b=BUILDINGS[S.selection.type];
    selectionBody.innerHTML = `<div style="font-weight:700">${b.name}</div>
      <div class="muted">HP: ${S.selection.hp}${b.prod?` | Üretim/s: ${Object.entries(b.prod).map(([k,v])=>k+":"+v).join(', ')}`:''}${b.wall?' | Savunma Suru':''}</div>`;
    // Train options
    const opts = TRAIN_OPTIONS[S.selection.type]||BUILDINGS[S.selection.type].trains||[];
    if(opts.length){
      trainBody.innerHTML = '';
      opts.forEach(code=>{
        const u=UNITS[code]; const btn=document.createElement('button'); btn.className='btn'; btn.textContent = `➕ ${u.name}`;
        btn.onclick = ()=> createUnit(code, S.selection.x+(Math.random()*30-15), S.selection.y+(Math.random()*30-15));
        trainBody.appendChild(btn);
      })
    }else{
      trainBody.innerHTML = '<div class="muted">Bu bina üretim yapmaz.</div>';
    }
  }
}

// Build panel
function setupBuildPanel(){
  buildPanel.innerHTML='';
  Object.entries(BUILDINGS).forEach(([k,b])=>{
    if(k==='HQ') return; // HQ sadece ilk spawn
    const t=document.createElement('div'); t.className='tile';
    const cost = ['food','iron','gold','oil'].map(r=> (b.cost?.[r]||0)>0?`${r[0].toUpperCase()+r.slice(1)}:${b.cost[r]}`:'' ).filter(Boolean).join(' ');
    t.innerHTML = `<div style="font-weight:700">${b.name}</div><small>Maliyet: ${cost||'-'}</small>`;
    t.onclick = ()=>{
      // place at mouse world pos
      const pos = screenToWorld(mouse.x,mouse.y);
      if(b.wall){ // tiny segments grid-snapped
        createStructure(k, Math.floor(pos.x/20)*20, Math.floor(pos.y/20)*20);
      }else{
        createStructure(k, Math.floor(pos.x/10)*10, Math.floor(pos.y/10)*10);
      }
    };
    buildPanel.appendChild(t);
  })
}
setupBuildPanel();

// ==========================
//  SIMULATION LOOP
// ==========================
let last=now();
function tick(){
  const t=now(); const dt = clamp((t-last)/1000, 0, 0.05); last=t;
  economyTick();
  simulateUnits(dt);
  draw();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

function simulateUnits(dt){
  // local physics for all units; we only write movement for our own units to reduce traffic
  for(const id in S.units){ const u=S.units[id]; const spec=UNITS[u.type]; if(!spec) continue;
    // move
    if(u.owner===S.uid){
      const dx=u.tx - u.x; const dy=u.ty - u.y; const dist=Math.hypot(dx,dy);
      if(dist>2){ let nx=dx/dist, ny=dy/dist; const speed=spec.speed; let nxpos=u.x+nx*speed*dt, nypos=u.y+ny*speed*dt; if(isPassable(nxpos,nypos)){ u.x=nxpos; u.y=nypos; } }
    }
    // Auto acquire target
    if(!u.targetId){ const target = findNearestEnemy(u, spec.range); if(target) u.targetId=target.id; }
    // Attack
    if(u.targetId){ const enemy=S.units[u.targetId]; if(!enemy || enemy.hp<=0){ u.targetId=null; } else {
      const d = Math.hypot(enemy.x-u.x, enemy.y-u.y);
      if(d<=spec.range){ // fire
        if((u.tFire||0)<=0){
          beam(u.x,u.y, enemy.x, enemy.y); // visual
          applyDamage(enemy.id, spec.dps*dt); // damage transaction
          u.tFire=0.15; // fire cadence visual every 150ms
        } else { u.tFire-=dt; }
      } else {
        // chase a bit if land vs land
        if(u.owner===S.uid){ const dx=enemy.x-u.x, dy=enemy.y-u.y, dist=Math.hypot(dx,dy); let nx=dx/dist, ny=dy/dist; const speed=spec.speed*0.9; let nxpos=u.x+nx*speed*dt, nypos=u.y+ny*speed*dt; if(isPassable(nxpos,nypos)){ u.x=nxpos; u.y=nypos; db.ref(`rooms/${S.roomId}/units/${u.id}`).update({x:u.x,y:u.y}); } }
      }
    }
    // write back my unit position occasionally
    if(u.owner===S.uid && Math.random()<0.25){ db.ref(`rooms/${S.roomId}/units/${u.id}`).update({x:u.x,y:u.y,targetId:u.targetId}); }
  }
}

function findNearestEnemy(me, range){ let best=null, bd=1e9; for(const id in S.units){ const u=S.units[id]; if(u.owner===S.uid) continue; const d=Math.hypot(u.x-me.x,u.y-me.y); if(d<range && d<bd){ bd=d; best=u; } } return best }
function applyDamage(targetId, dmg){ if(!S.roomId) return; const ref=db.ref(`rooms/${S.roomId}/units/${targetId}/hp`); ref.transaction(hp=>{ if(hp==null) return hp; const nh=hp-dmg; return nh<0?0:nh; }); }

// Visual beams store
const beams=[];
function beam(x1,y1,x2,y2){ beams.push({x1,y1,x2,y2,t:0.12}) }

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // grid bg
  drawMap();
  drawGrid();
  // buildings
  for(const id in S.structures){ const s=S.structures[id]; drawStructure(s) }
  // units
  for(const id in S.units){ const u=S.units[id]; drawUnit(u) }
  // selection ring
  if(S.selection && S.selectionType==='unit'){ const spec=UNITS[S.selection.type]; const p=worldToScreen(S.selection.x,S.selection.y); ctx.beginPath(); ctx.arc(p.x,p.y, spec.range*CAMERA.z, 0, Math.PI*2); ctx.fillStyle='rgba(0,255,200,0.08)'; ctx.strokeStyle='rgba(34,211,238,0.5)'; ctx.lineWidth=2; ctx.fill(); ctx.stroke(); }
  // beams
  for(let i=beams.length-1;i>=0;i--){ const b=beams[i]; b.t-=1/60; const a=clamp(b.t/0.12,0,1); const s1=worldToScreen(b.x1,b.y1), s2=worldToScreen(b.x2,b.y2); ctx.strokeStyle=`rgba(255,122,0,${a})`; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(s1.x,s1.y); ctx.lineTo(s2.x,s2.y); ctx.stroke(); if(b.t<=0) beams.splice(i,1); }
}

function drawMap(){
  // land base
  const TL = worldToScreen(0,0), BR = worldToScreen(WORLD_SIZE,WORLD_SIZE);
  ctx.fillStyle = '#0a152a'; ctx.fillRect(TL.x,TL.y,(BR.x-TL.x),(BR.y-TL.y));
  // desert patches
  ctx.fillStyle = '#5b4a2f'; DESERT_RECTS.forEach(r=>{ const a=worldToScreen(r[0],r[1]); ctx.fillRect(a.x,a.y,r[2]*CAMERA.z,r[3]*CAMERA.z); })
  // water
  ctx.fillStyle = '#0a3a55'; WATER_RECTS.forEach(r=>{ const a=worldToScreen(r[0],r[1]); ctx.fillRect(a.x,a.y,r[2]*CAMERA.z,r[3]*CAMERA.z); })
  // bridges
  ctx.fillStyle = '#b8b6ad'; BRIDGES.forEach(b=>{ const a=worldToScreen(b.x,b.y); ctx.fillRect(a.x,a.y,b.w*CAMERA.z,b.h*CAMERA.z); })
}

function drawGrid(){
  const cols=GRID, rows=GRID; const step=CELL*CAMERA.z; const origin = worldToScreen(0,0);
  ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<=cols;i++){ const x=origin.x+i*step; ctx.moveTo(x,origin.y); ctx.lineTo(x,origin.y+rows*step); }
  for(let j=0;j<=rows;j++){ const y=origin.y+j*step; ctx.moveTo(origin.x,y); ctx.lineTo(origin.x+cols*step,y); }
  ctx.stroke();
}

function drawStructure(s){ const b=BUILDINGS[s.type]; if(!b) return; const p=worldToScreen(s.x,s.y); const size=b.wall?10:16; ctx.save(); ctx.translate(p.x,p.y);
  ctx.fillStyle='rgba(255,255,255,0.85)';
  if(b.wall){ ctx.fillRect(-size,-size, size*2, size*2); }
  else { roundedRect(ctx,-size*2,-size*1.5, size*4, size*3, 6); ctx.fill(); }
  // hp bar
  const w=40, h=6; ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(-w/2,-size*1.9-10,w,h); const hpRat=clamp(s.hp/(b.hp||1),0,1); ctx.fillStyle='#22d3ee'; ctx.fillRect(-w/2,-size*1.9-10,w*hpRat,h);
  // name
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font=`600 ${12*CAMERA.z}px Montserrat`; ctx.textAlign='center'; ctx.fillText(b.name, 0, size*2+14);
  ctx.restore();
}

function drawUnit(u){ const spec=UNITS[u.type]; if(!spec) return; const p=worldToScreen(u.x,u.y); ctx.save(); ctx.translate(p.x,p.y);
  // body
  ctx.fillStyle = (u.owner===S.uid? S.players[S.uid]?.color || '#22d3ee' : '#f87171');
  roundedRect(ctx,-10,-6,20,12,4); ctx.fill();
  // direction indicator (to target)
  ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(6,-2,6,4);
  // hp bar above
  const w=28,h=4; ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(-w/2,-12,w,h); const rat=clamp(u.hp/(spec.hp||1),0,1); ctx.fillStyle= rat>0.6? '#34d399' : rat>0.3? '#f59e0b' : '#ef4444'; ctx.fillRect(-w/2,-12,w*rat,h);
  ctx.restore();
}

function roundedRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

// ==========================
//  CAMERA CONTROLS
// ==========================
window.addEventListener('wheel', (e)=>{ const k=e.deltaY>0?0.9:1.1; CAMERA.z=clamp(CAMERA.z*k, 0.5, 2.0); });
const keys={}; window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()]=true }); window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()]=false });
function cameraTick(){ const sp=8/CAMERA.z; if(keys['w']) CAMERA.y-=sp; if(keys['s']) CAMERA.y+=sp; if(keys['a']) CAMERA.x-=sp; if(keys['d']) CAMERA.x+=sp; requestAnimationFrame(cameraTick) } cameraTick();

// ==========================
//  INIT
// ==========================
setupBuildPanel();
updateResUI();

</script>
</body>
</html>
