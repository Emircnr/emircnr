<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GLOBAL RTS â€” Online (20Ã—20)</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">

<!-- Firebase v10 compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --muted:#1e293b; --text:#e6edf6; --accent:#60a5fa;
    --land:#173b2b; --land2:#1e4d36; --desert:#7d6f3a; --desert2:#9a8a4a; --water:#0e2a45; --water2:#12375a; --bridge:#6a7687;
    --grid:#1c2742; --beam:#fb923c; --beamGlow:#ffedd5;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial}
  #app{height:100%;display:grid;grid-template-rows:auto 1fr}
  header{background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(2,8,23,.9)); border-bottom:1px solid #1f2a44; backdrop-filter: blur(6px)}
  .panel{background:linear-gradient(180deg,rgba(17,24,39,.96),rgba(2,8,23,.92)); border:1px solid #233; box-shadow:0 8px 30px rgba(0,0,0,.25); backdrop-filter: blur(6px)}
  .chip{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}
  .btn{background:linear-gradient(180deg,#0ea5e9,#0369a1); border:1px solid #1e3a8a}
  .btn-ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)}
  /* Board */
  #board{position:relative; height:calc(100vh - 58px); overflow:hidden}
  canvas{display:block; image-rendering:pixelated}
  #overlay{position:absolute; inset:0; cursor:default}
  .beam{position:absolute; pointer-events:none; height:3px; background:linear-gradient(90deg,transparent,var(--beam),transparent); transform-origin:left center; filter: drop-shadow(0 0 6px var(--beam)); opacity:.95}
  /* Minimap */
  #minimap{position:absolute; right:14px; bottom:14px; width:220px; height:220px; border:1px solid #334155; background:#0b1322; image-rendering:pixelated; border-radius:10px}
  /* Tooltip */
  .tip{position:absolute; pointer-events:none; background:#0b1322; border:1px solid #334155; padding:.4rem .5rem; font-size:.75rem; border-radius:.5rem; white-space:nowrap}
  /* Modal */
  #modal{background:radial-gradient(1200px 800px at 50% 30%, rgba(96,165,250,.15), transparent 60%) rgba(0,0,0,.65)}
  select option{background:#0b1322; color:#e6edf6}
</style>
</head>
<body>
<div id="app">
  <header class="px-4 py-2 flex items-center gap-3">
    <div class="flex items-center gap-2">
      <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-sky-400 to-indigo-600 shadow"></div>
      <div class="font-bold tracking-wide">GLOBAL RTS</div>
      <div id="roomLabel" class="text-xs opacity-80 ml-2"></div>
      <div id="hostBadge" class="ml-2 text-xs px-2 py-0.5 rounded chip hidden">HOST</div>
    </div>
    <div class="ml-auto flex items-center gap-2 text-sm">
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸ</span><span id="resFood">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>â›ï¸</span><span id="resIron">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸª™</span><span id="resGold">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸ›¢ï¸</span><span id="resOil">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>âš¡</span><span id="resPower">0</span></div>
      <button id="openBuild" class="btn-ghost px-3 py-1.5 rounded">Ä°nÅŸa Et (B)</button>
      <button id="openTrain" class="btn-ghost px-3 py-1.5 rounded">Birim (U)</button>
      <button id="centerBase" class="btn-ghost px-3 py-1.5 rounded">ÃœssÃ¼ Ortala</button>
    </div>
  </header>

  <div id="board">
    <canvas id="world"></canvas>
    <div id="overlay"></div>
    <canvas id="minimap" width="220" height="220"></canvas>

    <!-- Build Panel -->
    <div id="buildPanel" class="panel absolute left-3 top-16 w-[22rem] rounded-xl p-3 hidden">
      <div class="font-semibold mb-2">Ä°nÅŸaat (HÃ¼cre baÅŸÄ±na max 2)</div>
      <div id="buildList" class="grid grid-cols-2 gap-2 text-sm"></div>
    </div>
    <!-- Train Panel -->
    <div id="trainPanel" class="panel absolute left-3 top-16 w-[28rem] rounded-xl p-3 hidden">
      <div class="font-semibold mb-2">Birim Ãœret</div>
      <div id="unitList" class="grid grid-cols-3 gap-2 text-xs"></div>
    </div>
    <!-- Hover Tooltip -->
    <div id="tooltip" class="tip hidden"></div>
    <!-- Status -->
    <div id="status" class="panel absolute right-3 top-16 max-w-md rounded-xl p-3 text-sm"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 flex items-center justify-center z-50">
  <div class="panel w-[600px] rounded-2xl p-5">
    <div class="text-xl font-bold mb-1">GLOBAL RTS â€” Online</div>
    <div class="text-sm opacity-80 mb-4">Ä°smini ve bayraÄŸÄ±nÄ± seÃ§, oda oluÅŸtur ya da ID ile katÄ±l.</div>

    <div class="grid grid-cols-3 gap-3">
      <div class="col-span-2">
        <label class="text-sm">Ä°smin</label>
        <input id="playerName" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700 outline-none focus:ring-2 focus:ring-sky-500" placeholder="Komutan"/>
      </div>
      <div>
        <label class="text-sm">Bayrak</label>
        <select id="playerFlag" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700">
          <option>ğŸ‡¹ğŸ‡· TÃ¼rkiye</option><option>ğŸ‡ºğŸ‡¸ USA</option><option>ğŸ‡¬ğŸ‡§ UK</option><option>ğŸ‡©ğŸ‡ª Almanya</option>
          <option>ğŸ‡«ğŸ‡· Fransa</option><option>ğŸ‡ªğŸ‡¸ Ä°spanya</option><option>ğŸ‡·ğŸ‡º Rusya</option><option>ğŸ‡®ğŸ‡³ Hindistan</option>
          <option>ğŸ‡¨ğŸ‡³ Ã‡in</option><option>ğŸ‡¯ğŸ‡µ Japonya</option><option>ğŸ‡§ğŸ‡· Brezilya</option><option>ğŸ‡¸ğŸ‡¦ Suudi Arabistan</option>
          <option>ğŸ‡®ğŸ‡· Ä°ran</option><option>ğŸ‡®ğŸ‡¶ Irak</option><option>ğŸ‡¦ğŸ‡¿ Azerbaycan</option><option>ğŸ‡ºğŸ‡¦ Ukrayna</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-3 mt-4">
      <div class="col-span-2">
        <label class="text-sm">Oda ID</label>
        <input id="roomIdInput" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700" placeholder="Ã¶r. DESERT-41F6"/>
      </div>
      <div class="flex gap-2 items-end">
        <button id="btnCreate" class="btn px-3 py-2 rounded w-full">OluÅŸtur</button>
        <button id="btnJoin" class="btn-ghost px-3 py-2 rounded w-full">KatÄ±l</button>
      </div>
    </div>

    <div class="mt-3 text-xs opacity-70">
      Ä°pucu: Ä°lk giren â€œHOSTâ€ olur. Host Ã§Ä±karsa otomatik yeni host atanÄ±r.
    </div>
  </div>
</div>

<script>
/* =======================
   Firebase Config
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com", // KONSOLUNUZDAN DOÄRULAYIN
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.appspot.com", // dÃ¼zeltilmiÅŸ
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* =======================
   KÄ±sa yardÄ±mcÄ±lar
======================= */
const $ = s => document.querySelector(s);
const now = () => Date.now();
function toast(msg, type='info'){
  const box = $('#status');
  const palette = type==='error'?'#fca5a5':(type==='warn'?'#fde68a':'#93c5fd');
  box.innerHTML = `<div style="color:${palette}">${msg}</div>`;
  setTimeout(()=>{ if(box.innerText===msg) box.innerHTML=''; }, 6000);
}
const randId = (p='') => p + Math.random().toString(36).slice(2,8).toUpperCase();

/* =======================
   Oyun Sabitleri
======================= */
const GRID = 20;                // 20Ã—20 = 400 hÃ¼cre
const CELL = 56;                // gÃ¶rsel Ã§Ã¶zÃ¼nÃ¼rlÃ¼k
const WORLD_W = GRID * CELL;
const WORLD_H = GRID * CELL;
const TICK_MS = 100;
const MAX_BUILD_PER_CELL = 2;
const RES = ["food","iron","gold","oil","power"];

/* Ä°konlu Binalar */
const BUILDINGS = [
  {name:"Ãœs Merkezi", code:"HQ",   icon:"ğŸ¯", tint:"#cbd5e1", cost:{food:100,iron:100,gold:100,oil:0,power:0}, hp:3200, income:{}, place:'land', unique:true},
  {name:"DeÄŸirmen", code:"MILL",   icon:"ğŸŒ¾", tint:"#86efac", cost:{food:50,iron:10,gold:0,oil:0,power:5}, hp:800, income:{food:30}, place:'land'},
  {name:"Demir Madeni", code:"IMINE",icon:"â›ï¸", tint:"#93c5fd", cost:{food:20,iron:0,gold:0,oil:0,power:10}, hp:900, income:{iron:25}, place:'land'},
  {name:"AltÄ±n Madeni", code:"GMINE",icon:"ğŸª™", tint:"#fde68a", cost:{food:30,iron:10,gold:0,oil:0,power:10}, hp:900, income:{gold:15}, place:'land'},
  {name:"Rafineri", code:"REF",   icon:"ğŸ­", tint:"#fca5a5", cost:{food:20,iron:30,gold:10,oil:0,power:20}, hp:1000, income:{oil:20}, place:'land'},
  {name:"JeneratÃ¶r", code:"POW",  icon:"âš¡",  tint:"#a5b4fc", cost:{food:10,iron:30,gold:10,oil:10,power:0}, hp:900, income:{power:30}, place:'land'},
  {name:"KÄ±ÅŸla", code:"BARR",     icon:"ğŸª–", tint:"#93c5fd", cost:{food:60,iron:40,gold:20,oil:0,power:10}, hp:1200, income:{}, place:'land', trains:["INF","MG","MORTAR"]},
  {name:"Tank FabrikasÄ±", code:"TFACT", icon:"ğŸ› ï¸", tint:"#fbbf24", cost:{food:40,iron:120,gold:80,oil:40,power:30}, hp:1400, income:{}, place:'land', trains:["MBT","IFV","APC","SPG","LAV"]},
  {name:"FÃ¼ze FabrikasÄ±", code:"MFACT", icon:"ğŸ¯", tint:"#f472b6", cost:{food:40,iron:120,gold:120,oil:60,power:40}, hp:1400, income:{}, place:'land', trains:["MLRS","ATGM","SAM"]},
  {name:"Hava ÃœssÃ¼", code:"AIRB", icon:"ğŸ›«", tint:"#60a5fa", cost:{food:60,iron:140,gold:160,oil:120,power:60}, hp:1600, income:{}, place:'land', trains:["FTR","BMB","HELI"]},
  {name:"SÄ°HA Merkezi", code:"UAVC", icon:"ğŸ›©ï¸", tint:"#a78bfa", cost:{food:40,iron:60,gold:120,oil:80,power:40}, hp:1200, income:{}, place:'land', trains:["UAV","UCAV"]},
  {name:"Hava Savunma", code:"AADF", icon:"ğŸ›¡ï¸", tint:"#67e8f9", cost:{food:30,iron:100,gold:80,oil:40,power:40}, hp:1200, income:{}, place:'land', trains:["AAA","SAM"]},
  {name:"Duvar", code:"WALL",     icon:"ğŸ§±", tint:"#94a3b8", cost:{food:0,iron:20,gold:0,oil:0,power:0}, hp:1400, income:{}, place:'land|desert|bridge', blocks:true},
  {name:"KÃ¶prÃ¼", code:"BRDG",     icon:"ğŸŒ‰", tint:"#e2e8f0", cost:{food:0,iron:40,gold:20,oil:0,power:0}, hp:1000, income:{}, place:'water', special:"bridge"}
];

/* 15+ Birim (ikonlarla) */
const UNITS = [
  {name:"Piyade", code:"INF", icon:"ğŸª–", cat:"ground", vs:["ground"], hp:110, spd:2.2, rng:3, dps:12, cost:{food:40,iron:10,gold:0,oil:0,power:0}},
  {name:"MG Timi", code:"MG", icon:"ğŸ›¡ï¸", cat:"ground", vs:["ground"], hp:140, spd:1.8, rng:4, dps:18, cost:{food:50,iron:20,gold:0,oil:0,power:0}},
  {name:"Havan", code:"MORTAR", icon:"ğŸ¯", cat:"ground", vs:["ground"], hp:140, spd:1.6, rng:6, dps:22, cost:{food:50,iron:30,gold:0,oil:0,power:0}},
  {name:"APC", code:"APC", icon:"ğŸšš", cat:"ground", vs:["ground"], hp:280, spd:3.1, rng:3, dps:16, cost:{food:30,iron:80,gold:10,oil:20,power:0}},
  {name:"IFV", code:"IFV", icon:"ğŸš™", cat:"ground", vs:["ground","air"], hp:320, spd:2.8, rng:4, dps:22, cost:{food:40,iron:100,gold:20,oil:30,power:0}},
  {name:"Ana Muharebe TankÄ±", code:"MBT", icon:"ğŸ›¡ï¸", cat:"ground", vs:["ground"], hp:560, spd:2.4, rng:5, dps:35, cost:{food:50,iron:160,gold:80,oil:60,power:0}},
  {name:"KundaÄŸÄ± Motorlu ObÃ¼s", code:"SPG", icon:"ğŸ§¨", cat:"ground", vs:["ground"], hp:420, spd:2.2, rng:8, dps:40, cost:{food:60,iron:140,gold:80,oil:50,power:0}},
  {name:"Ã‡NRS", code:"MLRS", icon:"ğŸš€", cat:"ground", vs:["ground"], hp:400, spd:2.0, rng:9, dps:50, cost:{food:60,iron:140,gold:120,oil:60,power:0}},
  {name:"ATGM", code:"ATGM", icon:"ğŸ¯", cat:"ground", vs:["ground"], hp:160, spd:1.6, rng:6, dps:32, cost:{food:40,iron:60,gold:40,oil:0,power:0}},
  {name:"UÃ§aksavar", code:"AAA", icon:"ğŸ›°ï¸", cat:"ground", vs:["air"], hp:280, spd:1.6, rng:5, dps:34, cost:{food:30,iron:80,gold:40,oil:0,power:10}},
  {name:"SAM", code:"SAM", icon:"ğŸ¯", cat:"ground", vs:["air"], hp:380, spd:1.6, rng:8, dps:45, cost:{food:40,iron:120,gold:80,oil:30,power:20}},
  {name:"Taarruz Helikopteri", code:"HELI", icon:"ğŸš", cat:"air", vs:["ground"], hp:360, spd:4.0, rng:5, dps:38, cost:{food:60,iron:100,gold:120,oil:80,power:30}},
  {name:"AvcÄ± UÃ§ak", code:"FTR", icon:"âœˆï¸", cat:"air", vs:["air"], hp:340, spd:4.6, rng:6, dps:44, cost:{food:60,iron:120,gold:160,oil:100,power:40}},
  {name:"BombardÄ±man", code:"BMB", icon:"ğŸ’£", cat:"air", vs:["ground"], hp:500, spd:4.0, rng:7, dps:55, cost:{food:80,iron:160,gold:200,oil:140,power:60}},
  {name:"KeÅŸif SÄ°HA", code:"UAV", icon:"ğŸ›©ï¸", cat:"air", vs:[], hp:130, spd:3.8, rng:0, dps:0, cost:{food:20,iron:20,gold:60,oil:20,power:10}},
  {name:"SilahlÄ± SÄ°HA", code:"UCAV", icon:"ğŸ›©ï¸", cat:"air", vs:["ground"], hp:240, spd:3.6, rng:6, dps:32, cost:{food:30,iron:60,gold:100,oil:40,power:20}},
  {name:"Hafif ZÄ±rhlÄ±", code:"LAV", icon:"ğŸš™", cat:"ground", vs:["ground"], hp:240, spd:3.4, rng:3, dps:18, cost:{food:30,iron:80,gold:20,oil:20,power:0}}
];
const UNIT_BY_CODE = Object.fromEntries(UNITS.map(u=>[u.code,u]));

/* =======================
   Global Durum
======================= */
let me = {uid:null,name:'',flag:'',roomId:null,isHost:false};
let roomRef=null, metaRef=null, mapRef=null, unitsRef=null, buildingsRef=null, playersRef=null, cmdRef=null;

const canvas = $('#world');
const ctx = canvas.getContext('2d');
const overlay = $('#overlay');
const mmin = $('#minimap');
const mctx = mmin.getContext('2d');
const tooltip = $('#tooltip');

let DPR = window.devicePixelRatio||1;
function resize(){
  const rect = $('#board').getBoundingClientRect();
  canvas.style.width = rect.width+'px';
  canvas.style.height= rect.height+'px';
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height= Math.floor(rect.height* DPR);
}
window.addEventListener('resize', resize);
resize();

let game = {
  map: [],
  players:{},
  units:{},
  buildings:{},
  resources:{},
  cam:{x:0,y:0,zoom:1},
  mySelection:null,
  _incomeAcc:0,
  hostHeartbeat:0
};

/* =======================
   Harita Ãœretimi (doku + kÄ±yÄ±)
======================= */
function roomSeed(roomId){ let h=0; for(const c of roomId) h=(h*31 + c.charCodeAt(0))>>>0; return h; }
function seededRandom(seed){ return function(){ let t= seed+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^= t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function genMap(roomId){
  const rnd = seededRandom(roomSeed(roomId));
  const map=[];
  const seaBand = Math.floor(GRID*(0.35 + rnd()*0.15));
  for(let y=0;y<GRID;y++){
    map[y]=[];
    for(let x=0;x<GRID;x++){
      let t='land';
      if (y>=seaBand-2 && y<=seaBand+1) t='water';
      if (t==='land' && rnd()<0.16) t='desert';
      map[y][x]={t, bridge:false, builds:0};
    }
  }
  // kÃ¶prÃ¼ koridorlarÄ±
  for(let x=2;x<GRID-2;x+=4){
    const by = seaBand + ((x%8===0)?0:1);
    if(map[by] && map[by][x]) { map[by][x].bridge=true; map[by][x].t='water'; }
  }
  return map;
}
function cellTerrainStr(c){ return c.bridge ? 'bridge' : c.t; }

/* =======================
   Firebase Oda
======================= */
function roomRefs(roomId){
  roomRef = db.ref('rooms/'+roomId);
  metaRef = roomRef.child('meta');
  mapRef  = roomRef.child('map');
  unitsRef= roomRef.child('units');
  buildingsRef=roomRef.child('buildings');
  playersRef= roomRef.child('players');
  cmdRef = roomRef.child('commands');
}
async function signInAnon(){
  if(auth.currentUser) return auth.currentUser;
  try{
    const cred = await auth.signInAnonymously();
    me.uid = cred.user.uid;
    return cred.user;
  }catch(e){ toast('Auth hata: '+e.message,'error'); throw e; }
}

/* =======================
   Ekonomi ve Maliyetler
======================= */
function resStr(cost){ return `ğŸ${cost.food||0} â›ï¸${cost.iron||0} ğŸª™${cost.gold||0} ğŸ›¢ï¸${cost.oil||0} âš¡${cost.power||0}`; }
function pay(cost, uid=me.uid){
  const r = game.resources[uid];
  for(const k of RES){ if((cost[k]||0) > (r[k]||0)) return false; }
  for(const k of RES){ r[k] -= (cost[k]||0); }
  playersRef.child(uid).child('res').set(r);
  return true;
}

/* =======================
   Ä°nÅŸa & Birim Ãœretimi
======================= */
function canPlace(buildCode, tx, ty){
  const b = BUILDINGS.find(b=>b.code===buildCode);
  const cell = game.map?.[ty]?.[tx];
  if(!b || !cell) return false;
  if(cell.builds >= MAX_BUILD_PER_CELL) return false;
  const terr = cellTerrainStr(cell);
  if(b.place.includes('|')){
    if(!b.place.split('|').includes(terr)) return false;
  }else{
    if(b.place==='land' && terr==='water') return false;
    if(b.place==='water' && terr!=='water') return false;
  }
  return true;
}
function spawnBuilding(uid, code, x,y){
  const id='B_'+randId();
  const def = BUILDINGS.find(b=>b.code===code);
  const obj={id, owner:uid, code, x, y, hp:def.hp, t:now()};
  game.map[y][x].builds++;
  buildingsRef.child(id).set(obj);
  return id;
}
function spawnUnit(uid, code, x,y){
  const id='U_'+randId();
  const def=UNIT_BY_CODE[code];
  const obj={id, owner:uid, code, x, y, fx:x, fy:y, hp:def.hp, t:now(), tgt:null, order:null, cd:0};
  unitsRef.child(id).set(obj);
  return id;
}

/* =======================
   Komutlar (Host iÅŸler)
======================= */
async function pushCommand(cmd){
  const ref = cmdRef.child(me.uid).push();
  await ref.set({...cmd, ts:firebase.database.ServerValue.TIMESTAMP});
}
function findFreeAround(x,y){
  const dirs=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[-1,1],[1,-1],[-1,-1]];
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(nx<0||ny<0||nx>=GRID||ny>=GRID) continue;
    const terr = game.map[ny][nx];
    const block = Object.values(game.buildings).some(b=>b.x===nx && b.y===ny && BUILDINGS.find(bb=>bb.code===b.code).blocks);
    const occ   = Object.values(game.units).some(u=>u.x===nx && u.y===ny);
    if(!block && !occ && terr.t!=='water') return {x:nx,y:ny};
  }
  return null;
}
function tryPayServer(uid, cost){
  const r = game.resources[uid]; if(!r) return false;
  for(const k of RES){ if((cost[k]||0) > (r[k]||0)) return false; }
  const nr = {...r}; for(const k of RES){ nr[k]-=(cost[k]||0) }
  playersRef.child(uid).child('res').set(nr);
  return true;
}
async function hostLoop(){
  await metaRef.child('hostHeartbeat').set(now());

  const snap = await cmdRef.get();
  const cmds=[];
  snap.forEach(u=>u.forEach(c=>cmds.push({...c.val(), _path:c.ref})));

  for(const c of cmds){
    if(c.type==='build'){
      const {uid, code, x,y}=c;
      const def = BUILDINGS.find(b=>b.code===code);
      if(!canPlace(code,x,y) || !tryPayServer(uid, def.cost)){ await c._path.remove(); continue; }
      spawnBuilding(uid, code, x,y);
    }
    if(c.type==='train'){
      const {uid, code, nearX, nearY}=c;
      const def=UNIT_BY_CODE[code];
      if(!tryPayServer(uid, def.cost)){ await c._path.remove(); continue; }
      const pos = findFreeAround(nearX,nearY);
      if(pos) spawnUnit(uid, code, pos.x, pos.y);
    }
    if(c.type==='order'){
      const {uid, unitId, order}=c;
      const u = game.units[unitId];
      if(u && u.owner===uid) unitsRef.child(unitId).child('order').set(order||null);
    }
    await c._path.remove();
  }

  // Gelir (her saniye)
  game._incomeAcc += TICK_MS;
  if(game._incomeAcc>=1000){
    game._incomeAcc=0;
    const byOwner={};
    Object.values(game.buildings).forEach(b=>{
      const def=BUILDINGS.find(x=>x.code===b.code);
      if(def.income){
        byOwner[b.owner]=byOwner[b.owner]||{food:0,iron:0,gold:0,oil:0,power:0};
        for(const k of RES) byOwner[b.owner][k]+= (def.income[k]||0)/60;
      }
    });
    for(const uid of Object.keys(byOwner)){
      const r=(game.resources[uid]||{});
      for(const k of RES){ r[k]=(r[k]||0)+byOwner[uid][k]; }
      for(const k of RES){ r[k]=Math.max(0, Math.round(r[k]*10)/10); }
      playersRef.child(uid).child('res').set(r);
    }
  }

  simStep();
}

/* =======================
   Yol Bulma & SavaÅŸ
======================= */
function passable(x,y, cat){
  if(x<0||y<0||x>=GRID||y>=GRID) return false;
  const cell = game.map[y][x];
  if(cat==='air') return true;
  if(cell.t==='water' && !cell.bridge) return false;
  const wallHere = Object.values(game.buildings).some(b=>b.x===x && b.y===y && BUILDINGS.find(bb=>bb.code===b.code).blocks);
  return !wallHere;
}
function astar(start, goal, cat){
  const open=[{...start}];
  const g=new Map(), f=new Map(), came=new Map();
  const key=p=>p.x+','+p.y;
  const H=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.y-b.y);
  g.set(key(start),0); f.set(key(start),H(start,goal));
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
  while(open.length){
    open.sort((a,b)=> (f.get(key(a))??1e9) - (f.get(key(b))??1e9));
    const cur=open.shift();
    if(cur.x===goal.x && cur.y===goal.y){
      const path=[]; let ck=key(cur), node=cur;
      while(came.has(ck)){ path.unshift({x:node.x,y:node.y}); node=came.get(ck); ck=key(node); }
      return path;
    }
    for(const [dx,dy] of dirs){
      const nx=cur.x+dx, ny=cur.y+dy;
      if(!passable(nx,ny,cat)) continue;
      const nk=nx+','+ny, ng=(g.get(key(cur))??1e9)+1;
      if(ng < (g.get(nk)??1e9)){
        came.set(nk,cur); g.set(nk,ng); f.set(nk, ng+H({x:nx,y:ny},goal));
        if(!open.find(o=>o.x===nx&&o.y===ny)) open.push({x:nx,y:ny});
      }
    }
  }
  return [];
}
function dTiles(a,b){ return Math.hypot((a.fx??a.x)-(b.fx??b.x), (a.fy??a.y)-(b.fy??b.y)); }
function beamEffect(u, v){
  const a = toScreen((u.fx??u.x)+.5,(u.fy??u.y)+.5);
  const b = toScreen((v.fx??v.x)+.5,(v.fy??v.y)+.5);
  const dx=b.x-a.x, dy=b.y-a.y, len=Math.hypot(dx,dy), ang=Math.atan2(dy,dx);
  const el=document.createElement('div');
  el.className='beam';
  el.style.left=a.x+'px'; el.style.top=a.y+'px';
  el.style.width=len+'px'; el.style.transform=`rotate(${ang}rad)`;
  overlay.appendChild(el); setTimeout(()=>el.remove(), 180);
}
function inRange(u, v){
  const du = UNIT_BY_CODE[u.code]; const rng = du.rng;
  return dTiles(u,v) <= rng + 0.05;
}
function stepMove(u){
  if(!u.order || u.order.type!=='move') return;
  const def=UNIT_BY_CODE[u.code];
  if(!u._path || !u._path.length) u._path = astar({x:u.x,y:u.y},{x:u.order.x,y:u.order.y}, def.cat);
  if(!u._path || !u._path.length) return;
  const next = u._path[0];
  const step = def.spd * (TICK_MS/1000);
  if(u.fx===undefined){ u.fx=u.x; u.fy=u.y; }
  const dx = Math.sign(next.x - u.x), dy = Math.sign(next.y - u.y);
  let vdx=dx*step, vdy=dy*step;
  if(Math.abs((u.fx+vdx)-next.x) < step) u.fx=next.x; else u.fx += vdx;
  if(Math.abs((u.fy+vdy)-next.y) < step) u.fy=next.y; else u.fy += vdy;
  if(Math.abs(u.fx-next.x)<0.01 && Math.abs(u.fy-next.y)<0.01){
    u.x = next.x; u.y = next.y; u.fx=u.x; u.fy=u.y; u._path.shift();
  } else {
    unitsRef.child(u.id).update({fx:u.fx, fy:u.fy});
  }
}
function stepCombat(u){
  const def = UNIT_BY_CODE[u.code]; if(!def) return;
  let t=null;
  if(u.tgt){ const v=game.units[u.tgt]; if(v && v.owner!==u.owner) t=v; else u.tgt=null; }
  if(!t){
    let best=null, bd=1e9;
    for(const v of Object.values(game.units)){
      if(v.owner===u.owner) continue;
      const dv = UNIT_BY_CODE[v.code]; const targetCat = dv.cat;
      if(def.vs.length && !def.vs.includes(targetCat)) continue;
      const d = dTiles(u,v); if(d<bd){ bd=d; best=v; }
    }
    if(best && inRange(u,best)) t=best, u.tgt=best.id;
  }
  if(t && inRange(u,t)){
    if(u.cd>0){ u.cd-=TICK_MS; if(u.cd<0) u.cd=0; return; }
    const dmg = def.dps * (TICK_MS/1000);
    const newHp = (t.hp || UNIT_BY_CODE[t.code].hp) - dmg;
    beamEffect(u,t);
    if(newHp<=0){ unitsRef.child(t.id).remove(); u.tgt=null; }
    else { unitsRef.child(t.id).child('hp').set(Math.round(newHp)); }
    u.cd = 800;
  }
}
function simStep(){
  const units = Object.values(game.units);
  for(const u of units){
    stepMove(u);
    stepCombat(u);
    unitsRef.child(u.id).update({x:u.x,y:u.y, fx:u.fx??u.x, fy:u.fy??u.y, tgt:u.tgt??null, cd:u.cd});
  }
}

/* =======================
   Ã‡izim â€” Estetik Harita & Semboller
======================= */
let hoverCell=null, buildGhost=null;
overlay.addEventListener('mousemove', e=>{
  const p = screenToWorld(e);
  hoverCell = {x:clamp(p.tx,0,GRID-1), y:clamp(p.ty,0,GRID-1)};
  if(buildMode.code) buildGhost = {code:buildMode.code, x:hoverCell.x, y:hoverCell.y, ok: canPlace(buildMode.code, hoverCell.x, hoverCell.y)};
  else buildGhost=null;
  // tooltip
  showTipForCell(hoverCell.x, hoverCell.y, e.clientX, e.clientY);
});
overlay.addEventListener('mouseleave', ()=>{ hoverCell=null; tooltip.classList.add('hidden'); });

function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

function draw(){
  const W = canvas.width, H=canvas.height;
  ctx.save();
  ctx.scale(DPR,DPR); // HiDPI
  ctx.clearRect(0,0,W/DPR,H/DPR);

  // Kamera Ã§evirisi
  ctx.translate(-game.cam.x, -game.cam.y);
  ctx.scale(game.cam.zoom, game.cam.zoom);

  // Zemin dokularÄ±
  for(let y=0;y<GRID;y++){
    for(let x=0;x<GRID;x++){
      const c = game.map[y][x];
      const px=x*CELL, py=y*CELL;
      // temel renk
      let base=(c.t==='land')? 'var(--land)' : (c.t==='desert'?'var(--desert)':'var(--water)');
      let alt =(c.t==='land')? 'var(--land2)': (c.t==='desert'?'var(--desert2)':'var(--water2)');
      // checker doku
      ctx.fillStyle = base; ctx.fillRect(px,py,CELL,CELL);
      ctx.fillStyle = alt; ctx.globalAlpha=0.25;
      ctx.fillRect(px,py,CELL*0.5,CELL*0.5);
      ctx.fillRect(px+CELL*0.5,py+CELL*0.5,CELL*0.5,CELL*0.5);
      ctx.globalAlpha=1;
      // su dalga Ã§izgileri
      if(c.t==='water'){
        ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(px+6,py+CELL*0.7); ctx.quadraticCurveTo(px+CELL*0.4,py+CELL*0.6, px+CELL-6, py+CELL*0.75); ctx.stroke();
      }
      // kÃ¶prÃ¼
      if(c.bridge){
        ctx.fillStyle='var(--bridge)';
        ctx.fillRect(px, py+CELL*0.42, CELL, CELL*0.16);
        ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(px,py+CELL*0.42); ctx.lineTo(px+CELL,py+CELL*0.42); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(px,py+CELL*0.58); ctx.lineTo(px+CELL,py+CELL*0.58); ctx.stroke();
      }
      // kÄ±yÄ± vurgusu
      if(c.t==='water'){
        ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.lineWidth=2;
        if(y>0 && game.map[y-1][x].t!=='water'){ ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px+CELL,py); ctx.stroke(); }
        if(y<GRID-1 && game.map[y+1][x].t!=='water'){ ctx.beginPath(); ctx.moveTo(px,py+CELL); ctx.lineTo(px+CELL,py+CELL); ctx.stroke(); }
        if(x>0 && game.map[y][x-1].t!=='water'){ ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px,py+CELL); ctx.stroke(); }
        if(x<GRID-1 && game.map[y][x+1].t!=='water'){ ctx.beginPath(); ctx.moveTo(px+CELL,py); ctx.lineTo(px+CELL,py+CELL); ctx.stroke(); }
      }
      // grid Ã§izgisi (hafif)
      ctx.strokeStyle='rgba(255,255,255,0.04)'; ctx.strokeRect(px,py,CELL,CELL);
    }
  }

  // Binalar: ikonlu kutular
  for(const b of Object.values(game.buildings)){
    const def = BUILDINGS.find(x=>x.code===b.code);
    const x=b.x*CELL, y=b.y*CELL;
    // gÃ¶lge
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(x+4, y+6, CELL-8, CELL-10);
    // ana blok
    ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(x+4, y+4, CELL-8, CELL-10);
    // Ã¼st ÅŸerit
    ctx.fillStyle=def.tint; ctx.globalAlpha=0.25; ctx.fillRect(x+4, y+4, CELL-8, 10); ctx.globalAlpha=1;
    // ikon
    ctx.font='600 16px Montserrat'; ctx.fillStyle='#e2e8f0';
    ctx.fillText(def.icon, x+8, y+20);
    ctx.font='700 11px Montserrat'; ctx.fillStyle='#cbd5e1';
    ctx.fillText(def.code, x+28, y+20);
    // HP bar
    ctx.fillStyle='#0b1220'; ctx.fillRect(x+6, y+CELL-12, CELL-12, 7);
    ctx.fillStyle='#10b981'; const pw = Math.max(0, (b.hp/def.hp)*(CELL-12)); ctx.fillRect(x+6, y+CELL-12, pw, 7);
  }

  // Birimler: sembol + daire
  for(const u of Object.values(game.units)){
    const def = UNIT_BY_CODE[u.code];
    const cx = (u.fx??u.x)*CELL + CELL/2;
    const cy = (u.fy??u.y)*CELL + CELL/2;
    // gÃ¶lge
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.beginPath(); ctx.arc(cx+2, cy+3, 9, 0, Math.PI*2); ctx.fill();
    // gÃ¶vde
    ctx.fillStyle = (def.cat==='air')? '#c084fc' : '#7dd3fc';
    ctx.beginPath(); ctx.arc(cx, cy, 9, 0, Math.PI*2); ctx.fill();
    // ikon
    ctx.font='700 12px Montserrat'; ctx.fillStyle='#0b1220'; ctx.fillText(def.icon, cx-7, cy+5);
    // seÃ§ili menzil
    if(game.mySelection===u.id){
      ctx.save();
      ctx.strokeStyle='rgba(96,165,250,0.55)'; ctx.setLineDash([6,6]); ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(cx, cy, def.rng*CELL, 0, Math.PI*2); ctx.stroke();
      ctx.restore();
    }
    // HP Ã§ubuÄŸu
    ctx.fillStyle='#0b1220'; ctx.fillRect(cx-14, cy+12, 28, 5);
    ctx.fillStyle='#10b981'; ctx.fillRect(cx-14, cy+12, Math.max(0,28*(u.hp/def.hp)), 5);
  }

  // Ä°nÅŸa gÃ¶lgesi
  if(buildGhost){
    const gx=buildGhost.x*CELL, gy=buildGhost.y*CELL;
    ctx.fillStyle = buildGhost.ok ? 'rgba(34,197,94,.25)' : 'rgba(239,68,68,.25)';
    ctx.fillRect(gx,gy,CELL,CELL);
    ctx.strokeStyle = buildGhost.ok ? 'rgba(34,197,94,.8)' : 'rgba(239,68,68,.8)';
    ctx.lineWidth=2; ctx.strokeRect(gx+2,gy+2,CELL-4,CELL-4);
  }

  ctx.restore();
  drawMinimap();
  requestAnimationFrame(draw);
}

function drawMinimap(){
  const s = mmin.width / GRID;
  mctx.clearRect(0,0,mmin.width,mmin.height);
  for(let y=0;y<GRID;y++){
    for(let x=0;x<GRID;x++){
      const c=game.map[y][x];
      mctx.fillStyle = (c.t==='land')? '#1e6143' : (c.t==='desert'?'#a08f4c':'#193a5c');
      mctx.fillRect(x*s,y*s,s,s);
      if(c.bridge){ mctx.fillStyle='#9aa6b2'; mctx.fillRect(x*s,y*s+s*0.45,s,s*0.1); }
    }
  }
  for(const u of Object.values(game.units)){
    mctx.fillStyle = (u.owner===me.uid)? '#60a5fa' : '#f472b6';
    mctx.fillRect(u.x*s+1, u.y*s+1, s-2, s-2);
  }
  // kamera
  const sx = (game.cam.x/WORLD_W)*mmin.width;
  const sy = (game.cam.y/WORLD_H)*mmin.height;
  const sw = (widthOnScreen()/WORLD_W)*mmin.width;
  const sh = (heightOnScreen()/WORLD_H)*mmin.height;
  mctx.strokeStyle='#e2e8f0'; mctx.strokeRect(sx,sy,sw,sh);
}

/* =======================
   Ekran â†”ï¸ DÃ¼nya DÃ¶nÃ¼ÅŸÃ¼mÃ¼ & Kamera
======================= */
let isPanning=false, panStart=null;
overlay.addEventListener('mousedown', e=>{
  if(e.button===1){ isPanning=true; panStart={x:e.clientX,y:e.clientY, cx:game.cam.x, cy:game.cam.y}; }
});
overlay.addEventListener('mousemove', e=>{
  if(isPanning){
    const dx=e.clientX-panStart.x, dy=e.clientY-panStart.y;
    game.cam.x = clamp(panStart.cx - dx/game.cam.zoom, 0, WORLD_W - widthOnScreen());
    game.cam.y = clamp(panStart.cy - dy/game.cam.zoom, 0, WORLD_H - heightOnScreen());
  }
});
overlay.addEventListener('mouseup', ()=>{ isPanning=false; });
overlay.addEventListener('mouseleave', ()=>{ isPanning=false; });
overlay.addEventListener('wheel', e=>{
  const before = screenToWorld(e);
  const z = game.cam.zoom * (e.deltaY>0 ? 0.9 : 1.1);
  game.cam.zoom = Math.max(.6, Math.min(2.4, z));
  const after = screenToWorld(e);
  // zoom pivot dÃ¼zeltmesi
  game.cam.x += (before.wx - after.wx);
  game.cam.y += (before.wy - after.wy);
  e.preventDefault();
},{passive:false});

overlay.addEventListener('contextmenu', e=>e.preventDefault());

function widthOnScreen(){ return (canvas.width/DPR) / game.cam.zoom; }
function heightOnScreen(){ return (canvas.height/DPR) / game.cam.zoom; }

function screenToWorld(e){
  const rect = canvas.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const wx = (sx / (canvas.width/DPR)) * widthOnScreen() + game.cam.x;
  const wy = (sy / (canvas.height/DPR)) * heightOnScreen() + game.cam.y;
  return {wx, wy, tx:Math.floor(wx/CELL), ty:Math.floor(wy/CELL)};
}
function toScreen(cx,cy){
  const x = (cx*CELL - game.cam.x) * game.cam.zoom;
  const y = (cy*CELL - game.cam.y) * game.cam.zoom;
  return {x, y};
}

/* =======================
   SeÃ§im & Komut & Tooltip
======================= */
const buildMode = {code:null};
const trainMode = {code:null};

overlay.addEventListener('mousedown', async (e)=>{
  const p = screenToWorld(e);
  if(e.button===0){
    // SOL: seÃ§im
    let sel=null;
    for(const u of Object.values(game.units)){
      if(u.owner!==me.uid) continue;
      const cx=(u.fx??u.x)*CELL + CELL/2, cy=(u.fy??u.y)*CELL + CELL/2;
      const sx=(p.wx - (u.fx??u.x)*CELL - CELL/2), sy=(p.wy - (u.fy??u.y)*CELL - CELL/2);
      if(Math.hypot(sx,sy)<12){ sel=u.id; break; }
    }
    game.mySelection = sel;
  }
  if(e.button===2){
    // SAÄ: komut
    const tx=p.tx, ty=p.ty;
    if(buildMode.code){
      await pushCommand({type:'build', uid:me.uid, code:buildMode.code, x:tx, y:ty});
      buildMode.code=null; $('#buildPanel').classList.add('hidden'); return;
    }
    if(trainMode.code){
      await pushCommand({type:'train', uid:me.uid, code:trainMode.code, nearX:tx, nearY:ty});
      trainMode.code=null; $('#trainPanel').classList.add('hidden'); return;
    }
    if(game.mySelection){
      // hedef hÃ¼crede dÃ¼ÅŸman var mÄ±?
      const target = Object.values(game.units).find(u=>u.x===tx && u.y===ty && u.owner!==me.uid);
      const order = target ? {type:'attack', id:target.id} : {type:'move', x:tx, y:ty};
      await pushCommand({type:'order', uid:me.uid, unitId:game.mySelection, order});
    }
  }
});

function showTipForCell(x,y, clientX, clientY){
  const bHere = Object.values(game.buildings).filter(b=>b.x===x && b.y===y);
  const uHere = Object.values(game.units).filter(u=>Math.round(u.x)===x && Math.round(u.y)===y);
  if(bHere.length===0 && uHere.length===0){ tooltip.classList.add('hidden'); return; }
  let html='';
  for(const b of bHere){
    const def=BUILDINGS.find(bb=>bb.code===b.code);
    const owner = game.players[b.owner]?.name || '??';
    html += `<div><b>${def.icon} ${def.name}</b> <span class="opacity-70">(${def.code})</span> â€” ${Math.round(b.hp)}/${def.hp} HP</div>`;
    html += `<div class="opacity-70 text-[11px]">Sahip: ${owner}</div>`;
  }
  for(const u of uHere){
    const def=UNIT_BY_CODE[u.code];
    const owner = game.players[u.owner]?.name || '??';
    html += `<div><b>${def.icon} ${def.name}</b> <span class="opacity-70">(${def.code})</span> â€” ${Math.round(u.hp)}/${def.hp} HP</div>`;
    html += `<div class="opacity-70 text-[11px]">Sahip: ${owner}</div>`;
  }
  tooltip.innerHTML = html;
  tooltip.style.left = (clientX+14)+'px';
  tooltip.style.top  = (clientY+14)+'px';
  tooltip.classList.remove('hidden');
}

/* =======================
   UI Panelleri
======================= */
function renderBuildPanel(){
  const list=$('#buildList'); list.innerHTML='';
  for(const b of BUILDINGS){
    if(b.code==='HQ') continue;
    const item=document.createElement('button');
    item.className='btn-ghost rounded p-2 text-left hover:ring-2 ring-sky-500';
    item.innerHTML = `<div class="font-semibold">${b.icon} ${b.name}</div>
      <div class="flex justify-between text-xs opacity-80"><span>${b.code}</span><span>${resStr(b.cost)}</span></div>`;
    item.onmouseenter=()=>toast(`${b.name}: ${resStr(b.cost)}`);
    item.onclick=()=>{ buildMode.code=b.code; toast(`${b.name} seÃ§ildi. Haritada saÄŸ tÄ±kla.`); };
    list.appendChild(item);
  }
}
function renderUnitPanel(){
  const list=$('#unitList'); list.innerHTML='';
  for(const u of UNITS){
    const item=document.createElement('button');
    item.className='btn-ghost rounded p-2 text-left hover:ring-2 ring-sky-500';
    item.innerHTML = `<div class="font-semibold">${u.icon} ${u.name}</div>
      <div class="flex justify-between"><span class="opacity-80">${u.code} â€¢ ${u.cat==='air'?'Hava':'Kara'}</span><span class="text-xs">${resStr(u.cost)}</span></div>
      <div class="text-xs opacity-80">HP:${u.hp} RNG:${u.rng} SPD:${u.spd} DPS:${u.dps}</div>`;
    item.onclick=()=>{ trainMode.code=u.code; toast(`${u.name} Ã¼retimi aktif. SaÄŸ tÄ±kla yer seÃ§.`); };
    list.appendChild(item);
  }
}
$('#openBuild').onclick=()=>{ renderBuildPanel(); $('#buildPanel').classList.toggle('hidden'); $('#trainPanel').classList.add('hidden'); };
$('#openTrain').onclick=()=>{ renderUnitPanel(); $('#trainPanel').classList.toggle('hidden'); $('#buildPanel').classList.add('hidden'); };
$('#centerBase').onclick=()=>{ const myHQ=Object.values(game.buildings).find(b=>b.owner===me.uid && b.code==='HQ'); if(myHQ) centerOn(myHQ.x,myHQ.y); };
document.addEventListener('keydown', e=>{ if(e.key==='b'||e.key==='B') $('#openBuild').click(); if(e.key==='u'||e.key==='U') $('#openTrain').click(); });

function centerOn(x,y){
  const cx = x*CELL - (widthOnScreen()/2) + CELL/2;
  const cy = y*CELL - (heightOnScreen()/2) + CELL/2;
  game.cam.x = clamp(cx, 0, WORLD_W - widthOnScreen());
  game.cam.y = clamp(cy, 0, WORLD_H - heightOnScreen());
}

/* =======================
   Odaya KatÄ±lÄ±m
======================= */
async function joinRoom(roomId){
  me.roomId=roomId; roomRefs(roomId);

  // Harita yaz/oku
  const ms = await mapRef.get();
  if(!ms.exists()){ await mapRef.set(genMap(roomId)); }
  game.map = (await mapRef.get()).val();

  // Oyuncu kaydÄ±
  const pInfo = {name:me.name, flag:me.flag, joinedAt:firebase.database.ServerValue.TIMESTAMP, res:{food:300,iron:220,gold:220,oil:130,power:70}};
  await playersRef.child(me.uid).set(pInfo);
  playersRef.child(me.uid).onDisconnect().remove();

  // Host atamasÄ±
  await metaRef.child('hostUid').transaction(cur=>cur||me.uid);
  metaRef.on('value', s=>{
    const v=s.val()||{}; me.isHost = (v.hostUid===me.uid); game.hostHeartbeat=v.hostHeartbeat||0;
    $('#hostBadge').classList.toggle('hidden', !me.isHost);
  });
  setInterval(async ()=>{
    if(me.isHost) return;
    const v=(await metaRef.get()).val()||{};
    if(now() - (v.hostHeartbeat||0) > 5000){
      await metaRef.child('hostUid').transaction(cur=>cur||me.uid);
    }
  }, 3000);

  // Dinleyiciler
  mapRef.on('value', s=> game.map = s.val()||game.map);
  buildingsRef.on('value', s=> game.buildings = s.val()||{});
  unitsRef.on('value', s=> game.units = s.val()||{});
  playersRef.on('value', s=>{
    const v=s.val()||{};
    game.players=v;
    game.resources = Object.fromEntries(Object.entries(v).map(([k,o])=>[k,o.res||{food:0,iron:0,gold:0,oil:0,power:0}]));
    updateHUD();
  });

  // BaÅŸlangÄ±Ã§ Ã¼ssÃ¼ (yoksa komutla kurdur)
  setTimeout(async ()=>{
    const haveMyHQ = Object.values(game.buildings).some(b=>b.owner===me.uid && b.code==='HQ');
    if(!haveMyHQ){
      const order = Object.keys(game.players).sort();
      const idx = order.indexOf(me.uid);
      const baseX = (idx%2===0) ? 2 : GRID-3;
      const baseY = 2 + (idx*3 % (GRID-4));
      await pushCommand({type:'build', uid:me.uid, code:'HQ', x:baseX, y:baseY});
      setTimeout(async ()=>{
        await pushCommand({type:'train', uid:me.uid, code:'INF', nearX:baseX, nearY:baseY});
        await pushCommand({type:'train', uid:me.uid, code:'IFV', nearX:baseX, nearY:baseY});
      }, 300);
      centerOn(baseX, baseY);
    }
  }, 400);

  // Ã‡izim & Host dÃ¶ngÃ¼sÃ¼
  fitInitialZoom();
  requestAnimationFrame(draw);
  setInterval(()=>{ if(me.isHost) hostLoop(); }, TICK_MS);

  $('#roomLabel').innerText = 'Oda: '+roomId;
  toast('Odaya baÄŸlandÄ±: '+roomId);
}
function updateHUD(){
  const r=game.resources[me.uid]||{food:0,iron:0,gold:0,oil:0,power:0};
  $('#resFood').innerText=Math.floor(r.food);
  $('#resIron').innerText=Math.floor(r.iron);
  $('#resGold').innerText=Math.floor(r.gold);
  $('#resOil').innerText=Math.floor(r.oil);
  $('#resPower').innerText=Math.floor(r.power);
}

function fitInitialZoom(){
  // Harita ekranÄ± bÃ¼yÃ¼k kaplasÄ±n: tÃ¼m geniÅŸliÄŸi yaklaÅŸtÄ±r, biraz kenar bÄ±rak
  const vw = canvas.width/DPR, vh=canvas.height/DPR;
  const zX = vw / (WORLD_W*0.9);
  const zY = vh / (WORLD_H*0.9);
  game.cam.zoom = Math.max(.9, Math.min(1.8, Math.min(zX,zY)));
  game.cam.x = (WORLD_W - widthOnScreen())/2;
  game.cam.y = (WORLD_H - heightOnScreen())/2;
}

/* =======================
   Modal
======================= */
function countryFlagValue(sel){ return sel.split(' ')[0]; }
$('#btnCreate').onclick = async ()=>{
  const name = $('#playerName').value.trim() || 'Komutan';
  const flag = countryFlagValue($('#playerFlag').value || 'ğŸ‡¹ğŸ‡· TÃ¼rkiye');
  let rid = $('#roomIdInput').value.trim(); if(!rid) rid = ('DESERT-'+randId());
  me.name=name; me.flag=flag;
  $('#modal').classList.add('hidden');
  try{ await signInAnon(); await joinRoom(rid); }
  catch(e){ $('#modal').classList.remove('hidden'); toast('OluÅŸturma hatasÄ±: '+e.message,'error'); }
};
$('#btnJoin').onclick = async ()=>{
  const name = $('#playerName').value.trim() || 'Komutan';
  const flag = countryFlagValue($('#playerFlag').value || 'ğŸ‡¹ğŸ‡· TÃ¼rkiye');
  let rid = $('#roomIdInput').value.trim();
  if(!rid){ toast('LÃ¼tfen Oda ID girin','error'); return; }
  me.name=name; me.flag=flag;
  $('#modal').classList.add('hidden');
  try{ await signInAnon(); await joinRoom(rid); }
  catch(e){ $('#modal').classList.remove('hidden'); toast('KatÄ±lma hatasÄ±: '+e.message,'error'); }
};

/* =======================
   BaÅŸlat
======================= */
(function boot(){
  // geÃ§ici yerel harita (modal aÃ§Ä±kken Ã§iz)
  game.map = genMap('LOCAL');
  fitInitialZoom();
  requestAnimationFrame(draw);
  $('#status').innerHTML = `<div>Sol tÄ±k: seÃ§im â€¢ SaÄŸ tÄ±k: hareket/saldÄ±rÄ± â€¢ Orta tÄ±k+sÃ¼rÃ¼kle: kaydÄ±r â€¢ Teker: zoom</div>`;
})();
</script>
</body>
</html>
