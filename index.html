<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GLOBAL RTS â€” Online (20x20 Grid)</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase v10 compat (basit kullanÄ±m iÃ§in) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0a0f1a; --panel:#0f172a; --muted:#1e293b; --text:#e5ecf6;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa; --beam:#fb923c80;
    --land:#1b3b2b; --desert:#7c6a30; --water:#0d2a43; --bridge:#5b6470; --grid:#1b2540;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  #game{height:100%;display:grid;grid-template-rows:auto 1fr}
  /* Canvas alanÄ± */
  #board{position:relative; overflow:hidden; background:#0b1220}
  canvas{display:block; image-rendering:pixelated;}
  /* HÃ¼cre overlay tÄ±klama yakalayÄ±cÄ± (performans iÃ§in tek canvas kullanÄ±yoruz, ama UI iÃ§in pointer overlay) */
  #overlay{position:absolute; inset:0; cursor:default}
  /* UI bileÅŸenleri */
  .panel{background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(2,8,23,.9)); border:1px solid #233; box-shadow:0 8px 30px rgba(0,0,0,.25); backdrop-filter: blur(6px)}
  .chip{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}
  .btn{background:linear-gradient(180deg,#0ea5e9,#0369a1); border:1px solid #1e3a8a}
  .btn:disabled{opacity:.5}
  .btn-ghost{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1)}
  .ring-anim{animation:ringPulse 1.2s ease-out infinite}
  @keyframes ringPulse { 0%{box-shadow:0 0 0 0 rgba(96,165,250,.6)} 100%{box-shadow:0 0 0 16px rgba(96,165,250,0)} }
  /* Turuncu lazer Ã§izgisi */
  .beam{position:absolute; pointer-events:none; height:3px; background:linear-gradient(90deg,transparent,#fb923c,transparent); transform-origin:left center; filter: drop-shadow(0 0 6px #fb923c); opacity:.95}
  /* Minimap */
  #minimap{position:absolute; right:12px; bottom:12px; width:200px; height:200px; border:1px solid #334155; background:#0b1322; image-rendering:pixelated}
  /* Flag select gÃ¶rÃ¼nÃ¼mÃ¼ */
  select option{background:#0b1322; color:#e5ecf6}
</style>
</head>
<body>
<div id="game">
  <!-- TOP BAR -->
  <header class="panel px-4 py-2 flex items-center gap-3">
    <div class="flex items-center gap-2">
      <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-sky-400 to-indigo-600"></div>
      <div class="font-bold tracking-wide">GLOBAL RTS</div>
      <div id="roomLabel" class="text-xs opacity-80 ml-2"></div>
      <div id="hostBadge" class="ml-2 text-xs px-2 py-0.5 rounded chip hidden">HOST</div>
    </div>
    <div class="ml-auto flex items-center gap-2 text-sm">
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸ</span><span id="resFood">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>â›ï¸</span><span id="resIron">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸª™</span><span id="resGold">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>ğŸ›¢ï¸</span><span id="resOil">0</span></div>
      <div class="chip px-3 py-1.5 rounded flex items-center gap-2"><span>âš¡</span><span id="resPower">0</span></div>
      <button id="openBuild" class="btn-ghost px-3 py-1.5 rounded">Ä°nÅŸa Et (B)</button>
      <button id="openTrain" class="btn-ghost px-3 py-1.5 rounded">Birim Ãœret (U)</button>
      <button id="centerBase" class="btn-ghost px-3 py-1.5 rounded">ÃœssÃ¼ Ortala</button>
    </div>
  </header>

  <!-- BOARD -->
  <div id="board">
    <canvas id="world" width="1400" height="900"></canvas>
    <div id="overlay"></div>
    <canvas id="minimap" width="200" height="200"></canvas>
    <!-- Build Panel -->
    <div id="buildPanel" class="panel absolute left-3 top-16 w-80 rounded-xl p-3 hidden">
      <div class="font-semibold mb-2">Ä°nÅŸaat (HÃ¼cre baÅŸÄ±na max 2)</div>
      <div id="buildList" class="grid grid-cols-2 gap-2 text-sm"></div>
      <div class="mt-2 text-xs opacity-80">Deniz hÃ¼crelerine sadece kÃ¶prÃ¼, savunma vb. uygun yapÄ±lar kurulabilir.</div>
    </div>
    <!-- Train Panel -->
    <div id="trainPanel" class="panel absolute left-3 top-16 w-[26rem] rounded-xl p-3 hidden">
      <div class="font-semibold mb-2">Birim Ãœret</div>
      <div id="unitList" class="grid grid-cols-3 gap-2 text-xs"></div>
      <div class="mt-2 text-xs opacity-80">Ãœretim: ilgili fabrikanÄ±n yanÄ±ndaki hÃ¼creye Ã§Ä±kar.</div>
    </div>
    <!-- Status / Error -->
    <div id="status" class="panel absolute right-3 top-16 max-w-md rounded-xl p-3 text-sm"></div>
  </div>
</div>

<!-- MODAL: Login & Oda -->
<div id="modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="panel w-[560px] rounded-2xl p-5">
    <div class="text-xl font-bold mb-1">GLOBAL RTS â€” Online</div>
    <div class="text-sm opacity-80 mb-4">Ä°smini ve bayraÄŸÄ±nÄ± seÃ§, oda oluÅŸtur ya da ID ile katÄ±l.</div>
    <div class="grid grid-cols-3 gap-3">
      <div class="col-span-2">
        <label class="text-sm">Ä°smin</label>
        <input id="playerName" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700 outline-none focus:ring-2 focus:ring-sky-500" placeholder="Komutan"/>
      </div>
      <div>
        <label class="text-sm">Bayrak</label>
        <select id="playerFlag" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700">
          <option>ğŸ‡¹ğŸ‡· TÃ¼rkiye</option>
          <option>ğŸ‡ºğŸ‡¸ USA</option>
          <option>ğŸ‡¬ğŸ‡§ UK</option>
          <option>ğŸ‡©ğŸ‡ª Almanya</option>
          <option>ğŸ‡«ğŸ‡· Fransa</option>
          <option>ğŸ‡ªğŸ‡¸ Ä°spanya</option>
          <option>ğŸ‡·ğŸ‡º Rusya</option>
          <option>ğŸ‡®ğŸ‡³ Hindistan</option>
          <option>ğŸ‡¨ğŸ‡³ Ã‡in</option>
          <option>ğŸ‡¯ğŸ‡µ Japonya</option>
          <option>ğŸ‡§ğŸ‡· Brezilya</option>
          <option>ğŸ‡¸ğŸ‡¦ Suudi Arabistan</option>
          <option>ğŸ‡®ğŸ‡· Ä°ran</option>
          <option>ğŸ‡®ğŸ‡¶ Irak</option>
          <option>ğŸ‡¦ğŸ‡¿ Azerbaycan</option>
          <option>ğŸ‡ºğŸ‡¦ Ukrayna</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-3 mt-4">
      <div class="col-span-2">
        <label class="text-sm">Oda ID</label>
        <input id="roomIdInput" class="w-full mt-1 px-3 py-2 rounded bg-slate-900/60 border border-slate-700" placeholder="Ã¶r. DESERT-41F6"/>
      </div>
      <div class="flex gap-2 items-end">
        <button id="btnCreate" class="btn px-3 py-2 rounded w-full">OluÅŸtur</button>
        <button id="btnJoin" class="btn-ghost px-3 py-2 rounded w-full">KatÄ±l</button>
      </div>
    </div>

    <div class="mt-3 text-xs opacity-70">
      Ä°pucu: ArkadaÅŸlarÄ±nla aynÄ± Oda IDâ€™sini paylaÅŸ. Ä°lk giren â€œHOSTâ€ olur; host ayrÄ±lÄ±rsa otomatik yeni host seÃ§ilir.
    </div>
  </div>
</div>

<script>
/* =======================
   Firebase â€” Config
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com",
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.firebasestorage.app",
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* =======================
   Basit yardÄ±mcÄ±lar
======================= */
const $ = sel => document.querySelector(sel);
const pad2 = n => n.toString().padStart(2,'0');
const randId = (p='') => p + Math.random().toString(36).slice(2,8).toUpperCase();
const now = () => Date.now();

function toast(msg, type='info'){
  const box = $('#status');
  box.innerHTML = `<div class="text-${type==='error'?'red':'sky'}-300">${msg}</div>`;
  setTimeout(()=>{ if(box.innerText===msg) box.innerHTML=''; }, 5000);
}

/* =======================
   Oyun sabitleri
======================= */
const GRID = 20;                   // 20x20 = 400 hÃ¼cre
const CELL = 42;                   // piksel (Ã§izim Ã¶lÃ§eÄŸi)
const WIDTH = GRID*CELL;
const HEIGHT= GRID*CELL;
const TICK_MS = 100;               // 10 Hz
const FOG = false;                 // sis kapalÄ± (Ã¶rnek)
const MAX_BUILD_PER_CELL = 2;

// Kaynaklar
const RES = ["food","iron","gold","oil","power"];

// Binalar (adÄ±, kodu, maliyet, gelir/dk, can, kurulum kÄ±sÄ±tÄ±, Ã¼retim/iÅŸlev)
const BUILDINGS = [
  {name:"Ãœs Merkezi", code:"HQ", cost:{food:100,iron:100,gold:100,oil:0,power:0}, hp:3000, income:{}, place:'land', unique:true},
  {name:"DeÄŸirmen", code:"MILL", cost:{food:50,iron:10,gold:0,oil:0,power:5}, hp:800, income:{food:30}, place:'land'},
  {name:"Demir Madeni", code:"IMINE", cost:{food:20,iron:0,gold:0,oil:0,power:10}, hp:900, income:{iron:25}, place:'land'},
  {name:"AltÄ±n Madeni", code:"GMINE", cost:{food:30,iron:10,gold:0,oil:0,power:10}, hp:900, income:{gold:15}, place:'land'},
  {name:"Rafineri", code:"REF", cost:{food:20,iron:30,gold:10,oil:0,power:20}, hp:1000, income:{oil:20}, place:'land'},
  {name:"GÃ¼Ã§ JeneratÃ¶rÃ¼", code:"POW", cost:{food:10,iron:30,gold:10,oil:10,power:0}, hp:900, income:{power:30}, place:'land'},
  {name:"KÄ±ÅŸla", code:"BARR", cost:{food:60,iron:40,gold:20,oil:0,power:10}, hp:1200, income:{}, place:'land', trains:["INF","MG","MORTAR"]},
  {name:"Tank FabrikasÄ±", code:"TFACT", cost:{food:40,iron:120,gold:80,oil:40,power:30}, hp:1400, income:{}, place:'land', trains:["MBT","IFV","APC","SPG"]},
  {name:"FÃ¼ze FabrikasÄ±", code:"MFACT", cost:{food:40,iron:120,gold:120,oil:60,power:40}, hp:1400, income:{}, place:'land', trains:["MLRS","ATGM","SAM"]},
  {name:"Hava ÃœssÃ¼", code:"AIRB", cost:{food:60,iron:140,gold:160,oil:120,power:60}, hp:1600, income:{}, place:'land', trains:["FTR","BMB","HELI"]},
  {name:"SÄ°HA Merkezi", code:"UAVC", cost:{food:40,iron:60,gold:120,oil:80,power:40}, hp:1200, income:{}, place:'land', trains:["UAV","UCAV"]},
  {name:"Hava Savunma Ãœretimi", code:"AADF", cost:{food:30,iron:100,gold:80,oil:40,power:40}, hp:1200, income:{}, place:'land', trains:["AAA","SAM"]},
  {name:"Duvar", code:"WALL", cost:{food:0,iron:20,gold:0,oil:0,power:0}, hp:1200, income:{}, place:'land|desert|bridge', blocks:true},
  {name:"KÃ¶prÃ¼", code:"BRDG", cost:{food:0,iron:40,gold:20,oil:0,power:0}, hp:1000, income:{}, place:'water', special:"bridge"}
];

// 15+ Birim (isim, kod, kategori, hedef tÃ¼rÃ¼, can, hÄ±z, menzil (hÃ¼cre), hasar/sn, maliyet)
const UNITS = [
  {name:"Piyade", code:"INF", cat:"ground",  vs:["ground"], hp:100,  spd:2.2, rng:3, dps:12, cost:{food:40,iron:10,gold:0,oil:0,power:0}},
  {name:"MG Timi", code:"MG", cat:"ground",   vs:["ground"], hp:120,  spd:1.8, rng:4, dps:18, cost:{food:50,iron:20,gold:0,oil:0,power:0}},
  {name:"Havan", code:"MORTAR", cat:"ground", vs:["ground"], hp:120,  spd:1.6, rng:6, dps:22, cost:{food:50,iron:30,gold:0,oil:0,power:0}},
  {name:"APC", code:"APC", cat:"ground",      vs:["ground"], hp:260,  spd:3.1, rng:3, dps:16, cost:{food:30,iron:80,gold:10,oil:20,power:0}},
  {name:"IFV", code:"IFV", cat:"ground",      vs:["ground","air"], hp:300, spd:2.8, rng:4, dps:22, cost:{food:40,iron:100,gold:20,oil:30,power:0}},
  {name:"Ana Muharebe TankÄ±", code:"MBT", cat:"ground", vs:["ground"], hp:520, spd:2.4, rng:5, dps:35, cost:{food:50,iron:160,gold:80,oil:60,power:0}},
  {name:"KundaÄŸÄ± Motorlu ObÃ¼s", code:"SPG", cat:"ground", vs:["ground"], hp:400, spd:2.2, rng:8, dps:40, cost:{food:60,iron:140,gold:80,oil:50,power:0}},
  {name:"Ã‡ok Namlulu Roket", code:"MLRS", cat:"ground", vs:["ground"], hp:380, spd:2.0, rng:9, dps:50, cost:{food:60,iron:140,gold:120,oil:60,power:0}},
  {name:"ATGM Timi", code:"ATGM", cat:"ground", vs:["ground"], hp:140, spd:1.6, rng:6, dps:32, cost:{food:40,iron:60,gold:40,oil:0,power:0}},
  {name:"UÃ§aksavar Topu", code:"AAA", cat:"ground", vs:["air"], hp:260, spd:1.6, rng:5, dps:34, cost:{food:30,iron:80,gold:40,oil:0,power:10}},
  {name:"SAM BataryasÄ±", code:"SAM", cat:"ground", vs:["air"], hp:360, spd:1.6, rng:8, dps:45, cost:{food:40,iron:120,gold:80,oil:30,power:20}},
  {name:"Taarruz Helikopteri", code:"HELI", cat:"air", vs:["ground"], hp:340, spd:4.0, rng:5, dps:38, cost:{food:60,iron:100,gold:120,oil:80,power:30}},
  {name:"AvcÄ± UÃ§ak", code:"FTR", cat:"air", vs:["air"], hp:320, spd:4.6, rng:6, dps:44, cost:{food:60,iron:120,gold:160,oil:100,power:40}},
  {name:"BombardÄ±man", code:"BMB", cat:"air", vs:["ground"], hp:480, spd:4.0, rng:7, dps:55, cost:{food:80,iron:160,gold:200,oil:140,power:60}},
  {name:"KeÅŸif SÄ°HA", code:"UAV", cat:"air", vs:[], hp:120, spd:3.8, rng:0, dps:0, cost:{food:20,iron:20,gold:60,oil:20,power:10}},
  {name:"SilahlÄ± SÄ°HA", code:"UCAV", cat:"air", vs:["ground"], hp:220, spd:3.6, rng:6, dps:32, cost:{food:30,iron:60,gold:100,oil:40,power:20}},
  {name:"Hafif ZÄ±rhlÄ±", code:"LAV", cat:"ground", vs:["ground"], hp:220, spd:3.4, rng:3, dps:18, cost:{food:30,iron:80,gold:20,oil:20,power:0}}
];
// kod -> obje eriÅŸimi
const UNIT_BY_CODE = Object.fromEntries(UNITS.map(u=>[u.code,u]));

// Basit renk atamalarÄ± (birim ikonlarÄ± iÃ§in)
const UNIT_COLOR = {
  ground:"#7dd3fc", air:"#c084fc", wall:"#94a3b8"
};

/* =======================
   Global state
======================= */
let me = {uid:null, name:"", flag:"", roomId:null, isHost:false};
let roomRef=null, metaRef=null, mapRef=null, unitsRef=null, buildingsRef=null, playersRef=null, cmdRef=null;
let game = {
  map: [],                 // terrain: 'land'|'desert'|'water' + bridge bool
  players:{},              // uid -> info
  units:{},                // id -> unit
  buildings:{},            // id -> building
  resources:{},            // uid -> {food,iron,gold,oil,power}
  lastTick: 0,
  mySelection: null,       // unit id
  cam:{x:0,y:0,zoom:1},
  hostHeartbeat:0
};
// Kanvas
const canvas = $('#world');
canvas.width = WIDTH;
canvas.height= HEIGHT;
const ctx = canvas.getContext('2d');
const overlay = $('#overlay');
const mmin = $('#minimap');
const mctx = mmin.getContext('2d');

// Pan/zoom
let isPanning=false, panStart=null;
overlay.addEventListener('mousedown', e=>{
  if(e.button===1){ // orta
    isPanning=true; panStart={x:e.clientX, y:e.clientY, cx:game.cam.x, cy:game.cam.y};
  }
});
overlay.addEventListener('mousemove', e=>{
  if(isPanning){
    const dx=e.clientX-panStart.x, dy=e.clientY-panStart.y;
    game.cam.x = Math.max(0, Math.min(WIDTH - widthOnScreen(), panStart.cx - dx/game.cam.zoom));
    game.cam.y = Math.max(0, Math.min(HEIGHT- heightOnScreen(), panStart.cy - dy/game.cam.zoom));
  }
});
overlay.addEventListener('mouseup', ()=>{isPanning=false});
overlay.addEventListener('mouseleave', ()=>{isPanning=false});
overlay.addEventListener('wheel', e=>{
  const z = game.cam.zoom * (e.deltaY>0 ? 0.9 : 1.1);
  game.cam.zoom = Math.max(.6, Math.min(2.2, z));
  e.preventDefault();
},{passive:false});

// SaÄŸ tÄ±k menÃ¼sÃ¼ kapat
overlay.addEventListener('contextmenu', e=>e.preventDefault());

function widthOnScreen(){ return canvas.clientWidth / game.cam.zoom }
function heightOnScreen(){ return canvas.clientHeight / game.cam.zoom }

/* =======================
   Oda akÄ±ÅŸÄ± ve Firebase
======================= */
async function signInAnon(){
  try{
    const cred = await auth.signInAnonymously();
    me.uid = cred.user.uid;
    console.log('Signed in:', me.uid);
  }catch(err){
    console.error(err);
    toast('Auth hata: '+err.message,'error');
  }
}
function roomRefs(roomId){
  roomRef = db.ref('rooms/'+roomId);
  metaRef = roomRef.child('meta');
  mapRef  = roomRef.child('map');
  unitsRef= roomRef.child('units');
  buildingsRef=roomRef.child('buildings');
  playersRef= roomRef.child('players');
  cmdRef = roomRef.child('commands');
}
function roomSeed(roomId){
  // deterministik seed
  let h=0; for(const c of roomId) h = (h*31 + c.charCodeAt(0))>>>0;
  return h;
}
function seededRandom(seed){ // mulberry32
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ t>>>15, t | 1);
    t ^= t + Math.imul(t ^ t>>>7, t | 61);
    return ((t ^ t>>>14) >>> 0) / 4294967296;
  }
}
function genMap(roomId){
  const rnd = seededRandom(roomSeed(roomId));
  const map=[];
  // desen: orta-bÃ¼yÃ¼k bir deniz ÅŸeridi + Ã§Ã¶l cepleri + kÃ¶prÃ¼ler
  const seaBand = Math.floor(GRID* (0.35 + rnd()*0.15)); // yatay deniz bandÄ± satÄ±rÄ±
  for(let y=0;y<GRID;y++){
    map[y]=[];
    for(let x=0;x<GRID;x++){
      let t='land';
      if (y>=seaBand-2 && y<=seaBand+1) t='water';
      if (t==='land' && rnd()<0.18) t='desert';
      map[y][x]={t, bridge:false, builds:0};
    }
  }
  // kÃ¶prÃ¼ koridorlarÄ±
  for(let x=2;x<GRID-2;x+=4){
    const by = seaBand + ((x%8===0)?0:1);
    if(by>=0 && by<GRID){
      if(map[by]) map[by][x] && (map[by][x].bridge=true, map[by][x].t='water');
    }
  }
  return map;
}
function cellTerrainStr(c){
  if(c.bridge) return 'bridge';
  return c.t;
}
function canPlace(buildCode, tx, ty){
  const b = BUILDINGS.find(b=>b.code===buildCode);
  const cell = game.map[ty]?.[tx];
  if(!b || !cell) return false;
  if(cell.builds >= MAX_BUILD_PER_CELL) return false;
  // Arazi kÄ±sÄ±tÄ±
  const place = b.place; // 'land' | 'water' | 'land|desert|bridge'
  const terr = cellTerrainStr(cell);
  if(place.includes('|')){
    if(!place.split('|').includes(terr)) return false;
  } else {
    if(place==='land' && terr==='desert') return true; // Ã§Ã¶l de kara olarak kabul
    if(place!=='land' && terr==='desert' && place!=='desert') return false;
    if(place!=='land' && terr==='land') return false;
    if(place==='land' && (terr==='water')) return false;
    if(place==='water' && terr!=='water') return false;
  }
  return true;
}
function pay(cost, uid=me.uid){
  const r = game.resources[uid];
  for(const k of RES){ if((cost[k]||0) > (r[k]||0)) return false; }
  for(const k of RES){ r[k] = (r[k]||0) - (cost[k]||0); }
  playersRef.child(uid).child('res').set(r);
  return true;
}
function addIncome(uid, inc){
  const r = game.resources[uid]; for(const k of RES){ r[k]=(r[k]||0)+(inc[k]||0); }
}

/* =======================
   Oyun nesneleri
======================= */
function cellKey(x,y){ return x+'_'+y }
function spawnBuilding(uid, code, x,y){
  const id='B_'+randId();
  const def = BUILDINGS.find(b=>b.code===code);
  const obj={id, owner:uid, code, x, y, hp:def.hp, t:now()};
  // hÃ¼cre sayaÃ§
  game.map[y][x].builds++;
  // kayÄ±t
  buildingsRef.child(id).set(obj);
  return id;
}
function spawnUnit(uid, code, x,y){
  const id='U_'+randId();
  const def=UNIT_BY_CODE[code];
  const obj={id, owner:uid, code, x, y, fx:x, fy:y, hp:def.hp, t:now(), tgt:null, order:null, cd:0};
  unitsRef.child(id).set(obj);
  return id;
}
function delUnit(id){ unitsRef.child(id).remove(); }
function delBuilding(id){ buildingsRef.child(id).remove(); }

/* =======================
   Komut sistemi (host iÅŸler)
======================= */
async function pushCommand(cmd){
  const ref = cmdRef.child(me.uid).push();
  await ref.set({...cmd, ts:firebase.database.ServerValue.TIMESTAMP});
}
async function hostLoop(){
  // heartbeat
  await metaRef.child('hostHeartbeat').set(now());
  // komutlarÄ± topla
  const snap = await cmdRef.get();
  const cmds = [];
  snap.forEach(user=>{
    user.forEach(k=>{
      cmds.push({...k.val(), _path:k.ref});
    });
  });
  // iÅŸle
  for(const c of cmds){
    if(c.type==='build'){
      const {uid, code, x,y}=c;
      if(!canPlace(code,x,y)) { await c._path.remove(); continue; }
      const def = BUILDINGS.find(b=>b.code===code);
      if(!tryPayServer(uid, def.cost)) { await c._path.remove(); continue; }
      spawnBuilding(uid, code, x,y);
    }
    if(c.type==='train'){
      const {uid, code, nearX, nearY}=c;
      const def=UNIT_BY_CODE[code];
      if(!tryPayServer(uid, def.cost)){ await c._path.remove(); continue; }
      // yakÄ±ndaki boÅŸ bir hÃ¼creye Ã§Ä±kar
      const pos = findFreeAround(nearX,nearY);
      if(pos) spawnUnit(uid, code, pos.x, pos.y);
    }
    if(c.type==='order'){
      const {uid, unitId, order}=c;
      const u = game.units[unitId];
      if(u && u.owner===uid){
        unitsRef.child(unitId).child('order').set(order||null);
      }
    }
    await c._path.remove();
  }
  // ekonomi: her saniye kaynak ekle (daha yumuÅŸak iÃ§in tick bazlÄ±)
  if(!game._incomeAcc) game._incomeAcc=0;
  game._incomeAcc += TICK_MS;
  if(game._incomeAcc>=1000){
    game._incomeAcc=0;
    // binalarÄ±n gelirini sahiplerine yaz
    const byOwner={};
    Object.values(game.buildings).forEach(b=>{
      const def=BUILDINGS.find(x=>x.code===b.code);
      if(def.income){
        byOwner[b.owner]=byOwner[b.owner]||{food:0,iron:0,gold:0,oil:0,power:0};
        for(const k of RES) byOwner[b.owner][k]+= (def.income[k]||0)/60; // /dk -> /sn
      }
    });
    // yuvarla-yaz
    for(const uid of Object.keys(byOwner)){
      const r = (game.resources[uid]||{});
      for(const k of RES){ r[k]=(r[k]||0)+byOwner[uid][k]; }
      // kÃ¼Ã§Ã¼k ondalÄ±klarÄ± bastÄ±r
      for(const k of RES){ r[k]=Math.max(0, Math.round(r[k]*10)/10); }
      playersRef.child(uid).child('res').set(r);
    }
  }
  // hareket/saldÄ±rÄ± simÃ¼lasyonu
  simStep();
}
function tryPayServer(uid, cost){
  const r = game.resources[uid]; if(!r) return false;
  for(const k of RES){ if((cost[k]||0) > (r[k]||0)) return false; }
  const nr = {...r}; for(const k of RES){ nr[k]-=(cost[k]||0) }
  playersRef.child(uid).child('res').set(nr);
  return true;
}
function findFreeAround(x,y){
  const dirs=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[-1,1],[1,-1],[-1,-1]];
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(nx<0||ny<0||nx>=GRID||ny>=GRID) continue;
    // duvar/yoÄŸunluk kontrol
    const block = Object.values(game.buildings).some(b=>b.x===nx && b.y===ny && (BUILDINGS.find(bb=>bb.code===b.code).blocks));
    const occ = Object.values(game.units).some(u=>u.x===nx && u.y===ny);
    const terr = game.map[ny][nx];
    if(!block && !occ && terr.t!=='water') return {x:nx,y:ny};
  }
  return null;
}

/* =======================
   SimÃ¼lasyon
======================= */
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function inRange(u, v){
  const du = UNIT_BY_CODE[u.code];
  const rng = du.rng;
  return Math.abs(u.x - v.x) <= rng && Math.abs(u.y - v.y) <= rng && (Math.hypot(u.x-v.x,u.y-v.y) <= rng+0.01);
}
function passable(x,y, cat){
  if(x<0||y<0||x>=GRID||y>=GRID) return false;
  const cell = game.map[y][x];
  if(cat==='air') return true; // hava her yerden
  if(cell.t==='water' && !cell.bridge) return false;
  // duvar engeli
  const wallHere = Object.values(game.buildings).some(b=>b.x===x && b.y===y && BUILDINGS.find(bb=>bb.code===b.code).blocks);
  return !wallHere;
}
function stepMove(u){
  if(!u.order || u.order.type!=='move') return;
  const def = UNIT_BY_CODE[u.code];
  if(!u._path || !u._path.length){
    // A* ileè·¯å¾„
    const path = astar({x:u.x,y:u.y}, {x:u.order.x,y:u.order.y}, def.cat);
    u._path = path;
  }
  if(u._path && u._path.length){
    const next = u._path[0];
    if(u.x===next.x && u.y===next.y){ u._path.shift(); return; }
    // 1 hÃ¼cre/sn = 1; spd hÃ¼cre/sn
    const step = def.spd * (TICK_MS/1000);
    // grid adÄ±m (tile tile)
    const dx = Math.sign(next.x - u.x), dy = Math.sign(next.y - u.y);
    // parÃ§alÄ± ilerleme: fraksiyon sakla
    if(u.fx===undefined){ u.fx=u.x; u.fy=u.y; }
    let vdx = dx*step, vdy = dy*step;
    // hedefe aÅŸÄ±rÄ± gitme engeli
    if(Math.abs((u.fx+vdx)-next.x) < step) u.fx=next.x; else u.fx += vdx;
    if(Math.abs((u.fy+vdy)-next.y) < step) u.fy=next.y; else u.fy += vdy;
    // hÃ¼cre tamamlandÄ± mÄ±?
    if(Math.abs(u.fx-next.x)<0.01 && Math.abs(u.fy-next.y)<0.01){
      u.x = next.x; u.y = next.y; u.fx=u.x; u.fy=u.y; u._path.shift();
    } else {
      // ara konumu yaz
      unitsRef.child(u.id).update({fx:u.fx, fy:u.fy});
    }
  }
}
function stepCombat(u){
  const def = UNIT_BY_CODE[u.code];
  if(!def) return;
  // hedef bul veya mevcut hedefi doÄŸrula
  let t=null;
  if(u.tgt){
    const v = game.units[u.tgt];
    if(v && v.owner!==u.owner) t=v;
    else u.tgt=null;
  }
  if(!t){
    // otomatik hedef seÃ§imi: en yakÄ±n dÃ¼ÅŸman uygun kategoride ve menzildeyse
    let best=null, bd=1e9;
    for(const v of Object.values(game.units)){
      if(v.owner===u.owner) continue;
      const dv = UNIT_BY_CODE[v.code];
      // hedef kategorisi uygun mu?
      const targetCat = dv.cat;
      if(def.vs.length && !def.vs.includes(targetCat)) continue;
      const d = Math.hypot((u.fx??u.x)-(v.fx??v.x), (u.fy??u.y)-(v.fy??v.y));
      if(d < bd){ bd=d; best=v; }
    }
    if(best && dTiles(u,best) <= def.rng+0.05) t=best, u.tgt=best.id;
  }
  // saldÄ±r
  if(t && dTiles(u,t) <= def.rng+0.05){
    if(u.cd>0){ u.cd-=TICK_MS; if(u.cd<0) u.cd=0; return; }
    // hasar/sn -> tick hasarÄ±
    const dmg = def.dps * (TICK_MS/1000);
    const newHp = (t.hp || UNIT_BY_CODE[t.code].hp) - dmg;
    // efekt: lazer
    beamEffect(u, t);
    if(newHp<=0){
      unitsRef.child(t.id).remove();
      u.tgt=null;
    } else {
      unitsRef.child(t.id).child('hp').set(Math.round(newHp));
    }
    u.cd = 800; // atÄ±ÅŸ periyodu (ms)
  }
}
function dTiles(a,b){ return Math.hypot((a.fx??a.x)-(b.fx??b.x), (a.fy??a.y)-(b.fy??b.y)); }

function astar(start, goal, cat){
  // 4-yÃ¶n A*
  const open=[{...start,g:0,f:0}];
  const key=(p)=>p.x+','+p.y;
  const came=new Map(), gscore=new Map([[key(start),0]]);
  const fscore=new Map([[key(start),heur(start,goal)]]);
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
  function heur(a,b){ return Math.abs(a.x-b.x)+Math.abs(a.y-b.y); }
  while(open.length){
    open.sort((a,b)=> (fscore.get(key(a))??1e9)-(fscore.get(key(b))??1e9));
    const cur=open.shift();
    if(cur.x===goal.x && cur.y===goal.y){
      // yol oluÅŸtur
      const path=[];
      let ck=key(cur);
      let node=cur;
      while(came.has(ck)){
        path.unshift({x:node.x,y:node.y});
        node = came.get(ck); ck=key(node);
      }
      return path;
    }
    for(const [dx,dy] of dirs){
      const nx=cur.x+dx, ny=cur.y+dy;
      if(!passable(nx,ny,cat)) continue;
      const ng = (gscore.get(key(cur))??1e9)+1;
      const nk = nx+','+ny;
      if(ng < (gscore.get(nk)??1e9)){
        came.set(nk, cur); gscore.set(nk,ng); fscore.set(nk, ng+heur({x:nx,y:ny},goal));
        if(!open.find(o=>o.x===nx&&o.y===ny)) open.push({x:nx,y:ny});
      }
    }
  }
  return [];
}

function simStep(){
  // units snapshot
  const units = Object.values(game.units);
  for(const u of units){
    stepMove(u);
    stepCombat(u);
    // Ã¶lÃ§ekli konum gÃ¼ncellemeleri
    unitsRef.child(u.id).update({x:u.x,y:u.y, fx:u.fx??u.x, fy:u.fy??u.y, tgt:u.tgt??null, cd:u.cd});
  }
}

/* =======================
   Ã‡izim
======================= */
function draw(){
  ctx.save();
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  // kamera
  ctx.translate(-game.cam.x, -game.cam.y);
  ctx.scale(game.cam.zoom, game.cam.zoom);

  // zemin
  for(let y=0;y<GRID;y++){
    for(let x=0;x<GRID;x++){
      const c = game.map[y][x];
      let col = (c.t==='land')? 'var(--land)' : (c.t==='desert' ? 'var(--desert)' : 'var(--water)');
      ctx.fillStyle = col;
      ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
      // kÃ¶prÃ¼
      if(c.bridge){
        ctx.fillStyle = 'var(--bridge)';
        ctx.fillRect(x*CELL, y*CELL + CELL*0.4, CELL, CELL*0.2);
      }
      // grid
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.strokeRect(x*CELL, y*CELL, CELL, CELL);
    }
  }

  // binalar
  for(const b of Object.values(game.buildings)){
    const def = BUILDINGS.find(x=>x.code===b.code);
    const x=b.x*CELL, y=b.y*CELL;
    ctx.fillStyle = 'rgba(255,255,255,.08)';
    ctx.fillRect(x+4,y+4, CELL-8, CELL-8);
    // ikon
    ctx.fillStyle = '#e2e8f0';
    ctx.font = '700 11px Inter';
    ctx.fillText(def.code, x+6, y+16);
    // HP barÄ±
    ctx.fillStyle='#1f2937'; ctx.fillRect(x+6, y+CELL-10, CELL-12, 6);
    ctx.fillStyle='#10b981'; const pw = Math.max(0, (b.hp/def.hp)*(CELL-12));
    ctx.fillRect(x+6, y+CELL-10, pw, 6);
  }

  // birimler
  for(const u of Object.values(game.units)){
    const def = UNIT_BY_CODE[u.code];
    const ux = (u.fx??u.x)*CELL, uy = (u.fy??u.y)*CELL;
    // gÃ¶lge
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.arc(ux+CELL/2, uy+CELL/2, 7, 0, Math.PI*2); ctx.fill();
    // gÃ¶vde
    ctx.fillStyle = UNIT_COLOR[def.cat] || '#93c5fd';
    ctx.beginPath(); ctx.arc(ux+CELL/2, uy+CELL/2, 6, 0, Math.PI*2); ctx.fill();
    // iÅŸaret: hava Ã¼Ã§gen
    if(def.cat==='air'){
      ctx.strokeStyle='#e9d5ff'; ctx.beginPath(); ctx.moveTo(ux+CELL/2, uy+CELL/2-7); ctx.lineTo(ux+CELL/2-6, uy+CELL/2+6); ctx.lineTo(ux+CELL/2+6, uy+CELL/2+6); ctx.closePath(); ctx.stroke();
    }
    // menzil halkasÄ± (seÃ§ili)
    if(game.mySelection===u.id){
      ctx.strokeStyle='rgba(96,165,250,0.5)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(ux+CELL/2, uy+CELL/2, (UNIT_BY_CODE[u.code].rng*CELL), 0, Math.PI*2);
      ctx.stroke();
    }
    // kÃ¼Ã§Ã¼k kod etiketi
    ctx.fillStyle='#0b1220'; ctx.font='700 9px Inter'; ctx.fillText(def.code, ux+CELL/2-11, uy+CELL/2+3);
    // HP
    ctx.fillStyle='#1f2937'; ctx.fillRect(ux+CELL/2-12, uy+CELL-6, 24,4);
    ctx.fillStyle='#10b981'; ctx.fillRect(ux+CELL/2-12, uy+CELL-6, Math.max(0,24*(u.hp/def.hp)),4);
  }

  ctx.restore();
  drawMinimap();
  requestAnimationFrame(draw);
}
function drawMinimap(){
  // arka
  mctx.clearRect(0,0,200,200);
  const s = 200/GRID;
  for(let y=0;y<GRID;y++){
    for(let x=0;x<GRID;x++){
      const c = game.map[y][x];
      mctx.fillStyle = (c.t==='land')? '#1f6845' : (c.t==='desert' ? '#a69244' : '#1a4062');
      mctx.fillRect(x*s,y*s,s,s);
      if(c.bridge){ mctx.fillStyle='#7a8796'; mctx.fillRect(x*s,y*s+s*0.45,s,s*0.1); }
    }
  }
  // birimler
  for(const u of Object.values(game.units)){
    const def=UNIT_BY_CODE[u.code];
    mctx.fillStyle = (u.owner===me.uid)? '#60a5fa' : '#f472b6';
    mctx.fillRect((u.x)*s+2,(u.y)*s+2, s-4, s-4);
  }
  // kamera kutusu
  const sx = (game.cam.x/WIDTH)*200, sy=(game.cam.y/HEIGHT)*200;
  const sw = (widthOnScreen()/WIDTH)*200, sh=(heightOnScreen()/HEIGHT)*200;
  mctx.strokeStyle='#e2e8f0'; mctx.strokeRect(sx,sy,sw,sh);
}

/* =======================
   UI â€” Build & Train
======================= */
function resStr(cost){
  return `ğŸ${cost.food||0} â›ï¸${cost.iron||0} ğŸª™${cost.gold||0} ğŸ›¢ï¸${cost.oil||0} âš¡${cost.power||0}`;
}
function renderBuildPanel(){
  const list = $('#buildList'); list.innerHTML='';
  for(const b of BUILDINGS){
    if(b.code==='HQ') continue; // HQ otomatik kurulur
    const btn = document.createElement('button');
    btn.className='btn-ghost rounded p-2 text-left hover:ring-2 ring-sky-500';
    btn.innerHTML = `<div class="font-semibold">${b.name}</div>
    <div class="flex justify-between text-xs opacity-80"><span>${b.code}</span><span>${resStr(b.cost)}</span></div>`;
    btn.onclick = ()=>{
      buildMode.code = b.code;
      toast(`${b.name} seÃ§ildi. Haritada saÄŸ tÄ±kla ve hÃ¼creyi onayla.`);
    };
    list.appendChild(btn);
  }
}
function renderUnitPanel(){
  const list = $('#unitList'); list.innerHTML='';
  for(const u of UNITS){
    const btn = document.createElement('button');
    btn.className='btn-ghost rounded p-2 text-left hover:ring-2 ring-sky-500';
    btn.innerHTML = `<div class="font-semibold">${u.name}</div>
    <div class="flex justify-between"><span class="opacity-80">${u.code} â€¢ ${u.cat==='air'?'Hava':'Kara'}</span><span class="text-xs">${resStr(u.cost)}</span></div>
    <div class="text-xs opacity-80">HP:${u.hp} RNG:${u.rng} SPD:${u.spd} DPS:${u.dps}</div>`;
    btn.onclick = ()=>{ trainMode.code=u.code; toast(`${u.name} iÃ§in Ã¼retim: Ã¼retim binasÄ±nÄ±n yanÄ±na Ã§Ä±kacak. SaÄŸ tÄ±kla.`); };
    list.appendChild(btn);
  }
}
const buildMode = {code:null};
const trainMode = {code:null};

/* =======================
   Girdi: seÃ§im/komut
======================= */
function screenToWorld(e){
  const rect = canvas.getBoundingClientRect();
  const sx = (e.clientX - rect.left), sy=(e.clientY - rect.top);
  const wx = (sx / game.cam.zoom) + game.cam.x;
  const wy = (sy / game.cam.zoom) + game.cam.y;
  return {wx,wy, tx:Math.floor(wx/CELL), ty:Math.floor(wy/CELL)};
}

overlay.addEventListener('mousedown', async (e)=>{
  const p = screenToWorld(e);
  if(e.button===0){
    // sol: seÃ§im
    let sel=null;
    for(const u of Object.values(game.units)){
      const ux=(u.fx??u.x)*CELL+CELL/2, uy=(u.fy??u.y)*CELL+CELL/2;
      const d=Math.hypot(p.wx-ux,p.wy-uy);
      if(d<10 && u.owner===me.uid){ sel=u.id; break; }
    }
    game.mySelection = sel;
  }
  if(e.button===2){
    // saÄŸ: komut
    const tx=p.tx, ty=p.ty;
    if(buildMode.code){
      // inÅŸa komutu
      await pushCommand({type:'build', uid:me.uid, code:buildMode.code, x:tx, y:ty});
      buildMode.code=null;
      $('#buildPanel').classList.add('hidden');
      return;
    }
    if(trainMode.code){
      await pushCommand({type:'train', uid:me.uid, code:trainMode.code, nearX:tx, nearY:ty});
      trainMode.code=null;
      $('#trainPanel').classList.add('hidden');
      return;
    }
    // hedefte dÃ¼ÅŸman var mÄ±?
    let targetUnit = Object.values(game.units).find(u=>u.x===tx && u.y===ty && u.owner!==me.uid);
    if(game.mySelection){
      const order = targetUnit ? {type:'attack', id:targetUnit.id} : {type:'move', x:tx, y:ty};
      await pushCommand({type:'order', uid:me.uid, unitId:game.mySelection, order});
    }
  }
});

/* =======================
   Efektler
======================= */
function beamEffect(u, v){
  // turuncu lazer
  const a = toScreen((u.fx??u.x)+.5,(u.fy??u.y)+.5);
  const b = toScreen((v.fx??v.x)+.5,(v.fy??v.y)+.5);
  const dx=b.x-a.x, dy=b.y-a.y;
  const len=Math.hypot(dx,dy);
  const ang=Math.atan2(dy,dx);
  const el=document.createElement('div');
  el.className='beam';
  el.style.left=a.x+'px';
  el.style.top=a.y+'px';
  el.style.width=len+'px';
  el.style.transform=`rotate(${ang}rad)`;
  overlay.appendChild(el);
  setTimeout(()=> el.remove(), 180);
}
function toScreen(cx,cy){
  return { x: (cx*CELL - game.cam.x)*game.cam.zoom, y: (cy*CELL - game.cam.y)*game.cam.zoom };
}

/* =======================
   HUD
======================= */
function updateHUD(){
  const r = game.resources[me.uid]||{food:0,iron:0,gold:0,oil:0,power:0};
  $('#resFood').innerText = Math.floor(r.food);
  $('#resIron').innerText = Math.floor(r.iron);
  $('#resGold').innerText = Math.floor(r.gold);
  $('#resOil').innerText  = Math.floor(r.oil);
  $('#resPower').innerText= Math.floor(r.power);
}

/* =======================
   Host seÃ§imi & dinleyiciler
======================= */
async function joinRoom(roomId){
  me.roomId = roomId;
  roomRefs(roomId);

  // Map init (ilk kuran)
  const mapSnap = await mapRef.get();
  if(!mapSnap.exists()){
    const mp = genMap(roomId);
    await mapRef.set(mp);
  }
  game.map = (await mapRef.get()).val();

  // oyuncu kaydÄ±
  const pInfo = {name:me.name, flag:me.flag, joinedAt:firebase.database.ServerValue.TIMESTAMP, res:{food:300,iron:200,gold:200,oil:120,power:60}};
  await playersRef.child(me.uid).set(pInfo);
  // ayrÄ±lÄ±rken sil
  playersRef.child(me.uid).onDisconnect().remove();

  // host atamasÄ±
  await metaRef.child('hostUid').transaction(cur => cur || me.uid);
  // listener: host deÄŸiÅŸimi / heartbeat
  metaRef.on('value', s=>{
    const v=s.val()||{}; game.hostHeartbeat = v.hostHeartbeat||0; me.isHost = (v.hostUid===me.uid);
    $('#hostBadge').classList.toggle('hidden', !me.isHost);
  });
  // host watchdog: 5s kalp yoksa host olmayÄ± dene
  setInterval(async ()=>{
    if(me.isHost) return;
    const v=(await metaRef.get()).val()||{};
    if(now() - (v.hostHeartbeat||0) > 5000){
      await metaRef.child('hostUid').transaction(cur => cur || me.uid);
    }
  }, 3000);

  // Dinleyiciler
  mapRef.on('value', s=> { game.map = s.val()||game.map; });
  buildingsRef.on('value', s=> { game.buildings = s.val()||{}; });
  unitsRef.on('value', s=> { game.units = s.val()||{}; });
  playersRef.on('value', s=>{
    const v=s.val()||{};
    game.players = v;
    game.resources = Object.fromEntries(Object.entries(v).map(([k,o])=>[k,o.res||{food:0,iron:0,gold:0,oil:0,power:0}]));
    updateHUD();
  });

  // kendi baÅŸlangÄ±Ã§ Ã¼ssÃ¼ (yoksa)
  const haveMyHQ = Object.values(game.buildings).some(b=>b.owner===me.uid && b.code==='HQ');
  if(!haveMyHQ){
    const myIndex = Object.keys(game.players).sort().indexOf(me.uid);
    const baseX = (myIndex%2===0) ? 2 : GRID-3;
    const baseY = 2 + (myIndex*3 % (GRID-4));
    await pushCommand({type:'build', uid:me.uid, code:'HQ', x:baseX, y:baseY});
    // baÅŸlangÄ±Ã§ savunma ve birim
    setTimeout(async ()=>{
      await pushCommand({type:'train', uid:me.uid, code:'INF', nearX:baseX, nearY:baseY});
      await pushCommand({type:'train', uid:me.uid, code:'IFV', nearX:baseX, nearY:baseY});
    }, 300);
    centerOn(baseX,baseY);
  }

  // Ã§izime baÅŸla
  requestAnimationFrame(draw);

  // host dÃ¶ngÃ¼sÃ¼
  setInterval(()=>{ if(me.isHost) hostLoop(); }, TICK_MS);

  // HUD
  $('#roomLabel').innerText = 'Oda: '+roomId;
  toast('Odaya baÄŸlandÄ±: '+roomId);
}

function centerOn(x,y){
  const cx = x*CELL - (widthOnScreen()/2) + CELL/2;
  const cy = y*CELL - (heightOnScreen()/2) + CELL/2;
  game.cam.x = Math.max(0, Math.min(WIDTH - widthOnScreen(), cx));
  game.cam.y = Math.max(0, Math.min(HEIGHT - heightOnScreen(), cy));
}

/* =======================
   UI wiring
======================= */
$('#openBuild').onclick = ()=>{ renderBuildPanel(); $('#buildPanel').classList.toggle('hidden'); $('#trainPanel').classList.add('hidden'); };
$('#openTrain').onclick = ()=>{ renderUnitPanel(); $('#trainPanel').classList.toggle('hidden'); $('#buildPanel').classList.add('hidden'); };
$('#centerBase').onclick = ()=>{
  // kendi HQ konumuna ortala
  const myHQ = Object.values(game.buildings).find(b=>b.owner===me.uid && b.code==='HQ');
  if(myHQ) centerOn(myHQ.x, myHQ.y);
};
document.addEventListener('keydown', e=>{
  if(e.key==='b' || e.key==='B') $('#openBuild').click();
  if(e.key==='u' || e.key==='U') $('#openTrain').click();
});

/* =======================
   Modal (Oda oluÅŸtur/katÄ±l)
======================= */
function countryFlagValue(selText){
  // "ğŸ‡¹ğŸ‡· TÃ¼rkiye" -> "ğŸ‡¹ğŸ‡·"
  return selText.split(' ')[0];
}
$('#btnCreate').onclick = async ()=>{
  const name = $('#playerName').value.trim() || 'Komutan';
  const flag = countryFlagValue($('#playerFlag').value || 'ğŸ‡¹ğŸ‡· TÃ¼rkiye');
  let rid = $('#roomIdInput').value.trim();
  if(!rid) rid = ('DESERT-' + randId());
  me.name=name; me.flag=flag;
  $('#modal').classList.add('hidden');
  try{
    await signInAnon();
    await joinRoom(rid);
  }catch(e){
    $('#modal').classList.remove('hidden'); toast('OluÅŸturma hatasÄ±: '+e.message,'error');
  }
};
$('#btnJoin').onclick = async ()=>{
  const name = $('#playerName').value.trim() || 'Komutan';
  const flag = countryFlagValue($('#playerFlag').value || 'ğŸ‡¹ğŸ‡· TÃ¼rkiye');
  let rid = $('#roomIdInput').value.trim();
  if(!rid){ toast('LÃ¼tfen Oda ID girin','error'); return; }
  me.name=name; me.flag=flag;
  $('#modal').classList.add('hidden');
  try{
    await signInAnon();
    await joinRoom(rid);
  }catch(e){
    $('#modal').classList.remove('hidden'); toast('KatÄ±lÄ±m hatasÄ±: '+e.message,'error');
  }
};

/* =======================
   BaÅŸlangÄ±Ã§ Ã§izimi (map boÅŸken)
======================= */
(function boot(){
  // boÅŸ geÃ§ici harita (modal altÄ±nda)
  game.map = genMap('LOCAL');
  draw();
  // saÄŸ alt bilgi
  $('#status').innerHTML = `<div>Sol tÄ±k: seÃ§im â€¢ SaÄŸ tÄ±k: hareket/saldÄ±rÄ± â€¢ Orta tÄ±k + sÃ¼rÃ¼kle: kaydÄ±r â€¢ Fare tekeri: zoom</div>`;
})();

</script>
</body>
</html>
