<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Global RTS — Online Prototip (20x20)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap">
<style>
  :root{
    --bg:#0b1220; --panel:#111A2B; --panel2:#0f172a; --text:#E6EDF6;
    --muted:#9fb2ca; --accent:#22d3ee; --good:#34d399; --warn:#f59e0b; --bad:#ef4444;
    --tile:40px; /* kare boyutu (px). 20x20 => 800x800 */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 30% 10%,#0d1b2a 0,#0b1220 60%,#08101c 100%);color:var(--text);font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--accent);text-decoration:none}
  .btn{background:linear-gradient(180deg,#1e293b,#0f172a); border:1px solid #263244; color:#e6edf6; padding:.7rem 1rem; border-radius:.8rem; cursor:pointer; font-weight:700; box-shadow:0 4px 16px rgba(0,0,0,.35)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-accent{background:linear-gradient(180deg,#0891b2,#0369a1); border-color:#0ea5b7}
  .btn-good{background:linear-gradient(180deg,#059669,#047857); border-color:#16a34a}
  .btn-bad{background:linear-gradient(180deg,#dc2626,#991b1b); border-color:#b91c1c}
  .field{display:flex;flex-direction:column;gap:.35rem}
  .input, select{background:#0c1424;border:1px solid #2a3850;border-radius:.6rem;color:#e6edf6;padding:.6rem .8rem}
  /* Layout */
  #app{height:100%;display:grid;grid-template-rows:auto 1fr}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:.6rem 1rem;border-bottom:1px solid #1b2a41;background:linear-gradient(180deg,#0e1626,#0b1220)}
  header .brand{font-weight:800;letter-spacing:.5px}
  header .res{display:flex;gap:12px;align-items:center}
  .pill{display:flex;gap:.4rem;align-items:center;background:#0c1424;border:1px solid #274063;border-radius:999px;padding:.35rem .6rem;font-weight:700}
  .dot{width:.6rem;height:.6rem;border-radius:50%}
  .r-food .dot{background:#fbbf24}
  .r-iron .dot{background:#94a3b8}
  .r-gold .dot{background:#f59e0b}
  .r-oil  .dot{background:#8b5cf6}
  header .right{display:flex;align-items:center;gap:.6rem}
  #stage{display:grid;grid-template-columns: 800px 1fr;gap:10px;padding:10px}
  #mapWrap{position:relative;width:800px;height:800px;border:1px solid #21314a;border-radius:12px;overflow:hidden;background:#07101a;box-shadow:0 20px 80px rgba(0,0,0,.4) inset}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;display:grid;grid-template-columns:repeat(20, var(--tile));grid-template-rows:repeat(20, var(--tile));}
  .tile{width:var(--tile);height:var(--tile);border:1px solid #0d1b25}
  .t-grass{background:linear-gradient(135deg,#0b3d2f,#0e513c)}
  .t-desert{background:linear-gradient(135deg,#5a4a25,#8b6f2a)}
  .t-water{background:linear-gradient(180deg,#0a2a4a,#0b3a6a)}
  .t-bridge{background:repeating-linear-gradient(90deg,#5b4632 0 6px,#7a5a42 6px 12px); box-shadow:inset 0 0 0 2px rgba(0,0,0,.2)}
  .t-mountain{background:linear-gradient(135deg,#3f4855,#2b313b)}
  .tile.overlay-limit::after{content:"2/2";position:absolute;transform:translate(4px,4px);font-size:10px;opacity:.6}
  /* Entities layer */
  #entities{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
  .unit,.building{position:absolute;transform:translate(-50%, -50%); pointer-events:auto}
  .unit{z-index:5}
  .building{z-index:3}
  .blip{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#0b1220;text-shadow:0 1px 0 rgba(255,255,255,.3)}
  .you{outline:2px solid #22d3ee; outline-offset:2px}
  .enemy{filter:drop-shadow(0 0 6px rgba(239,68,68,.5))}
  .hpbar{position:absolute;left:-16px;top:-22px;width:32px;height:5px;background:#1f2937;border:1px solid #000;border-radius:4px;overflow:hidden}
  .hpbar>i{display:block;height:100%;background:linear-gradient(90deg,#10b981,#84cc16)}
  .range-ring{position:absolute;border:1px dashed rgba(255,255,255,.35);border-radius:50%;pointer-events:none;transform:translate(-50%,-50%);background:radial-gradient(closest-side, rgba(147,197,253,.08), transparent)}
  /* Right panel */
  #ui{display:flex;flex-direction:column;gap:10px}
  .card{background:linear-gradient(180deg,#101a2c,#0e1626); border:1px solid #1d2b44; border-radius:12px; padding:10px; box-shadow:0 12px 48px rgba(0,0,0,.25)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .mini{font-size:12px;color:var(--muted)}
  .h{font-weight:800;letter-spacing:.3px;margin-bottom:6px}
  .tool{display:flex;flex-direction:column;gap:6px}
  .tool .btn{padding:.5rem .6rem;font-size:.9rem}
  .buildbar .btn{white-space:nowrap}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  /* Attack beam */
  svg#fx{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
  .beam{stroke:#fb923c;stroke-width:3;stroke-linecap:round;filter:drop-shadow(0 0 6px #fb923c)}
  /* Login modal */
  #gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 800px at 30% 10%,rgba(2,6,23,.9),rgba(2,6,23,.95) 60%,rgba(2,6,23,.98));z-index:1000}
  #gate .panel{width:min(720px,92vw);background:linear-gradient(180deg,#0e1626,#0b1220);border:1px solid #1c2a41;border-radius:16px;padding:18px 18px 14px;box-shadow:0 40px 140px rgba(0,0,0,.55)}
  #flags{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
  .flag{padding:.5rem .3rem;border:1px solid #22304a;border-radius:.8rem;background:#0c1424;cursor:pointer;text-align:center;font-size:20px}
  .flag.sel{outline:2px solid #22d3ee;outline-offset:2px}
  .room{display:flex;gap:8px}
  .code{font-weight:800;letter-spacing:1.2px;border:1px dashed #274063;border-radius:.6rem;padding:.4rem .6rem}
  #toast{position:fixed;right:14px;bottom:14px;background:#091320;border:1px solid #1b2a41;color:#e6edf6;padding:.6rem .8rem;border-radius:.6rem;box-shadow:0 14px 40px rgba(0,0,0,.35);display:none;z-index:1500}
  /* Context tips */
  #help{font-size:.9rem;color:#9fb2ca;line-height:1.3}
  #help b{color:#e6edf6}
  /* Prevent default ctx menu for gameplay */
  body.nocontext{ -webkit-touch-callout:none; -webkit-user-select:none; -khtml-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">🌐 Global RTS — <span class="mini">Tek Dosya Online Prototip</span></div>
    <div class="res">
      <div class="pill r-food"><i class="dot"></i><span id="rFood">0</span><span class="mini"> (+<span id="iFood">0</span>/dk)</span></div>
      <div class="pill r-iron"><i class="dot"></i><span id="rIron">0</span><span class="mini"> (+<span id="iIron">0</span>/dk)</span></div>
      <div class="pill r-gold"><i class="dot"></i><span id="rGold">0</span><span class="mini"> (+<span id="iGold">0</span>/dk)</span></div>
      <div class="pill r-oil"><i class="dot"></i><span id="rOil">0</span><span class="mini"> (+<span id="iOil">0</span>/dk)</span></div>
    </div>
    <div class="right">
      <span id="youName" class="mini">–</span>
      <span id="youFlag" style="font-size:18px">🏳️</span>
      <span id="roomCode" class="code">ROOM: –</span>
      <button id="btnLeave" class="btn btn-bad" title="Odadan ayrıl">Ayrıl</button>
    </div>
  </header>

  <div id="stage">
    <div id="mapWrap">
      <div id="grid"></div>
      <svg id="fx"></svg>
      <div id="entities"></div>
    </div>

    <div id="ui">
      <div class="card">
        <div class="h">İnşa Menüsü</div>
        <div class="grid3 buildbar" id="buildBar"></div>
        <div class="mini" id="bInfo">Seç: bir bina butonuna **sol tık**, sonra haritada kareye **sol tık** ile yerleştir (kare başına en fazla 2 bina).</div>
      </div>

      <div class="card">
        <div class="h">Seçim & Kontrol</div>
        <div class="tool">
          <div id="selInfo" class="mini">Hiçbir şey seçili değil.</div>
          <div class="row">
            <button id="btnStop" class="btn">Seçileni Durdur (çifte sağ tık)</button>
            <button id="btnDelete" class="btn">Seçileni Sil</button>
          </div>
          <div id="help">
            <p>• <b>Sol tık</b>: Birim/Bina seç, menzil halkasını gör.</p>
            <p>• <b>Sağ tık</b>: Birimleri hedef kareye <b>gönder</b> veya düşmana <b>saldır</b>.</p>
            <p>• <b>Çifte sağ tık</b>: Seçiliyi <b>durdur</b> (bekle).</p>
            <p>• Düşman menzile girerse otomatik ateş açılır; ateşler <b>turuncu ışın</b> olarak görünür.</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h">Üretim</div>
        <div class="mini">Bir <b>fabrika/üs</b> seç → altta üretim butonları çıkar.</div>
        <div id="produceBar" class="grid4"></div>
      </div>
    </div>
  </div>
</div>

<!-- Giriş / Oda -->
<div id="gate">
  <div class="panel">
    <h2 style="margin:0 0 6px 0">RTS Online — Giriş</h2>
    <div class="mini">İsmini ve bayrağını seç. Sonra oda oluştur veya koda girerek katıl.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
      <div class="field">
        <label>İsim</label>
        <input id="inpName" class="input" placeholder="Komutan adı" maxlength="18" />
      </div>
      <div class="field">
        <label>Ülke / Bayrak</label>
        <div id="flags"></div>
      </div>
    </div>
    <div class="room" style="margin-top:12px">
      <button id="btnCreate" class="btn btn-good">Oda Oluştur</button>
      <input id="inpJoin" class="input" placeholder="Oda Kodu" style="max-width:140px" />
      <button id="btnJoin" class="btn btn-accent">Katıl</button>
      <button id="btnTry" class="btn">Offline Dene</button>
    </div>
    <div id="gateMsg" class="mini" style="margin-top:8px;color:#9fb2ca"></div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
/* =========================
   Firebase Kurulumu
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCV609XeHMtmZtD3FZDJ0cQnDiXke4YlUs",
  authDomain: "globalrts-ea3b4.firebaseapp.com",
  databaseURL: "https://globalrts-ea3b4-default-rtdb.firebaseio.com",
  projectId: "globalrts-ea3b4",
  storageBucket: "globalrts-ea3b4.firebasestorage.app",
  messagingSenderId: "404807030737",
  appId: "1:404807030737:web:2efecfef884db0b58632f0",
  measurementId: "G-Q5YKGP8EXR"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getDatabase, ref, set, get, child, update, push, onValue, onDisconnect, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* =========================
   Basit Yardımcılar
   ========================= */
const $ = s => document.querySelector(s);
const el = (tag, cls, txt) => { const e = document.createElement(tag); if(cls) e.className=cls; if(txt) e.textContent=txt; return e; };
const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

function toast(msg,ms=2500){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",ms); }

/* =========================
   Global Oyun Durumu
   ========================= */
const TILE = 40, W=20, H=20; // 20x20 => 400 kare
const state = {
  uid:null, name:null, flag:"🇹🇷",
  room:null, owner:false, offline:false,
  resources:{food:200, iron:150, gold:100, oil:120},
  income:{food:0, iron:0, gold:0, oil:0}, // /dk
  selection:[], selectionType:null, // "unit" | "building"
  map:[], passable:[], // terrain + geçiş
  youColor:"#22d3ee", enemyColor:"#ef4444",
  lastRightClick:0
};

const FLAGS = ["🇹🇷","🇦🇿","🇺🇸","🇬🇧","🇩🇪","🇫🇷","🇪🇸","🇮🇹","🇷🇺","🇨🇳","🇯🇵","🇰🇷","🇸🇦","🇶🇦","🇦🇪","🇮🇶","🇮🇷","🇧🇷","🇦🇷","🇲🇽","🇪🇬","🇵🇰","🇮🇳","🇺🇦","🇵🇱","🇬🇷","🇳🇱","🇸🇪","🇳🇴","🇫🇮","🇨🇦","🇷🇴","🇧🇬","🇭🇷","🇷🇸","🇧🇦"];
let selFlag = FLAGS[0];

/* =========================
   ÜNİTE & BİNA TANIMLARI
   Not: değerler “gerçeğe orantılı” mantıkla normalize edilmiştir.
   Range = kare, speed = kare/sn, dps = hasar/sn
   ========================= */
const UNITS = {
  infantry:{name:"Piyade", hp:50, dps:5, range:2, speed:3, cost:{food:40, iron:10}, vs:"all", air:false, code:"INF", color:"#86efac"},
  mg:{name:"Mg. Piyade", hp:70, dps:7, range:3, speed:2.5, cost:{food:50, iron:15}, vs:"all", air:false, code:"MG", color:"#bbf7d0"},
  sniper:{name:"Keskin Nişancı", hp:45, dps:12, range:6, speed:2.8, cost:{food:45, iron:25, gold:10}, vs:"all", air:false, code:"SNP", color:"#a5b4fc"},
  rpg:{name:"Tanksavar", hp:50, dps:20, range:4, speed:2.5, cost:{food:50, iron:40}, vs:"armored", air:false, code:"RPG", color:"#fecaca"},
  apc:{name:"ZPT/APC", hp:200, dps:10, range:3, speed:4, cost:{iron:80, oil:40}, vs:"all", air:false, code:"APC", color:"#fde68a"},
  ifv:{name:"ZMA/IFV", hp:220, dps:14, range:4, speed:4.2, cost:{iron:110, oil:60}, vs:"all", air:false, code:"IFV", color:"#fcd34d"},
  mbt:{name:"Ana Muh.Tankı", hp:500, dps:35, range:5, speed:3.2, cost:{iron:200, oil:120, gold:40}, vs:"armored", air:false, code:"MBT", color:"#fbbf24"},
  spg:{name:"Kundağ. Obüs", hp:180, dps:45, range:8, speed:2.8, cost:{iron:150, oil:90, gold:20}, vs:"ground", air:false, code:"SPG", color:"#fb923c"},
  mlrs:{name:"ÇNRA/MLRS", hp:150, dps:60, range:10, speed:3, cost:{iron:180, oil:120, gold:50}, vs:"ground", air:false, code:"MLRS", color:"#f97316"},
  aaa:{name:"Uçaksavar", hp:180, dps:30, range:5, speed:3, cost:{iron:130, oil:70}, vs:"air", air:false, code:"AAA", color:"#93c5fd"},
  sam:{name:"SAM Bataryası", hp:200, dps:55, range:9, speed:2.8, cost:{iron:160, oil:120, gold:60}, vs:"air", air:false, code:"SAM", color:"#60a5fa"},
  heli:{name:"Taarruz Hel.", hp:250, dps:30, range:5, speed:7, cost:{iron:140, oil:150, gold:40}, vs:"ground", air:true, code:"HEL", color:"#86efac"},
  fighter:{name:"Avcı Uçağı", hp:200, dps:45, range:7, speed:10, cost:{iron:160, oil:180, gold:80}, vs:"air", air:true, code:"FTR", color:"#67e8f9"},
  bomber:{name:"Bombardıman", hp:300, dps:80, range:6, speed:8, cost:{iron:220, oil:220, gold:120}, vs:"ground", air:true, code:"BOM", color:"#38bdf8"},
  ucav:{name:"SİHA/UCAV", hp:160, dps:35, range:8, speed:7, cost:{iron:120, oil:140, gold:60}, vs:"ground", air:true, code:"UAV", color:"#a7f3d0"},
  recon:{name:"Keşif İHA", hp:80, dps:0, range:0, speed:8, cost:{iron:60, oil:80}, vs:"none", air:true, code:"REC", color:"#c7d2fe"}
};

const BUILDINGS = {
  hq:{name:"Merkez Üs", hp:1200, cost:{iron:0, food:0, gold:0, oil:0}, prod: null, produces:[], tag:"center"},
  mill:{name:"Değirmen", hp:400, cost:{iron:40, food:60}, prod:{food:+5}, produces:[], tag:"eco"},
  refinery:{name:"Rafineri", hp:420, cost:{iron:80, gold:10}, prod:{oil:+4}, produces:[], tag:"eco"},
  ironmine:{name:"Demir Madeni", hp:420, cost:{food:30}, prod:{iron:+3}, produces:[], tag:"eco"},
  goldmine:{name:"Altın Madeni", hp:380, cost:{iron:40, food:20}, prod:{gold:+2}, produces:[], tag:"eco"},
  barracks:{name:"Asker Kışlası", hp:500, cost:{iron:80, food:80}, prod:null, produces:["infantry","mg","sniper","rpg"], tag:"prod"},
  tankfac:{name:"Tank Fabrikası", hp:650, cost:{iron:200, oil:120, gold:40}, prod:null, produces:["apc","ifv","mbt","spg","mlrs"], tag:"prod"},
  missilefac:{name:"Füze Fabrikası", hp:600, cost:{iron:180, oil:150, gold:80}, prod:null, produces:["mlrs","sam"], tag:"prod"},
  airbase:{name:"Hava Üssü", hp:650, cost:{iron:300, oil:300, gold:150}, prod:null, produces:["fighter","bomber","heli"], tag:"prod"},
  siha:{name:"SİHA Merkezi", hp:520, cost:{iron:120, oil:200, gold:100}, prod:null, produces:["ucav","recon"], tag:"prod"},
  aafac:{name:"Hava Savunma Ürt.", hp:520, cost:{iron:140, oil:120}, prod:null, produces:["aaa","sam"], tag:"prod"},
  wall:{name:"Sur", hp:300, cost:{iron:30}, prod:null, produces:[], tag:"def"}
};

const BUILD_ICONS = {
  hq:"🏰", mill:"🌾", refinery:"🛢️", ironmine:"⛏️", goldmine:"🪙",
  barracks:"🎖️", tankfac:"🏭", missilefac:"🚀", airbase:"✈️", siha:"🛩️", aafac:"🛡️", wall:"🧱"
};
const UNIT_ICONS = { infantry:"👤", mg:"🧍‍♂️", sniper:"🎯", rpg:"💥", apc:"🚐", ifv:"🚙", mbt:"🛡️", spg:"🧨", mlrs:"🚀", aaa:"🎯", sam:"🎯", heli:"🚁", fighter:"🛩️", bomber:"🛫", ucav:"🛸", recon:"📡" };

/* =========================
   Arayüz Kurulum
   ========================= */
function setupFlags(){
  const box=$("#flags"); box.innerHTML="";
  FLAGS.forEach(f=>{
    const b=el("button","flag"); b.textContent=f;
    if(f===selFlag) b.classList.add("sel");
    b.onclick=()=>{ selFlag=f; [...box.children].forEach(c=>c.classList.remove("sel")); b.classList.add("sel"); };
    box.appendChild(b);
  });
}
setupFlags();

function setResUI(){
  $("#rFood").textContent = Math.floor(state.resources.food);
  $("#rIron").textContent = Math.floor(state.resources.iron);
  $("#rGold").textContent = Math.floor(state.resources.gold);
  $("#rOil").textContent  = Math.floor(state.resources.oil);
  $("#iFood").textContent = state.income.food;
  $("#iIron").textContent = state.income.iron;
  $("#iGold").textContent = state.income.gold;
  $("#iOil").textContent  = state.income.oil;
}
setResUI();

/* =========================
   Harita Üretimi (20x20)
   Deniz, köprü, çöl, dağ
   ========================= */
function genMap(seed=Date.now()){
  const map=[], pass=[];
  // temel çim
  for(let y=0;y<H;y++){ const row=[], prow=[]; for(let x=0;x<W;x++){ row.push("grass"); prow.push(true);} map.push(row); pass.push(prow);}
  // yatay nehir (su bandı)
  for(let x=0;x<W;x++){ map[9][x]="water"; map[10][x]="water"; pass[9][x]=false; pass[10][x]=false; }
  // köprüler
  [3,10,16].forEach(x=>{ map[9][x]="bridge"; map[10][x]="bridge"; pass[9][x]=true; pass[10][x]=true; });
  // sol sahil (deniz)
  for(let y=0;y<H;y++){ map[y][0]="water"; pass[y][0]=false; if(y%2===0){ map[y][1]="water"; pass[y][1]=false; } }
  // çöl alanı (sağ üst 7x7)
  for(let y=0;y<7;y++) for(let x=13;x<W;x++){ map[y][x]="desert"; }
  // dağ şeritleri
  for(let y=3;y<17;y+=3) for(let x=5;x<8;x++){ map[y][x]="mountain"; pass[y][x]=false; }
  state.map=map; state.passable=pass;
}
function drawGrid(){
  const grid=$("#grid"); grid.innerHTML="";
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const t=el("div",`tile t-${state.map[y][x]}`); t.dataset.x=x; t.dataset.y=y; grid.appendChild(t);
    }
  }
}
genMap(); drawGrid();

/* =========================
   Entities Render
   ========================= */
const entities=$("#entities");
const fx=$("#fx");

function tileToPx(x,y){ return {px:x*TILE+TILE/2, py:y*TILE+TILE/2}; }
function putRangeRing(id, x,y, range){
  let r = document.getElementById("ring-"+id);
  const {px,py} = tileToPx(x,y);
  const rad = range*TILE;
  if(!r){ r = el("div","range-ring"); r.id="ring-"+id; entities.appendChild(r); }
  r.style.left = px+"px"; r.style.top = py+"px"; r.style.width = (rad*2)+"px"; r.style.height = (rad*2)+"px";
}
function clearRings(){ [...entities.querySelectorAll(".range-ring")].forEach(e=>e.remove()); }
function drawBeam(x1,y1,x2,y2){
  const line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1",x1); line.setAttribute("y1",y1); line.setAttribute("x2",x2); line.setAttribute("y2",y2);
  line.setAttribute("class","beam"); line.style.opacity="1";
  fx.appendChild(line);
  setTimeout(()=>{ line.style.transition="opacity .25s"; line.style.opacity="0"; setTimeout(()=>line.remove(),260); }, 80);
}

/* =========================
   Oda & RTDB
   ========================= */
const roomPath = (path="")=>`rooms/${state.room}${path?"/"+path:""}`;

async function ensureAnon(){
  try{
    const cred = await signInAnonymously(auth);
    return cred.user.uid;
  }catch(e){
    const msg = e.code==="auth/operation-not-allowed"
      ? "Firebase Anonymous Auth kapalı görünüyor. Konsol > Authentication > Sign-in method > Anonymous: ENABLE yapın."
      : (e.code==="auth/admin-restricted-operation" ? "Auth/Admin restricted operation: Yetkisiz işlem. (Kullanıcı oluşturma vb. Admin işlemleri yapmayın.)" : e.message);
    $("#gateMsg").textContent = msg;
    throw e;
  }
}

function code5(){ const a="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<5;i++) s+=a[rnd(0,a.length-1)]; return s; }

async function createRoom(){
  if(!state.name) return toast("İsim yaz.");
  const uid = state.uid || await ensureAnon(); state.uid=uid;
  const code = code5();
  state.room = code; state.owner = true;
  const mapPayload = { map:state.map, createdAt: Date.now(), status:"lobby" };
  await set(ref(db, roomPath()), mapPayload);
  await set(ref(db, roomPath(`players/${uid}`)), {name:state.name, flag:state.flag, uid, joinedAt:Date.now()});
  onDisconnect(ref(db, roomPath(`players/${uid}`))).remove();
  bindRoom();
  gateClose();
}

async function joinRoom(code){
  if(!code) return toast("Kod gir.");
  if(!state.name) return toast("İsim yaz.");
  const uid = state.uid || await ensureAnon(); state.uid=uid;
  state.room = code.toUpperCase();
  const snap = await get(ref(db, roomPath()));
  if(!snap.exists()) return toast("Oda bulunamadı.");
  await set(ref(db, roomPath(`players/${uid}`)), {name:state.name, flag:state.flag, uid, joinedAt:Date.now()});
  onDisconnect(ref(db, roomPath(`players/${uid}`))).remove();
  state.owner = (snap.val().owner === uid);
  bindRoom();
  gateClose();
}

function bindRoom(){
  $("#roomCode").textContent = "ROOM: " + state.room;
  // Units
  onValue(ref(db, roomPath("units")), s=>{
    const all = s.val()||{};
    renderUnits(all);
  });
  // Buildings
  onValue(ref(db, roomPath("buildings")), s=>{
    const all = s.val()||{};
    renderBuildings(all);
    recomputeIncome(all);
  });
  // Owner ataması
  onValue(ref(db, roomPath()), s=>{
    const v = s.val()||{};
    if(!v.owner && state.owner){ update(ref(db, roomPath()), {owner:state.uid}); }
    if(v.map && !state.offline){ state.map=v.map; drawGrid(); }
  });
}

function gateClose(){
  $("#gate").style.display="none";
  $("#youName").textContent = state.name;
  $("#youFlag").textContent = state.flag;
  document.body.classList.add("nocontext");
}

/* =========================
   Oyun Mekaniği – RTDB Nesneleri
   ========================= */
let unitsCache={}, buildingsCache={};

function renderUnits(all){
  unitsCache = all;
  // temizle ve yeniden çiz
  [...entities.querySelectorAll(".unit")].forEach(e=>e.remove());
  Object.entries(all).forEach(([id,u])=>{
    const {px,py} = tileToPx(u.x,u.y);
    const e = el("div","unit"); e.style.left=px+"px"; e.style.top=py+"px"; e.dataset.id=id; e.dataset.kind="unit";
    const bl = el("div","blip"); bl.textContent = UNIT_ICONS[u.type] || "⬛";
    bl.style.background = u.owner===state.uid ? state.youColor : state.enemyColor;
    bl.title = `${UNITS[u.type]?.name||u.type} — HP ${u.hp}`;
    const hp = el("div","hpbar"); const bar=el("i"); bar.style.width = (u.hp/ (UNITS[u.type]?.hp||100) * 100)+"%"; hp.appendChild(bar);
    e.appendChild(bl); e.appendChild(hp);
    e.onclick = (ev)=>{ ev.stopPropagation(); selectUnit(id); };
    entities.appendChild(e);
  });
  updateSelectionUI();
}
function renderBuildings(all){
  buildingsCache = all;
  // çiz
  [...entities.querySelectorAll(".building")].forEach(e=>e.remove());
  for(const [id,b] of Object.entries(all)){
    const {px,py} = tileToPx(b.x,b.y);
    const e = el("div","building"); e.style.left=px+"px"; e.style.top=py+"px"; e.dataset.id=id; e.dataset.kind="building";
    const bl = el("div","blip"); bl.textContent = BUILD_ICONS[b.type]||"■";
    bl.style.background = b.owner===state.uid ? "#0ea5b7" : "#ef4444";
    bl.title = `${BUILDINGS[b.type]?.name||b.type} — HP ${b.hp}`;
    const hp = el("div","hpbar"); const bar=el("i"); bar.style.width = (b.hp/(BUILDINGS[b.type]?.hp||500)*100)+"%"; hp.appendChild(bar);
    e.appendChild(bl); e.appendChild(hp);
    e.onclick = (ev)=>{ ev.stopPropagation(); selectBuilding(id); };
    entities.appendChild(e);
  }
  updateSelectionUI();
}

/* =========================
   İnşa & Üretim
   ========================= */
let pendingBuild=null; // {type}
function canAfford(cost){ for(const k in cost){ if((state.resources[k]||0) < cost[k]) return false; } return true; }
function pay(cost){ for(const k in cost){ state.resources[k]=(state.resources[k]||0)- (cost[k]||0); } setResUI(); }

function recomputeIncome(buildings){
  const inc = {food:0, iron:0, gold:0, oil:0};
  Object.values(buildings||{}).forEach(b=>{
    if(b.owner!==state.uid) return;
    const prod = BUILDINGS[b.type]?.prod;
    if(prod) for(const k in prod) inc[k]+=prod[k];
  });
  state.income = inc; setResUI();
}

// Kaynak tick (her saniye)
setInterval(()=>{
  const dt = 1/60; // dk bazında (1s = 1/60 dk)
  for(const k of ["food","iron","gold","oil"]) state.resources[k]+= (state.income[k]||0)*dt;
  setResUI();
},1000);

// Build menüsü
function refreshBuildBar(){
  const bar=$("#buildBar"); bar.innerHTML="";
  Object.entries(BUILDINGS).forEach(([key,b])=>{
    if(key==="hq") return; // manual spawn
    const btn = el("button","btn");
    const costStr = Object.entries(b.cost||{}).map(([k,v])=>`${k}:${v}`).join(" ");
    btn.innerHTML = `${BUILD_ICONS[key]||"■"} ${b.name}<br><span class="mini">${costStr||"ücretsiz"}</span>`;
    btn.onclick=()=>{
      if(!canAfford(b.cost||{})) return toast("Kaynak yetersiz!");
      pendingBuild={type:key}; toast(`${b.name} yerleştirmek için haritada kareye sol tıkla.`);
    };
    bar.appendChild(btn);
  });
}
refreshBuildBar();

function tileId(x,y){ return `${x}_${y}`; }
function tileBuildingCount(x,y){
  let c=0; for(const b of Object.values(buildingsCache||{})) if(b.x===x && b.y===y) c++;
  return c;
}

$("#grid").addEventListener("click", async (ev)=>{
  const t = ev.target.closest(".tile"); if(!t) return;
  const x = +t.dataset.x, y=+t.dataset.y;
  if(pendingBuild){
    if(tileBuildingCount(x,y)>=2) return toast("Bu kare dolu (2/2).");
    if(!state.passable[y][x] && pendingBuild.type!=="wall") return toast("Bu zemin uygun değil.");
    const def = BUILDINGS[pendingBuild.type];
    if(!canAfford(def.cost||{})) return toast("Kaynak yetersiz!");
    pay(def.cost||{});
    const id = push(ref(db, roomPath("buildings"))).key;
    await set(ref(db, roomPath(`buildings/${id}`)), {id, type:pendingBuild.type, x, y, hp:def.hp, owner:state.uid, createdAt:Date.now()});
    pendingBuild=null;
  }else{
    // boş yere sol tık: seçim temizle
    clearSelection();
  }
});

function selectBuilding(id){
  state.selection=[id]; state.selectionType="building"; updateSelectionUI();
  const b = buildingsCache[id]; clearRings(); if(b){ const r = 2; putRangeRing("b-"+id, b.x, b.y, r); }
  // Üretim barını doldur
  const bar=$("#produceBar"); bar.innerHTML="";
  const def = BUILDINGS[b?.type]; if(!def) return;
  if(def.produces?.length){
    def.produces.forEach(uid=>{
      const ud=UNITS[uid]; const btn=el("button","btn");
      const costStr = Object.entries(ud.cost||{}).map(([k,v])=>`${k}:${v}`).join(" ");
      btn.innerHTML = `${UNIT_ICONS[uid]} ${ud.name}<br><span class="mini">${costStr}</span>`;
      btn.onclick=()=>spawnUnitFromBuilding(id, uid);
      bar.appendChild(btn);
    });
  }
}
function selectUnit(id){
  state.selection=[id]; state.selectionType="unit"; updateSelectionUI();
  const u = unitsCache[id]; clearRings(); if(u){ const ud=UNITS[u.type]; putRangeRing("u-"+id, u.x, u.y, ud.range); }
}
function clearSelection(){
  state.selection=[]; state.selectionType=null; $("#produceBar").innerHTML=""; clearRings(); updateSelectionUI();
}
function updateSelectionUI(){
  const s = $("#selInfo");
  if(state.selectionType==="unit"){
    const u = unitsCache[state.selection[0]];
    if(!u){ s.textContent="Seçili birim yok."; return;}
    const ud=UNITS[u.type];
    s.textContent = `Birim: ${ud.name} | HP ${u.hp}/${ud.hp} | DPS ${ud.dps} | Menzil ${ud.range} | Hız ${ud.speed}`;
  }else if(state.selectionType==="building"){
    const b = buildingsCache[state.selection[0]];
    if(!b){ s.textContent="Seçili bina yok."; return;}
    const bd=BUILDINGS[b.type];
    s.textContent = `Bina: ${bd.name} | HP ${b.hp}/${bd.hp}` + (bd.prod?` | Üretim: ${Object.entries(bd.prod).map(([k,v])=>`${k}+${v}/dk`).join(", ")}`:"");
  }else{
    s.textContent="Hiçbir şey seçili değil.";
  }
}

async function spawnUnitFromBuilding(buildId, unitType){
  const b = buildingsCache[buildId]; if(!b) return;
  if(b.owner!==state.uid) return toast("Sadece kendi binandan üretirsin.");
  const def = UNITS[unitType]; if(!def) return;
  if(!canAfford(def.cost||{})) return toast("Kaynak yetersiz!");
  pay(def.cost||{});
  const spawnX = clamp(b.x + rnd(-1,1), 0, W-1), spawnY = clamp(b.y + rnd(-1,1), 0, H-1);
  const id = push(ref(db, roomPath("units"))).key;
  await set(ref(db, roomPath(`units/${id}`)), {
    id, type:unitType, x:spawnX, y:spawnY, hp:def.hp, owner:state.uid,
    dest:null, target:null, lastAtk:0, createdAt:Date.now()
  });
}

/* =========================
   Giriş butonları
   ========================= */
$("#btnCreate").onclick = async ()=>{
  const name = $("#inpName").value.trim(); if(!name) return toast("İsim yaz.");
  state.name=name; state.flag=selFlag;
  try{ await ensureAnon(); }catch(e){ return; }
  await createRoom();
};
$("#btnJoin").onclick = async ()=>{
  const name = $("#inpName").value.trim(); if(!name) return toast("İsim yaz.");
  state.name=name; state.flag=selFlag;
  try{ await ensureAnon(); }catch(e){ return; }
  await joinRoom($("#inpJoin").value.trim());
};
$("#btnTry").onclick = ()=>{
  const name = $("#inpName").value.trim(); if(!name) return toast("İsim yaz.");
  state.name=name; state.flag=selFlag; state.offline=true; state.room="OFFLINE"; state.owner=true; gateClose(); $("#roomCode").textContent="ROOM: offline";
  // offline HQ ver
  addHQForOffline();
};
$("#btnLeave").onclick = async ()=>{
  if(!state.room || state.offline){ location.reload(); return; }
  try{ await remove(ref(db, roomPath(`players/${state.uid}`))); }catch(e){}
  location.reload();
};

/* =========================
   Başlangıç Üsleri (HQ)
   Oda sahibi başlatır, offline’da otomatik
   ========================= */
async function ensureHQ(){
  // Oyuncuya HQ yoksa bir köşe ver
  const hasMine = Object.values(buildingsCache||{}).some(b=>b.owner===state.uid && b.type==="hq");
  if(hasMine) return;
  const corners = [{x:1,y:1},{x:18,y:1},{x:1,y:18},{x:18,y:18}];
  const spot = corners[rnd(0,corners.length-1)];
  const id = push(ref(db, roomPath("buildings"))).key;
  await set(ref(db, roomPath(`buildings/${id}`)), {id, type:"hq", x:spot.x, y:spot.y, hp:BUILDINGS.hq.hp, owner:state.uid, createdAt:Date.now()});
}
async function addHQForOffline(){
  renderBuildings(buildingsCache);
  const id = "hq_me";
  buildingsCache[id] = {id, type:"hq", x:1, y:1, hp:BUILDINGS.hq.hp, owner:"ME"};
  renderBuildings(buildingsCache);
}

/* =========================
   Sağ Tık — Hareket / Saldırı
   ========================= */
document.addEventListener("contextmenu", e=>e.preventDefault());

$("#mapWrap").addEventListener("mousedown", (ev)=>{
  if(ev.button===2){ // right
    const now = Date.now();
    const dbl = (now - state.lastRightClick) < 300;
    state.lastRightClick = now;
    const rect = $("#grid").getBoundingClientRect();
    const x = clamp(Math.floor((ev.clientX-rect.left)/TILE),0,W-1);
    const y = clamp(Math.floor((ev.clientY-rect.top)/TILE),0,H-1);
    if(state.selectionType==="unit" && state.selection.length){
      if(dbl){ // stop
        state.selection.forEach(id=>{ issueStop(id); });
        toast("Dur emri verildi.");
      }else{
        const enemy = findEnemyAt(x,y);
        if(enemy){ state.selection.forEach(id=>issueAttack(id, enemy)); }
        else { state.selection.forEach(id=>issueMove(id,x,y)); }
      }
    }
  }
});

function findEnemyAt(x,y){
  for(const u of Object.values(unitsCache||{})) if(u.x===x && u.y===y && u.owner!==state.uid) return {kind:"unit", id:u.id};
  for(const b of Object.values(buildingsCache||{})) if(b.x===x && b.y===y && b.owner!==state.uid) return {kind:"building", id:b.id};
  return null;
}
async function issueMove(id,x,y){
  const u = unitsCache[id]; if(!u || u.owner!==state.uid) return;
  await update(ref(db, roomPath(`units/${id}`)), {dest:{x,y}, target:null});
}
async function issueAttack(id, target){
  const u = unitsCache[id]; if(!u || u.owner!==state.uid) return;
  await update(ref(db, roomPath(`units/${id}`)), {target, dest:null});
}
async function issueStop(id){
  const u = unitsCache[id]; if(!u || u.owner!==state.uid) return;
  await update(ref(db, roomPath(`units/${id}`)), {dest:null, target:null});
}

/* =========================
   Basit Simülasyon Döngüsü
   Sadece KENDİ ünitelerini hareket ettir ve ateş ettir.
   ========================= */
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function passableFor(u, x,y){
  // hava birimleri her yere uçabilir, kara birimleri su ve dağa giremez (köprü hariç)
  const t = state.map[y][x];
  if(UNITS[u.type].air) return true;
  if(t==="water") return false;
  if(t==="mountain") return false;
  return true;
}
function stepToward(u, goal){
  if(!goal) return {x:u.x, y:u.y};
  const dx = goal.x - u.x, dy = goal.y - u.y;
  let nx = u.x + Math.sign(dx)* (UNITS[u.type].speed/10); // 10 tick ~ 1 sn
  let ny = u.y + Math.sign(dy)* (UNITS[u.type].speed/10);
  // Kare sınırına oturt
  nx = clamp(nx, 0, W-1); ny = clamp(ny, 0, H-1);
  // Geçiş kontrol (basit): hedef kareye yaklaşırken engelse dur
  const tx = Math.round(nx), ty = Math.round(ny);
  if(!passableFor(u, tx, ty)) return {x:u.x, y:u.y};
  return {x:nx, y:ny};
}

async function applyDamage(entity, dmg){
  if(!entity) return;
  if(entity.kind==="unit"){
    const u = unitsCache[entity.id]; if(!u) return;
    const hp = Math.max(0, u.hp - dmg);
    await update(ref(db, roomPath(`units/${entity.id}`)), {hp});
    if(hp<=0) await remove(ref(db, roomPath(`units/${entity.id}`)));
  }else{
    const b = buildingsCache[entity.id]; if(!b) return;
    const hp = Math.max(0, b.hp - dmg);
    await update(ref(db, roomPath(`buildings/${entity.id}`)), {hp});
    if(hp<=0) await remove(ref(db, roomPath(`buildings/${entity.id}`)));
  }
}

function enemyListFor(u){
  const list=[];
  for(const [id,o] of Object.entries(unitsCache||{})) if(o.owner!==state.uid) list.push({kind:"unit", id, x:o.x, y:o.y});
  for(const [id,o] of Object.entries(buildingsCache||{})) if(o.owner!==state.uid) list.push({kind:"building", id, x:o.x, y:o.y});
  return list;
}

setInterval(async ()=>{
  // Her 100ms: kendi ünitelerini sür
  for(const [id,u] of Object.entries(unitsCache||{})){
    if(u.owner!==state.uid) continue;
    const def = UNITS[u.type]; if(!def) continue;

    // Oto-hedef: menzile en yakın düşman
    const enemies = enemyListFor(u);
    let target = u.target;
    if(!target){
      let best=null, bestD=1e9;
      enemies.forEach(e=>{
        const d = Math.hypot((e.x - u.x), (e.y - u.y));
        if(d<=def.range && d<bestD){
          // hava/yer uygunluk kontrolü
          const isAir = (e.kind==="unit") ? (UNITS[unitsCache[e.id]?.type]?.air===true) : false;
          if(def.vs==="air" && !isAir) return;
          if(def.vs==="ground" && isAir) return;
          best=e; bestD=d;
        }
      });
      if(best) await update(ref(db, roomPath(`units/${id}`)), {target:{kind:best.kind,id:best.id}});
    }

    const me = unitsCache[id]; // güncel oku
    if(!me) continue;

    // Hareket
    if(me.dest){
      const next = stepToward(me, me.dest);
      await update(ref(db, roomPath(`units/${id}`)), {x:next.x, y:next.y});
      // hedefe ulaştı?
      if(Math.hypot(next.x - me.dest.x, next.y - me.dest.y) < 0.1) await update(ref(db, roomPath(`units/${id}`)), {dest:null});
    }

    // Saldırı
    if(me.target){
      const tgt = me.target.kind==="unit" ? unitsCache[me.target.id] : buildingsCache[me.target.id];
      if(!tgt){ await update(ref(db, roomPath(`units/${id}`)), {target:null}); continue; }
      // uygun kategori?
      const isAir = (me.target.kind==="unit") ? (UNITS[tgt.type]?.air===true) : false;
      if(def.vs==="air" && !isAir){ await update(ref(db, roomPath(`units/${id}`)), {target:null}); continue; }
      if(def.vs==="ground" && isAir){ await update(ref(db, roomPath(`units/${id}`)), {target:null}); continue; }
      const d = Math.hypot((tgt.x - me.x),(tgt.y - me.y));
      if(d <= def.range){
        // ateş et — dps/10 hasar
        const {px:ax,py:ay}=tileToPx(me.x,me.y);
        const {px:bx,py:by}=tileToPx(tgt.x,tgt.y);
        drawBeam(ax,ay,bx,by);
        await applyDamage(me.target, def.dps/10);
      }else{
        // hedefe yaklaş
        const goal = {x:tgt.x, y:tgt.y};
        const next = stepToward(me, goal);
        await update(ref(db, roomPath(`units/${id}`)), {x:next.x, y:next.y});
      }
    }
  }
},100);

/* =========================
   Başlangıç ve ufak bağlamlar
   ========================= */
$("#grid").addEventListener("mousedown", ev=>{
  if(ev.button===0){ // left
    const t = ev.target.closest(".tile"); if(!t) return;
    clearRings();
    // kareyi tıklayınca, oradaki kendi birimi varsa seç
    const x=+t.dataset.x,y=+t.dataset.y;
    let picked=null;
    for(const [id,u] of Object.entries(unitsCache||{})) if(u.x===x && u.y===y){ picked={id,owner:u.owner}; break; }
    if(picked){ if(picked.owner===state.uid) selectUnit(picked.id); else clearSelection(); return; }
    // yoksa bina?
    for(const [id,b] of Object.entries(buildingsCache||{})) if(b.x===x && b.y===y){ if(b.owner===state.uid) selectBuilding(id); else clearSelection(); return; }
    clearSelection();
  }
});

// “Seçileni durdur” ve “sil”
$("#btnStop").onclick = ()=>{ if(state.selectionType==="unit") state.selection.forEach(id=>issueStop(id)); };
$("#btnDelete").onclick = async ()=>{
  if(state.selectionType==="unit"){
    for(const id of state.selection){ const u=unitsCache[id]; if(u?.owner===state.uid) await remove(ref(db, roomPath(`units/${id}`))); }
  }else if(state.selectionType==="building"){
    for(const id of state.selection){ const b=buildingsCache[id]; if(b?.owner===state.uid) await remove(ref(db, roomPath(`buildings/${id}`))); }
  }
  clearSelection();
};

/* =========================
   Oyun açılırken kendi HQ’nu güvenceye al
   ========================= */
onAuthStateChanged(auth, async (user)=>{
  if(user){ state.uid=user.uid; }
});

/* Oda açıldıktan 2 sn sonra HQ yoksa otomatik iste */
setInterval(()=>{ if(state.room && !state.offline) ensureHQ(); }, 2000);

/* =========================
   Küçük Kalite İyileştirmeler
   ========================= */
window.addEventListener("resize", ()=>{ /* sabit piksel grid; boş */ });

/* İlk yüklemede bilgiler */
$("#gateMsg").textContent = "İpucu: Anonim giriş açık değilse Firebase Konsolundan aktif edin. Sonra oda oluşturup başlayın.";
</script>
</body>
</html>
