<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RTS — Modern Combined Arms (Canvas)</title>
<style>
  :root{ --bg:#0b1220; --panel:#111A2B; --text:#E6EDF6; --accent:#34d399; --blue:#60a5fa; --warn:#f59e0b; --bad:#ef4444 }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  #app{height:100%;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{background:linear-gradient(180deg,rgba(17,26,43,.85),rgba(11,18,32,.85));border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
  header{position:sticky;top:0;z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:.6rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  .hud{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .55rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:12px}
  .btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:var(--text);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .panel{position:absolute;z-index:5;background:linear-gradient(180deg,rgba(17,26,43,.85),rgba(11,18,32,.85));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
  .left{left:10px;top:10px;width:340px} .right{right:10px;top:10px;width:360px}
  #game{display:block;width:100%;height:100%;background:
    radial-gradient(800px 600px at 30% 20%, rgba(99,102,241,.06), transparent 70%),
    radial-gradient(900px 700px at 70% 70%, rgba(34,197,94,.06), transparent 72%),
    linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px),
    linear-gradient(0deg, rgba(255,255,255,.03) 1px, transparent 1px);
    background-size:cover,cover, 40px 40px, 40px 40px;
  }
  #hint{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.4rem .7rem;border-radius:10px;z-index:6;font-size:13px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .small{font-size:12px;opacity:.8}
  .list{font-size:12px;max-height:180px;overflow:auto;line-height:1.6}
  .kps{width:120px}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="wrap">
      <div><b>GLOBAL RTS</b> — Modern Combined Arms</div>
      <div class="hud">
        <span class="pill">🍞 <b id="food">0</b></span>
        <span class="pill">🛢️ <b id="oil">0</b></span>
        <span class="pill">⛓️ <b id="iron">0</b></span>
        <span class="pill">🪖 <b id="uInf">0</b></span>
        <span class="pill">🚛 <b id="uAPC">0</b></span>
        <span class="pill">🛡️ <b id="uTank">0</b></span>
        <span class="pill">🎯 <b id="uHIMARS">0</b></span>
        <span class="pill">🛩️ <b id="uFighter">0</b></span>
        <span class="pill">🛫 <b id="uBomber">0</b></span>
        <div class="pill" style="gap:.5rem">
          ⏩ <input id="speed" type="range" min="1" max="100" value="1" class="kps">
          <b id="spdLbl">1x</b>
          <button class="btn" data-s="1">1x</button><button class="btn" data-s="5">5x</button><button class="btn" data-s="10">10x</button><button class="btn" data-s="50">50x</button><button class="btn" data-s="100">100x</button>
        </div>
        <button id="newGame" class="btn">↻ Yeni Oyun</button>
        <button id="help" class="btn">❔ Yardım</button>
      </div>
    </div>
  </header>

  <main style="position:relative">
    <canvas id="game"></canvas>
    <div class="panel left">
      <div style="font-weight:700;opacity:.8;margin-bottom:6px">İnşa Et</div>
      <div class="grid2" id="buildBtns">
        <!-- doldurulacak -->
      </div>
      <div style="font-weight:700;opacity:.8;margin:10px 0 6px">Üret (Seçili Bina)</div>
      <div id="prod" class="grid2 small"><div style="opacity:.7">Bir bina seçin…</div></div>
      <div style="margin-top:8px" class="small">
        <div><b>Seçim</b>: Sol tık • <b>Kare seçim</b>: Sol sürükle</div>
        <div><b>Hareket</b>: Sağ tık zemin • <b>Saldır</b>: Sağ tık düşman</div>
      </div>
    </div>

    <div class="panel right">
      <div style="font-weight:700;opacity:.8;margin-bottom:6px">Günlük</div>
      <div id="log" class="list"></div>
    </div>

    <div id="hint">Yükleniyor…</div>
  </main>

  <footer>
    <div class="wrap" style="justify-content:center;font-size:12px;opacity:.8">Mouse-only • Kare seçim • Otomatik saldırı • Gerçek isimli üniteler • 1–100x hız</div>
  </footer>
</div>

<!-- Yardım Modal -->
<div id="modal" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);z-index:9999">
  <div style="background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:720px;font-size:14px">
    <div style="font-weight:700;margin-bottom:8px">Nasıl Oynanır?</div>
    <ul style="margin:0;padding-left:18px;line-height:1.7">
      <li>Soldan bina seç, haritaya tıkla: 10 sn’de kurulur (kışla/değirmen/rafineri/maden/fabrikalar).</li>
      <li>Bir bina seçince sağ panelde uygun birimler çıkar (maliyet yazar). Tıkla → üret.</li>
      <li>Sol tık seç, sürükle → kare seçim. Sağ tık zemin → hareket. Sağ tık düşman → saldır.</li>
      <li>Seçili birimde menzil halkası görünür; menzile giren düşmana otomatik ateş eder.</li>
      <li>Hız kaydırıcısı: 1–100x.</li>
    </ul>
    <div style="text-align:right;margin-top:10px"><button class="btn" onclick="document.getElementById('modal').style.display='none'">Kapat</button></div>
  </div>
</div>

<script>
(()=>{
// ====== Canvas Boot ======
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
function resize(){ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
window.addEventListener('resize', resize); resize();

const hintEl=document.getElementById('hint'), logEl=document.getElementById('log');
function hint(s){ hintEl.textContent=s; }
function log(s){ const d=document.createElement('div'); d.textContent=s; logEl.prepend(d); }

document.getElementById('help').onclick=()=> document.getElementById('modal').style.display='grid';
document.getElementById('newGame').onclick=()=> location.reload();

// ====== Economy / Data ======
const RES={food:0, oil:0, iron:0};
const HUD={food:document.getElementById('food'), oil:document.getElementById('oil'), iron:document.getElementById('iron'),
  uInf:document.getElementById('uInf'), uAPC:document.getElementById('uAPC'), uTank:document.getElementById('uTank'),
  uHIMARS:document.getElementById('uHIMARS'), uFighter:document.getElementById('uFighter'), uBomber:document.getElementById('uBomber')};

const COST={
  // Buildings (buildTime sec)
  barracks:{food:50, oil:0, iron:40, build:10},
  mill:{food:30, oil:0, iron:20, build:10},
  refinery:{food:20, oil:40, iron:30, build:10},
  mine:{food:20, oil:20, iron:40, build:10},
  vehicleFactory:{food:40, oil:60, iron:120, build:12},
  missileLab:{food:40, oil:90, iron:140, build:14},
  airbase:{food:60, oil:140, iron:120, build:16},
  adsPlant:{food:40, oil:80, iron:160, build:14}, // Air Defense System plant

  // Units (trainTime sec)
  infantry:{food:20, oil:0, iron:0, train:4, from:'barracks', icon:'🪖'},
  bradley:{food:10, oil:25, iron:60, train:6, from:'vehicleFactory', icon:'🚛'},
  bmp3:{food:10, oil:25, iron:55, train:6, from:'vehicleFactory', icon:'🚙'},
  abrams:{food:0, oil:40, iron:120, train:8, from:'vehicleFactory', icon:'🛡️'},
  leopard2:{food:0, oil:40, iron:115, train:8, from:'vehicleFactory', icon:'🛡️'},
  himars:{food:0, oil:80, iron:100, train:9, from:'missileLab', icon:'🎯'},
  patriot:{food:0, oil:60, iron:140, train:10, from:'adsPlant', icon:'🛰️'}, // immobile SAM
  f16:{food:0, oil:120, iron:80, train:10, from:'airbase', icon:'🛩️'},
  su34:{food:0, oil:160, iron:120, train:12, from:'airbase', icon:'🛫'},
};
const STATS={
  infantry:{hp:100, speed:70, range:120, dps:10, role:'ground', targets:['ground']},
  bradley:{hp:320, speed:140, range:170, dps:24, role:'ground', targets:['ground']},
  bmp3:{hp:300, speed:150, range:160, dps:22, role:'ground', targets:['ground']},
  abrams:{hp:620, speed:95, range:210, dps:42, role:'ground', targets:['ground']},
  leopard2:{hp:600, speed:100, range:205, dps:40, role:'ground', targets:['ground']},
  himars:{hp:260, speed:90, range:650, dps:90, role:'ground', targets:['ground'], rof:0.6},
  patriot:{hp:420, speed:0, range:700, dps:75, role:'static', targets:['air'], rof:0.8, immobile:true},
  f16:{hp:260, speed:320, range:260, dps:45, role:'air', targets:['air','ground']},
  su34:{hp:360, speed:280, range:300, dps:90, role:'air', targets:['ground']},
};
const BUILD_TYPES=[
  {key:'barracks', label:'🎖️ Kışla'},
  {key:'mill', label:'🌾 Değirmen'},
  {key:'refinery', label:'🛢️ Rafineri'},
  {key:'mine', label:'⛏️ Maden'},
  {key:'vehicleFactory', label:'🏭 Zırhlı Fabrikası'},
  {key:'missileLab', label:'🚀 Füze Tesisi'},
  {key:'airbase', label:'🛬 Hava Üssü'},
  {key:'adsPlant', label:'🛰️ HSS Tesisi'},
];

// production map per building
const PROD_BY_BUILD={
  barracks:['infantry'],
  vehicleFactory:['bradley','bmp3','abrams','leopard2'],
  missileLab:['himars'],
  airbase:['f16','su34'],
  adsPlant:['patriot'],
};

// economy tick
const RATES={ tick:3, foodPerMill:3, oilPerRef:2, ironPerMine:2 };

// ====== World / Entities ======
const WORLD={ w:2000, h:1400 }; // fits in canvas; no scroll
let ENT_ID=1;
const Side={PLAYER:'player', AI:'ai'};
const units=[], buildings=[];
let selection=new Set();
let buildMode=null;

function rand(n){ return Math.floor(Math.random()*n); }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function lerp(a,b,t){ return a+(b-a)*t; }

class Entity{
  constructor(o){ Object.assign(this,o); this.id=ENT_ID++; this.dead=false; if(this.x==null||this.y==null){ this.x=WORLD.w/2; this.y=WORLD.h/2; } }
}
class Unit extends Entity{
  constructor(o){
    super(o);
    this.kind=o.kind;
    const s=STATS[this.kind];
    this.hp=s.hp; this.speed=s.speed; this.range=s.range; this.dps=s.dps; this.role=s.role; this.targets=s.targets.slice(); this.rof=s.rof||1;
    this.fireCd=0; this.isAir=(this.role==='air');
    this.tx=this.x; this.ty=this.y; this.target=null;
    this.sel=false;
  }
}
class Building extends Entity{
  constructor(o){
    super(o);
    this.btype=o.btype; this.isBase=!!o.isBase;
    this.hp= 500 + (o.isBase?500:0);
    this.underConstruction=!!o.underConstruction;
    this.buildTime=o.buildTime||10; this.elapsed=0;
    this.sel=false;
  }
}

// ====== UI: Build Buttons ======
const buildBtns=document.getElementById('buildBtns');
BUILD_TYPES.forEach(b=>{
  const btn=document.createElement('button'); btn.className='btn';
  const c=COST[b.key];
  btn.innerHTML=`${b.label} <span class="small" style="opacity:.75">(${fmtCost(c)})</span>`;
  btn.onclick=()=> startPlacing(b.key);
  buildBtns.appendChild(btn);
});
function fmtCost(c){ return `🍞${c.food} 🛢️${c.oil} ⛓️${c.iron}`; }
function canAfford(cost){ return RES.food>=cost.food && RES.oil>=cost.oil && RES.iron>=cost.iron; }
function pay(cost){ RES.food-=cost.food; RES.oil-=cost.oil; RES.iron-=cost.iron; updateHUD(); }

const prodDiv=document.getElementById('prod');
function renderProd(){
  prodDiv.innerHTML='';
  const sel=[...selection].filter(s=> s instanceof Building && s.side===Side.PLAYER && !s.underConstruction);
  if(sel.length!==1){ prodDiv.innerHTML='<div style="opacity:.7">Bir bina seçin…</div>'; return; }
  const b=sel[0];
  const list=PROD_BY_BUILD[b.btype]||[];
  if(!list.length){ prodDiv.innerHTML='<div style="opacity:.7">Bu binada üretim yok.</div>'; return; }
  list.forEach(k=>{
    const c=COST[k];
    const btn=document.createElement('button'); btn.className='btn';
    btn.innerHTML=`${COST[k].icon} ${labelOf(k)} <span class="small" style="opacity:.75">(${fmtCost(c)})</span>`;
    btn.onclick=()=> produce(b,k);
    prodDiv.appendChild(btn);
  });
}
function labelOf(k){
  const m={infantry:'Piyade', bradley:'M2 Bradley', bmp3:'BMP-3', abrams:'M1 Abrams', leopard2:'Leopard 2', himars:'HIMARS', patriot:'Patriot (S/AM)', f16:'F-16', su34:'Su-34'};
  return m[k]||k;
}

function startPlacing(btype){
  const cost=COST[btype];
  if(!canAfford(cost)){ hint('Yetersiz kaynak.'); return; }
  buildMode=btype; hint(`${labelOfBuild(btype)} için konum seçin (sol tık).`);
}
function labelOfBuild(k){
  const m={barracks:'Kışla', mill:'Değirmen', refinery:'Rafineri', mine:'Maden', vehicleFactory:'Zırhlı Fabrikası', missileLab:'Füze Tesisi', airbase:'Hava Üssü', adsPlant:'HSS Tesisi'};
  return m[k]||k;
}

// ====== Input: Selection / Orders ======
let mouse={x:0,y:0, down:false, drag:false, downAt:{x:0,y:0}}, selectBox=null;

canvas.addEventListener('mousemove', e=>{
  const r=canvas.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top;
  if(mouse.down && !mouse.drag){
    const dx=mouse.x-mouse.downAt.x, dy=mouse.y-mouse.downAt.y;
    if(Math.hypot(dx,dy)>6){ mouse.drag=true; }
  }
});
canvas.addEventListener('mousedown', e=>{
  if(e.button===0){
    mouse.down=true; mouse.drag=false; mouse.downAt={x:mouse.x,y:mouse.y};
  }
});
window.addEventListener('mouseup', e=>{
  if(e.button===0 && mouse.down){
    mouse.down=false;
    if(buildMode){
      const cost=COST[buildMode];
      if(!canAfford(cost)){ hint('Yetersiz kaynak.'); buildMode=null; return; }
      const b=new Building({x:mouse.x,y:mouse.y, btype:buildMode, side:Side.PLAYER, underConstruction:true, buildTime:cost.build});
      buildings.push(b); pay(cost); log(`🧱 ${labelOfBuild(buildMode)} kurulum başladı (${cost.build}s)`);
      buildMode=null; renderProd();
    } else if(mouse.drag){
      // box select
      const x1=Math.min(mouse.downAt.x,mouse.x), x2=Math.max(mouse.downAt.x,mouse.x);
      const y1=Math.min(mouse.downAt.y,mouse.y), y2=Math.max(mouse.downAt.y,mouse.y);
      clearSelection();
      units.filter(u=>u.side===Side.PLAYER).forEach(u=>{
        if(u.x>=x1 && u.x<=x2 && u.y>=y1 && u.y<=y2){ u.sel=true; selection.add(u); }
      });
      buildings.filter(b=>b.side===Side.PLAYER).forEach(b=>{
        if(b.x>=x1 && b.x<=x2 && b.y>=y1 && b.y<=y2){ b.sel=true; selection.add(b); }
      });
      hint(`${selection.size} öğe seçildi.`);
      renderProd();
    } else {
      // click select / toggle
      const ent=pickEntity(mouse.x,mouse.y);
      if(ent){
        if(!window.event.shiftKey) clearSelection();
        ent.sel=!ent.sel;
        if(ent.sel) selection.add(ent); else selection.delete(ent);
      } else {
        clearSelection();
      }
      renderProd();
    }
  }
});
canvas.addEventListener('contextmenu', e=>{
  e.preventDefault();
  if(selection.size===0) return;
  const target=pickEntity(mouse.x,mouse.y,true); // include enemy as attack target
  if(target && target.side!==Side.PLAYER){
    selection.forEach(s=>{
      if(s instanceof Unit){ s.target=target; s.tx=target.x; s.ty=target.y; }
    });
    hint('Saldırı emri verildi.');
  } else {
    const dest={x:mouse.x,y:mouse.y};
    // spread destinations a bit for many units
    const arr=[...selection].filter(s=> s instanceof Unit);
    arr.forEach((u,i)=>{
      const ang= (i/arr.length)*Math.PI*2;
      const r= (i%6)*8;
      u.tx=dest.x + Math.cos(ang)*r;
      u.ty=dest.y + Math.sin(ang)*r;
      u.target=null;
    });
    hint('Hareket emri verildi.');
  }
});

function pickEntity(x,y, includeEnemy=false){
  // prioritize units, then buildings
  const all = units.slice().reverse().concat(buildings.slice().reverse());
  for(const e of all){
    if(!includeEnemy && e.side!==Side.PLAYER) continue; // when selecting, only own entities
    const r = (e instanceof Unit)? 10 : 14;
    if(dist({x,y}, e)<=r+4) return e;
  }
  // when includeEnemy true (attack), allow enemy too
  if(includeEnemy){
    for(const e of units.concat(buildings)){
      const r=(e instanceof Unit)?10:14;
      if(dist({x,y}, e)<=r+4) return e;
    }
  }
  return null;
}
function clearSelection(){
  selection.forEach(s=> s.sel=false);
  selection.clear();
}

// ====== Production ======
function produce(b,k){
  const def=COST[k]; if(!def){ hint('Bilinmeyen üretim'); return; }
  if(!canAfford(def)){ hint('Yetersiz kaynak'); return; }
  if((PROD_BY_BUILD[b.btype]||[]).indexOf(k)<0){ hint('Bu binada üretilemez'); return; }
  pay(def);
  setTimeout(()=>{
    const u=new Unit({x:b.x+rand(16)-8, y:b.y+rand(16)-8, kind:k, side:Side.PLAYER});
    units.push(u); log(`✅ ${labelOf(k)} üretildi`);
  }, def.train*1000/timeScale);
}

// ====== AI (very light) ======
const AI={ base:null, t:0 };
function aiInit(){
  AI.base=new Building({x:WORLD.w*0.75, y:WORLD.h*0.25, btype:'barracks', side:Side.AI});
  buildings.push(AI.base);
  // give AI some econ
  buildings.push(new Building({x:AI.base.x+80,y:AI.base.y-40,btype:'mill',side:Side.AI}));
  buildings.push(new Building({x:AI.base.x-80,y:AI.base.y-40,btype:'refinery',side:Side.AI}));
  buildings.push(new Building({x:AI.base.x,y:AI.base.y+70,btype:'mine',side:Side.AI}));
  buildings.push(new Building({x:AI.base.x+140,y:AI.base.y+20,btype:'vehicleFactory',side:Side.AI}));
  buildings.push(new Building({x:AI.base.x-140,y:AI.base.y+20,btype:'missileLab',side:Side.AI}));
  buildings.push(new Building({x:AI.base.x,y:AI.base.y+140,btype:'airbase',side:Side.AI}));
  // a few starting units
  units.push(new Unit({x:AI.base.x+60,y:AI.base.y+20,kind:'infantry',side:Side.AI}));
  units.push(new Unit({x:AI.base.x+30,y:AI.base.y+20,kind:'infantry',side:Side.AI}));
  units.push(new Unit({x:AI.base.x+10,y:AI.base.y+20,kind:'bradley',side:Side.AI}));
}
function aiUpdate(dt){
  AI.t+=dt; if(AI.t<3) return; AI.t=0;
  // produce randomly
  const pick=()=>{
    const opts=['infantry','bradley','bmp3','abrams','himars','f16'];
    const k=opts[rand(opts.length)];
    let src='barracks';
    if(['bradley','bmp3','abrams'].includes(k)) src='vehicleFactory';
    if(k==='himars') src='missileLab';
    if(k==='f16') src='airbase';
    const b=buildings.find(x=>x.side===Side.AI && x.btype===src && !x.underConstruction);
    if(!b) return;
    // AI cheats a tiny bit: no cost (sade)
    units.push(new Unit({x:b.x+rand(8)-4,y:b.y+rand(8)-4,kind:k,side:Side.AI}));
  };
  if(Math.random()<0.7) pick();

  // order attack sometimes
  if(Math.random()<0.4){
    const target = (buildings.filter(b=>b.side===Side.PLAYER)[0]) || units.filter(u=>u.side===Side.PLAYER)[0];
    if(target){
      units.filter(u=>u.side===Side.AI).forEach(u=>{ u.target=target; u.tx=target.x; u.ty=target.y; });
    }
  }
}

// ====== Economy Loop ======
let econT=0;
function econUpdate(dt){
  econT+=dt; if(econT<RATES.tick) return; econT=0;
  const mills=buildings.filter(b=>b.side===Side.PLAYER && b.btype==='mill' && !b.underConstruction).length;
  const refs =buildings.filter(b=>b.side===Side.PLAYER && b.btype==='refinery' && !b.underConstruction).length;
  const mines=buildings.filter(b=>b.side===Side.PLAYER && b.btype==='mine' && !b.underConstruction).length;
  RES.food += mills*RATES.foodPerMill;
  RES.oil  += refs *RATES.oilPerRef;
  RES.iron += mines*RATES.ironPerMine;
  updateHUD();
}
function updateHUD(){
  HUD.food.textContent=Math.floor(RES.food);
  HUD.oil.textContent=Math.floor(RES.oil);
  HUD.iron.textContent=Math.floor(RES.iron);
  HUD.uInf.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='infantry').length;
  HUD.uAPC.textContent=units.filter(u=>u.side===Side.PLAYER && (u.kind==='bradley'||u.kind==='bmp3')).length;
  HUD.uTank.textContent=units.filter(u=>u.side===Side.PLAYER && (u.kind==='abrams'||u.kind==='leopard2')).length;
  HUD.uHIMARS.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='himars').length;
  HUD.uFighter.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='f16').length;
  HUD.uBomber.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='su34').length;
}

// ====== Movement / Combat ======
function unitUpdate(u, dt){
  // acquire target if none and enemy in vicinity
  if(!u.target){
    const foes = units.concat(buildings).filter(e=> e.side!==u.side && !e.dead);
    let best=null, bestD=1e9;
    for(const f of foes){
      if(f instanceof Unit){
        // check target type
        const isAir = f.isAir===true;
        if(isAir && !u.targets.includes('air')) continue;
        if(!isAir && !u.targets.includes('ground')) continue;
      } else {
        // buildings = ground
        if(!u.targets.includes('ground')) continue;
      }
      const d=dist(u,f);
      if(d<bestD && d<u.range+120) { best=f; bestD=d; }
    }
    if(best) u.target=best;
  }

  // fire
  u.fireCd=Math.max(0, u.fireCd - dt);
  if(u.target && !u.target.dead){
    const d=dist(u,u.target);
    if(d<=u.range){
      if(u.fireCd<=0){
        // damage
        u.target.hp -= u.dps;
        drawShot(u,u.target);
        u.fireCd = 1/ (u.rof||1);
        if(u.target.hp<=0){ destroy(u.target, u); u.target=null; }
      }
    } else {
      // chase
      u.tx=u.target.x; u.ty=u.target.y;
    }
  }

  // move
  const dx=u.tx-u.x, dy=u.ty-u.y; const dd=Math.hypot(dx,dy);
  if(dd>1){
    const step = u.speed * dt;
    const t = Math.min(1, step/dd);
    u.x += dx*t; u.y += dy*t;
  }
}

function destroy(e,killer){
  e.dead=true;
  // remove from arrays on sweep
  if(killer) log(`${killer.side===Side.PLAYER?'Bizim':'AI'} ${labelEnt(killer)} → ${labelEnt(e)} yok etti.`);
}

function labelEnt(e){
  if(e instanceof Unit) return labelOf(e.kind);
  return labelOfBuild(e.btype)+(e.isBase?' (Üs)':'');
}

function drawShot(a,b){
  shots.push({x1:a.x,y1:a.y,x2:b.x,y2:b.y,t:0.12});
}

const shots=[];

// ====== Game Init ======
function init(){
  // player base + econ
  RES.food=120; RES.oil=80; RES.iron=100;
  buildings.push(new Building({x:WORLD.w*0.25, y:WORLD.h*0.75, btype:'barracks', side:Side.PLAYER, isBase:true}));
  buildings.push(new Building({x:WORLD.w*0.25+100, y:WORLD.h*0.75-60, btype:'mill', side:Side.PLAYER}));
  buildings.push(new Building({x:WORLD.w*0.25-100, y:WORLD.h*0.75-60, btype:'refinery', side:Side.PLAYER}));
  buildings.push(new Building({x:WORLD.w*0.25, y:WORLD.h*0.75+80, btype:'mine', side:Side.PLAYER}));
  buildings.push(new Building({x:WORLD.w*0.25+160, y:WORLD.h*0.75+20, btype:'vehicleFactory', side:Side.PLAYER}));
  buildings.push(new Building({x:WORLD.w*0.25-160, y:WORLD.h*0.75+20, btype:'airbase', side:Side.PLAYER}));
  // start units
  units.push(new Unit({x:WORLD.w*0.25+30,y:WORLD.h*0.75+10,kind:'infantry',side:Side.PLAYER}));
  units.push(new Unit({x:WORLD.w*0.25+50,y:WORLD.h*0.75-10,kind:'infantry',side:Side.PLAYER}));
  units.push(new Unit({x:WORLD.w*0.25+70,y:WORLD.h*0.75+0,kind:'bradley',side:Side.PLAYER}));
  units.push(new Unit({x:WORLD.w*0.25+90,y:WORLD.h*0.75+20,kind:'abrams',side:Side.PLAYER}));

  aiInit();
  updateHUD(); hint('Hazır: Bina kur, birim üret, sağ tıkla yönet.');
  selfTests();
}
init();

// ====== Render ======
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // subtle grid is via CSS; draw entities
  // draw buildings
  for(const b of buildings){
    if(b.dead) continue;
    const r=16;
    // base shape
    ctx.save();
    ctx.translate(b.x,b.y);
    ctx.fillStyle = b.side===Side.PLAYER ? 'rgba(16,185,129,.95)' : 'rgba(96,165,250,.95)';
    ctx.strokeStyle='rgba(0,0,0,.4)'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.roundRect(-r,-r, r*2, r*2, 6); ctx.fill(); ctx.stroke();
    // icon
    ctx.fillStyle='#081017'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(bIcon(b.btype),0,0);
    // HP bar
    const max = b.isBase? 1000 : 500;
    const pct=Math.max(0,Math.min(1,b.hp/max));
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-22, r+6, 44, 4);
    ctx.fillStyle= pct<.33? '#ef4444' : pct<.66? '#f59e0b' : '#22c55e';
    ctx.fillRect(-22, r+6, 44*pct, 4);
    if(b.sel){
      ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=2; ctx.strokeRect(-r-3,-r-3,(r*2)+6,(r*2)+6);
    }
    // under construction
    if(b.underConstruction){
      const p=Math.min(1,b.elapsed/(b.buildTime||10));
      ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(-22, -r-8, 44, 4);
      ctx.fillStyle='#fde047'; ctx.fillRect(-22, -r-8, 44*p, 4);
    }
    ctx.restore();
  }

  // draw units
  for(const u of units){
    if(u.dead) continue;
    const r=10;
    ctx.save(); ctx.translate(u.x,u.y);
    ctx.fillStyle = u.side===Side.PLAYER ? 'rgba(16,185,129,.95)' : 'rgba(96,165,250,.95)';
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(0,0,0,.4)'; ctx.stroke();
    // icon text
    ctx.fillStyle='#081017'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(uIcon(u.kind),0,0);

    // HP bar
    const max=STATS[u.kind].hp; const pct=Math.max(0,Math.min(1,u.hp/max));
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-18, r+5, 36, 3);
    ctx.fillStyle= pct<.33? '#ef4444' : pct<.66? '#f59e0b' : '#22c55e';
    ctx.fillRect(-18, r+5, 36*pct, 3);

    if(u.sel){
      // selection ring
      ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,r+4,0,Math.PI*2); ctx.stroke();
      // range ring
      ctx.strokeStyle='rgba(253,224,71,.9)'; ctx.fillStyle='rgba(253,224,71,.08)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(0,0,u.range,0,Math.PI*2); ctx.fill(); ctx.stroke();
    }
    ctx.restore();
  }

  // shots
  for(const s of shots){
    ctx.strokeStyle='#fde047'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(s.x1,s.y1); ctx.lineTo(s.x2,s.y2); ctx.stroke();
  }

  // selection rectangle
  if(mouse.down && mouse.drag){
    ctx.strokeStyle='rgba(147,197,253,.9)'; ctx.setLineDash([5,4]); ctx.lineWidth=1;
    ctx.fillStyle='rgba(59,130,246,.15)';
    const x1=Math.min(mouse.downAt.x,mouse.x), x2=Math.max(mouse.downAt.x,mouse.x);
    const y1=Math.min(mouse.downAt.y,mouse.y), y2=Math.max(mouse.downAt.y,mouse.y);
    ctx.fillRect(x1,y1,x2-x1,y2-y1); ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    ctx.setLineDash([]);
  }
}

// Icons
function bIcon(t){
  return t==='barracks'?'🎖️': t==='mill'?'🌾': t==='refinery'?'🛢️': t==='mine'?'⛏️': t==='vehicleFactory'?'🏭': t==='missileLab'?'🚀': t==='airbase'?'🛬': t==='adsPlant'?'🛰️':'🏚️';
}
function uIcon(k){
  return COST[k]?.icon || '❓';
}

// ====== Update Loop ======
let timeScale=1; // 1..100
const spd=document.getElementById('speed'), spdLbl=document.getElementById('spdLbl');
function setSpeed(v){ timeScale=v; spd.value=v; spdLbl.textContent=v+'x'; hint('Hız: '+v+'x'); }
spd.oninput=()=> setSpeed(+spd.value);
document.querySelectorAll('[data-s]').forEach(b=> b.onclick=()=> setSpeed(+b.dataset.s));

let last=performance.now();
function loop(now){
  const dt = Math.min(0.05, (now-last)/1000) * timeScale; last=now;
  // build timers
  for(const b of buildings){ if(b.underConstruction){ b.elapsed+=dt; if(b.elapsed>=b.buildTime){ b.underConstruction=false; log(`✅ ${labelOfBuild(b.btype)} tamamlandı`);} } }

  // update units
  for(const u of units){ if(!u.dead) unitUpdate(u, dt); }

  // cleanup dead
  sweep();

  // shots lifespan
  for(let i=shots.length-1;i>=0;i--){ shots[i].t-=dt; if(shots[i].t<=0) shots.splice(i,1); }

  // economy + ai
  econUpdate(dt); aiUpdate(dt);

  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function sweep(){
  for(let i=units.length-1;i>=0;i--){ if(units[i].dead) units.splice(i,1); }
  for(let i=buildings.length-1;i>=0;i--){ if(buildings[i].dead) buildings.splice(i,1); }
}

// ====== Utils / Tests ======
function selfTests(){
  console.group('%cSelf-Tests','color:#10b981;font-weight:bold');
  try{
    // stats completeness
    Object.keys(PROD_BY_BUILD).forEach(b=>{
      PROD_BY_BUILD[b].forEach(k=>{ console.assert(STATS[k], 'STAT yok:', k); console.assert(COST[k], 'COST yok:', k); });
    });
    // produce feasibility
    const bb=buildings.find(x=>x.side===Side.PLAYER && x.btype==='barracks');
    console.assert(!!bb,'Player kışla var');
    console.log('✅ Tests OK');
  }catch(e){ console.error('❌ Test hata', e); }
  console.groupEnd();
}

// ====== End ======
})();
</script>
</body>
</html>
