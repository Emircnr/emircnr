<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GLOBAL RTS â€” Real-World Map & Speeds</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
  :root{ --bg:#0b1220; --panel:#111A2B; --text:#E6EDF6; --accent:#34d399; --blue:#60a5fa; --warn:#f59e0b; --bad:#ef4444 }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  #app{height:100%;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{background:linear-gradient(180deg,rgba(17,26,43,.85),rgba(11,18,32,.85));border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
  header{position:sticky;top:0;z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:.6rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  .hud{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .55rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:12px}
  .btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:var(--text);border-radius:10px;padding:.45rem .7rem;cursor:pointer}
  .panel{position:absolute;z-index:5;background:linear-gradient(180deg,rgba(17,26,43,.85),rgba(11,18,32,.85));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
  .left{left:10px;top:10px;width:360px} .right{right:10px;top:10px;width:360px}
  .stage{position:relative;width:100%;height:100%}
  #map{position:absolute;inset:0;z-index:0;pointer-events:none} /* tÄ±klar canvas'a */
  #game{position:absolute;inset:0;z-index:1;display:block;width:100%;height:100%}
  #hint{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.4rem .7rem;border-radius:10px;z-index:6;font-size:13px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .small{font-size:12px;opacity:.8}
  .list{font-size:12px;max-height:180px;overflow:auto;line-height:1.6}
  .kps{width:120px}
  .zoom{width:120px}
  .sectionTitle{font-weight:700;opacity:.8;margin:10px 0 6px}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="wrap">
      <div><b>GLOBAL RTS</b> â€” Real Map & Real Speeds</div>
      <div class="hud">
        <span class="pill">ğŸ <b id="food">0</b></span>
        <span class="pill">ğŸ›¢ï¸ <b id="oil">0</b></span>
        <span class="pill">â›“ï¸ <b id="iron">0</b></span>
        <span class="pill">ğŸª– <b id="uInf">0</b></span>
        <span class="pill">ğŸš› <b id="uAPC">0</b></span>
        <span class="pill">ğŸ›¡ï¸ <b id="uTank">0</b></span>
        <span class="pill">ğŸ¯ <b id="uHIMARS">0</b></span>
        <span class="pill">ğŸ›©ï¸ <b id="uFighter">0</b></span>
        <span class="pill">ğŸ›« <b id="uBomber">0</b></span>

        <div class="pill" style="gap:.5rem">
          â© <input id="speed" type="range" min="1" max="100" value="1" class="kps">
          <b id="spdLbl">1x</b>
          <button class="btn" data-s="1">1x</button><button class="btn" data-s="5">5x</button><button class="btn" data-s="10">10x</button><button class="btn" data-s="50">50x</button><button class="btn" data-s="100">100x</button>
        </div>

        <div class="pill" style="gap:.5rem">
          ğŸ” <input id="zoom" type="range" min="2" max="18" value="12" class="zoom">
          <b id="zoomLbl">12</b>
          <button id="zin" class="btn">ï¼‹</button>
          <button id="zout" class="btn">ï¼</button>
        </div>

        <button id="newGame" class="btn">â†» Yeni Oyun</button>
        <button id="help" class="btn">â” YardÄ±m</button>
      </div>
    </div>
  </header>

  <main style="position:relative">
    <div class="stage">
      <div id="map"></div>
      <canvas id="game"></canvas>
      <div id="hint">Uydu haritasÄ± yÃ¼kleniyorâ€¦</div>
    </div>

    <div class="panel left">
      <div class="sectionTitle">Ä°nÅŸa Et</div>
      <div class="grid2" id="buildBtns"></div>

      <div class="sectionTitle">Duvar</div>
      <div class="grid2">
        <button id="wallModeBtn" class="btn">ğŸ§± Duvar (Ã§izgi)</button>
        <button id="wallCancelBtn" class="btn">âœ–ï¸ Ä°ptal</button>
      </div>

      <div class="sectionTitle">Ãœret (SeÃ§ili Bina)</div>
      <div id="prod" class="grid2 small"><div style="opacity:.7">Bir bina seÃ§inâ€¦</div></div>

      <div style="margin-top:8px" class="small">
        <div><b>SeÃ§im</b>: Sol tÄ±k â€¢ <b>Kare seÃ§im</b>: Sol sÃ¼rÃ¼kle</div>
        <div><b>Hareket</b>: SaÄŸ tÄ±k zemin â€¢ <b>SaldÄ±r</b>: SaÄŸ tÄ±k dÃ¼ÅŸman</div>
        <div><b>Duvar</b>: ğŸ§± dÃ¼ÄŸmesine bas â†’ nokta 1â€™e tÄ±kla â†’ nokta 2â€™ye tÄ±kla. En yakÄ±n <b>kepÃ§e</b> inÅŸa eder.</div>
        <div><b>Zoom</b>: Mouse tekerleÄŸi veya ğŸ” slider / ï¼‹ ï¼</div>
      </div>
    </div>

    <div class="panel right">
      <div style="font-weight:700;opacity:.8;margin-bottom:6px">GÃ¼nlÃ¼k</div>
      <div id="log" class="list"></div>
    </div>
  </main>

  <footer>
    <div class="wrap" style="justify-content:center;font-size:12px;opacity:.8">
      Mouse-only â€¢ Kare seÃ§im â€¢ Otomatik saldÄ±rÄ± â€¢ GerÃ§ek uydu haritasÄ± â€¢ Duvar Ã§izimi (kepÃ§e) â€¢ 1â€“100x hÄ±z â€¢ 2â€“18x harita zoom
    </div>
  </footer>
</div>

<!-- YardÄ±m Modal -->
<div id="modal" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);z-index:9999">
  <div style="background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:720px;font-size:14px">
    <div style="font-weight:700;margin-bottom:8px">NasÄ±l OynanÄ±r?</div>
    <ul style="margin:0;padding-left:18px;line-height:1.7">
      <li>BaÅŸlangÄ±Ã§ta: Ana Ã¼s (ÅanlÄ±urfa Ã§evresi) + 1 kepÃ§e. Kaynak topla, binalarÄ± kur, Ã¼niteleri aÃ§.</li>
      <li>Sol panelden bina seÃ§ â†’ haritaya tÄ±kla: belirtilen sÃ¼rede kurulur.</li>
      <li>Bir bina seÃ§ince saÄŸ panelde uygun birimler Ã§Ä±kar. Maliyeti karÅŸÄ±lÄ±yorsa Ã¼ret.</li>
      <li>Sol tÄ±k seÃ§, sÃ¼rÃ¼kle â†’ kare seÃ§im. SaÄŸ tÄ±k zemin â†’ hareket. SaÄŸ tÄ±k dÃ¼ÅŸman â†’ saldÄ±r.</li>
      <li>ğŸ§± Duvar: â€œDuvar (Ã§izgi)â€ â†’ iki nokta tÄ±kla. En yakÄ±n kepÃ§e metre/sn ile inÅŸa eder.</li>
      <li>Harita zoom: mouse tekerleÄŸi veya Ã¼stteki kontroller (yÃ¼ksek zoom destekli).</li>
    </ul>
    <div style="text-align:right;margin-top:10px"><button class="btn" onclick="document.getElementById('modal').style.display='none'">Kapat</button></div>
  </div>
</div>

<script>
(()=>{
// ======================= Harita (Leaflet) =======================
const map = L.map('map', {
  zoomControl:false, attributionControl:false,
  dragging:false, scrollWheelZoom:false, doubleClickZoom:false, boxZoom:false,
  keyboard:false, tap:false, touchZoom:false
}).setView([37.158, 38.795], 12); // ÅanlÄ±urfa civarÄ± (baÅŸlangÄ±Ã§)

L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 18 }
).addTo(map);

// Canvas
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
function resize(){ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
window.addEventListener('resize', resize); resize();

const hintEl=document.getElementById('hint'), logEl=document.getElementById('log');
function hint(s){ hintEl.textContent=s; }
function log(s){ const d=document.createElement('div'); d.textContent=s; logEl.prepend(d); }

// ----- Zoom UI + tekerlek proxy -----
const zoomSlider = document.getElementById('zoom');
const zoomLbl = document.getElementById('zoomLbl');
document.getElementById('zin').onclick=()=> setZoom(map.getZoom()+1);
document.getElementById('zout').onclick=()=> setZoom(map.getZoom()-1);
zoomSlider.oninput=()=> setZoom(+zoomSlider.value);

function setZoom(z){
  z = Math.max(2, Math.min(18, z));
  map.setZoom(z);
  zoomSlider.value = z;
  zoomLbl.textContent = z;
}
canvas.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const dir = e.deltaY>0? -1: +1; // klasik mouse: ileri=yakÄ±nlaÅŸ
  setZoom(map.getZoom()+dir);
}, {passive:false});

// ======================= YardÄ±m / Yeni Oyun =======================
document.getElementById('help').onclick=()=> document.getElementById('modal').style.display='grid';
document.getElementById('newGame').onclick=()=> location.reload();

// ======================= Ekonomi / TanÄ±mlar =======================
const RES={food:0, oil:0, iron:0};
const HUD={food:document.getElementById('food'), oil:document.getElementById('oil'), iron:document.getElementById('iron'),
  uInf:document.getElementById('uInf'), uAPC:document.getElementById('uAPC'), uTank:document.getElementById('uTank'),
  uHIMARS:document.getElementById('uHIMARS'), uFighter:document.getElementById('uFighter'), uBomber:document.getElementById('uBomber')};

// Maliyetler / sÃ¼reler (sabit)
const COST={
  // Binalar
  barracks:{food:50, oil:0, iron:40, build:10},
  mill:{food:30, oil:0, iron:20, build:10},
  refinery:{food:20, oil:40, iron:30, build:10},
  mine:{food:20, oil:20, iron:40, build:10},
  vehicleFactory:{food:40, oil:60, iron:120, build:12},
  missileLab:{food:40, oil:90, iron:140, build:14},
  airbase:{food:60, oil:140, iron:120, build:16},
  adsPlant:{food:40, oil:80, iron:160, build:14},
  // Ãœniteler (gerÃ§ekÃ§i hÄ±zlar: km/s)
  infantry:{food:20, oil:0, iron:0, train:4, from:'barracks', icon:'ğŸª–', speedKmh:5,   rangeM:300,  dps:10, role:'ground', targets:['ground']},
  bradley:{food:10, oil:25, iron:60, train:6, from:'vehicleFactory', icon:'ğŸš›', speedKmh:66,  rangeM:1700, dps:24, role:'ground', targets:['ground']},
  bmp3:{food:10, oil:25, iron:55, train:6, from:'vehicleFactory', icon:'ğŸš™', speedKmh:70,  rangeM:1600, dps:22, role:'ground', targets:['ground']},
  abrams:{food:0,  oil:40, iron:120,train:8, from:'vehicleFactory', icon:'ğŸ›¡ï¸', speedKmh:60,  rangeM:2500, dps:42, role:'ground', targets:['ground']},
  leopard2:{food:0, oil:40, iron:115,train:8, from:'vehicleFactory', icon:'ğŸ›¡ï¸', speedKmh:68,  rangeM:2400, dps:40, role:'ground', targets:['ground']},
  himars:{food:0,  oil:80, iron:100,train:9, from:'missileLab',     icon:'ğŸ¯', speedKmh:85,  rangeM:30000, dps:90, role:'ground', targets:['ground'], rof:0.6},
  patriot:{food:0, oil:60, iron:140,train:10,from:'adsPlant',       icon:'ğŸ›°ï¸', speedKmh:0,   rangeM:70000, dps:75, role:'static', targets:['air'], rof:0.8, immobile:true},
  f16:{food:0,     oil:120,iron:80, train:10,from:'airbase',        icon:'ğŸ›©ï¸', speedKmh:900, rangeM:5000,  dps:45, role:'air', targets:['air','ground']},
  su34:{food:0,    oil:160,iron:120,train:12,from:'airbase',        icon:'ğŸ›«', speedKmh:950, rangeM:6000,  dps:90, role:'air', targets:['ground']},
  // KepÃ§e/Dozer
  dozer:{food:10, oil:20, iron:30, train:6, from:'vehicleFactory', icon:'ğŸšœ', speedKmh:10, rangeM:0, dps:0, role:'ground', targets:[]}
};

// Ãœretim eÅŸleÅŸmesi
const BUILD_TYPES=[
  {key:'barracks', label:'ğŸ–ï¸ KÄ±ÅŸla'},
  {key:'mill', label:'ğŸŒ¾ DeÄŸirmen'},
  {key:'refinery', label:'ğŸ›¢ï¸ Rafineri'},
  {key:'mine', label:'â›ï¸ Maden'},
  {key:'vehicleFactory', label:'ğŸ­ ZÄ±rhlÄ± FabrikasÄ±'},
  {key:'missileLab', label:'ğŸš€ FÃ¼ze Tesisi'},
  {key:'airbase', label:'ğŸ›¬ Hava ÃœssÃ¼'},
  {key:'adsPlant', label:'ğŸ›°ï¸ HSS Tesisi'},
];
const PROD_BY_BUILD={
  barracks:['infantry'],
  vehicleFactory:['bradley','bmp3','abrams','leopard2','dozer'],
  missileLab:['himars'],
  airbase:['f16','su34'],
  adsPlant:['patriot'],
};

const RATES={ tick:3, foodPerMill:3, oilPerRef:2, ironPerMine:2 };

// ======================= DÃ¼nya / VarlÄ±klar (geo) =======================
let ENT_ID=1;
const Side={PLAYER:'player', AI:'ai'};
const units=[], buildings=[];
const walls=[]; // {a:{lat,lng}, b:{lat,lng}, builtMeters, widthMeters}
const WALL_WIDTH_M=5, DOZER_RATE_MPS=1.0; // 5 m geniÅŸlik, 1 m/sn inÅŸa

let selection=new Set();
let buildMode=null;

function rand(n){ return Math.floor(Math.random()*n); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function lerp(a,b,t){ return a+(b-a)*t; }
function labelOf(k){
  const m={infantry:'Piyade', bradley:'M2 Bradley', bmp3:'BMP-3', abrams:'M1 Abrams', leopard2:'Leopard 2', himars:'HIMARS', patriot:'Patriot (S/AM)', f16:'F-16', su34:'Su-34', dozer:'KepÃ§e (Dozer)'}; return m[k]||k;
}
function labelOfBuild(k){
  const m={barracks:'KÄ±ÅŸla', mill:'DeÄŸirmen', refinery:'Rafineri', mine:'Maden', vehicleFactory:'ZÄ±rhlÄ± FabrikasÄ±', missileLab:'FÃ¼ze Tesisi', airbase:'Hava ÃœssÃ¼', adsPlant:'HSS Tesisi'}; return m[k]||k;
}

class Entity{
  constructor(o){ Object.assign(this,o); this.id=ENT_ID++; this.dead=false; }
}
class Unit extends Entity{
  constructor(o){
    super(o);
    this.kind=o.kind; this.side=o.side;
    const c=COST[this.kind];
    this.speedKmh=c.speedKmh; this.rangeM=c.rangeM; this.dps=c.dps; this.role=c.role; this.targets=(c.targets||[]).slice();
    this.rof=c.rof||1; this.fireCd=0; this.isAir=(this.role==='air'); this.immobile=!!c.immobile;
    this.hp = (this.kind==='infantry')?100 : (this.kind==='himars'?260 : (this.kind==='patriot'?420 : (this.kind==='f16'?260:(this.kind==='su34'?360: (this.kind==='abrams'?620:(this.kind==='leopard2'?600:(this.kind==='bradley'?320:(this.kind==='bmp3'?300:280)))))));
    this.lat=o.lat; this.lng=o.lng;
    this.tlat=this.lat; this.tlng=this.lng; // hedef
    this.target=null; this.sel=false;
    this.buildTask=null; // dozer iÃ§in {wallIndex}
  }
}
class Building extends Entity{
  constructor(o){
    super(o);
    this.btype=o.btype; this.side=o.side; this.isBase=!!o.isBase;
    this.hp= 500 + (o.isBase?500:0);
    this.underConstruction=!!o.underConstruction;
    this.buildTime=o.buildTime||10; this.elapsed=0;
    this.lat=o.lat; this.lng=o.lng;
    this.sel=false;
  }
}

// ======================= UI: Build ButonlarÄ± =======================
const buildBtns=document.getElementById('buildBtns');
buildBtns.innerHTML='';
BUILD_TYPES.forEach(b=>{
  const btn=document.createElement('button'); btn.className='btn';
  const c=COST[b.key];
  btn.innerHTML=`${b.label} <span class="small" style="opacity:.75">(${fmtCost(c)})</span>`;
  btn.onclick=()=> startPlacing(b.key);
  buildBtns.appendChild(btn);
});
const prodDiv=document.getElementById('prod');
function renderProd(){
  prodDiv.innerHTML='';
  const sel=[...selection].filter(s=> s instanceof Building && s.side===Side.PLAYER && !s.underConstruction);
  if(sel.length!==1){ prodDiv.innerHTML='<div style="opacity:.7">Bir bina seÃ§inâ€¦</div>'; return; }
  const b=sel[0];
  const list=PROD_BY_BUILD[b.btype]||[];
  if(!list.length){ prodDiv.innerHTML='<div style="opacity:.7">Bu binada Ã¼retim yok.</div>'; return; }
  list.forEach(k=>{
    const c=COST[k];
    const btn=document.createElement('button'); btn.className='btn';
    btn.innerHTML=`${COST[k].icon} ${labelOf(k)} <span class="small" style="opacity:.75">(${fmtCost(c)})</span>`;
    btn.onclick=()=> produce(b,k);
    prodDiv.appendChild(btn);
  });
}
function fmtCost(c){ return `ğŸ${c.food} ğŸ›¢ï¸${c.oil} â›“ï¸${c.iron}`; }
function canAfford(cost){ return RES.food>=cost.food && RES.oil>=cost.oil && RES.iron>=cost.iron; }
function pay(cost){ RES.food-=cost.food; RES.oil-=cost.oil; RES.iron-=cost.iron; updateHUD(); }

// ======================= Duvar UI =======================
let wallMode=false, wallP1=null;
document.getElementById('wallModeBtn').onclick=()=>{ wallMode=true; wallP1=null; hint('ğŸ§± Duvar modu: BaÅŸlangÄ±Ã§ noktasÄ±na sol tÄ±kla.'); };
document.getElementById('wallCancelBtn').onclick=()=>{ wallMode=false; wallP1=null; hint('Duvar modu iptal edildi.'); };

// ======================= Girdi / SeÃ§im =======================
let mouse={x:0,y:0, down:false, drag:false, downAt:{x:0,y:0}, lat:0, lng:0};
canvas.addEventListener('mousemove', e=>{
  const r=canvas.getBoundingClientRect(); mousex=e.clientX-r.left; mousey=e.clientY-r.top;
  mouse.x=mousex; mouse.y=mousey;
  const ll = map.containerPointToLatLng([mouse.x, mouse.y]);
  mouse.lat=ll.lat; mouse.lng=ll.lng;
  if(mouse.down && !mouse.drag){
    const dx=mouse.x-mouse.downAt.x, dy=mouse.y-mouse.downAt.y;
    if(Math.hypot(dx,dy)>6){ mouse.drag=true; }
  }
});
canvas.addEventListener('mousedown', e=>{
  if(e.button===0){ mouse.down=true; mouse.drag=false; mouse.downAt={x:mouse.x,y:mouse.y}; }
});
window.addEventListener('mouseup', e=>{
  if(e.button===0 && mouse.down){
    mouse.down=false;

    // Duvar modu
    if(wallMode){
      if(!wallP1){
        wallP1={lat:mouse.lat, lng:mouse.lng};
        hint('BitiÅŸ noktasÄ±na tÄ±kla (ğŸ§± duvar Ã§izilecek).');
      }else{
        const p2={lat:mouse.lat, lng:mouse.lng};
        createWall(wallP1, p2);
        wallP1=null; wallMode=false;
      }
      return;
    }

    if(buildMode){
      const cost=COST[buildMode];
      if(!canAfford(cost)){ hint('Yetersiz kaynak.'); buildMode=null; return; }
      const b=new Building({lat:mouse.lat,lng:mouse.lng, btype:buildMode, side:Side.PLAYER, underConstruction:true, buildTime:cost.build});
      buildings.push(b); pay(cost); log(`ğŸ§± ${labelOfBuild(buildMode)} kurulum baÅŸladÄ± (${cost.build}s)`);
      buildMode=null; renderProd();
    } else if(mouse.drag){
      // box select: piksel uzayÄ±nda
      const x1=Math.min(mouse.downAt.x,mouse.x), x2=Math.max(mouse.downAt.x,mouse.x);
      const y1=Math.min(mouse.downAt.y,mouse.y), y2=Math.max(mouse.downAt.y,mouse.y);
      clearSelection();
      units.filter(u=>u.side===Side.PLAYER).forEach(u=>{
        const p=toPoint(u.lat,u.lng);
        if(p.x>=x1 && p.x<=x2 && p.y>=y1 && p.y<=y2){ u.sel=true; selection.add(u); }
      });
      buildings.filter(b=>b.side===Side.PLAYER).forEach(b=>{
        const p=toPoint(b.lat,b.lng);
        if(p.x>=x1 && p.x<=x2 && p.y>=y1 && p.y<=y2){ b.sel=true; selection.add(b); }
      });
      hint(`${selection.size} Ã¶ÄŸe seÃ§ildi.`);
      renderProd();
    } else {
      // click select / toggle
      const ent=pickEntity(mouse.x,mouse.y);
      if(ent){
        if(!window.event.shiftKey) clearSelection();
        ent.sel=!ent.sel;
        if(ent.sel) selection.add(ent); else selection.delete(ent);
      } else {
        clearSelection();
      }
      renderProd();
    }
  }
});
canvas.addEventListener('contextmenu', e=>{
  e.preventDefault();
  if(selection.size===0) return;
  const target=pickEntity(mouse.x,mouse.y,true);
  if(target && target.side!==Side.PLAYER){
    selection.forEach(s=>{
      if(s instanceof Unit){ s.target=target; s.tlat=target.lat; s.tlng=target.lng; }
    });
    hint('SaldÄ±rÄ± emri verildi.');
  } else {
    const destLL = map.containerPointToLatLng([mouse.x,mouse.y]);
    const arr=[...selection].filter(s=> s instanceof Unit);
    arr.forEach((u,i)=>{
      const theta=(i/Math.max(1,arr.length))*Math.PI*2;
      const offsetM = (i%6)*3; // metre bazlÄ± kÃ¼Ã§Ã¼k ofset
      const dest = offsetMeters(destLL.lat, destLL.lng, offsetM, theta);
      u.tlat=dest.lat; u.tlng=dest.lng; u.target=null; if(u.buildTask) u.buildTask=null;
    });
    hint('Hareket emri verildi.');
  }
});

function pickEntity(px,py, includeEnemy=false){
  // ekranda en yakÄ±n daire/kare (piksel) Ã¼zerinden
  const all = units.slice().reverse().concat(buildings.slice().reverse());
  for(const e of all){
    if(!includeEnemy && e.side!==Side.PLAYER) continue;
    const p=toPoint(e.lat,e.lng);
    const r = (e instanceof Unit)? 12 : 16;
    if(Math.hypot(px-p.x, py-p.y)<=r+4) return e;
  }
  if(includeEnemy){
    for(const e of units.concat(buildings)){
      const p=toPoint(e.lat,e.lng);
      const r=(e instanceof Unit)?12:16;
      if(Math.hypot(px-p.x, py-p.y)<=r+4) return e;
    }
  }
  return null;
}
function clearSelection(){ selection.forEach(s=> s.sel=false); selection.clear(); }
function startPlacing(btype){
  const cost=COST[btype];
  if(!canAfford(cost)){ hint('Yetersiz kaynak.'); return; }
  buildMode=btype; hint(`${labelOfBuild(btype)} iÃ§in konum seÃ§in (sol tÄ±k).`);
}

// ======================= Duvar (geo) =======================
function createWall(a,b){
  const lenM = distanceMeters(a.lat,a.lng,b.lat,b.lng);
  if(lenM<10){ hint('Duvar Ã§ok kÄ±sa.'); return; }
  const w={a:{...a}, b:{...b}, builtMeters:0, widthMeters:WALL_WIDTH_M};
  walls.push(w);
  log('ğŸ§± Duvar planlandÄ±. En yakÄ±n kepÃ§e gÃ¶revlendiriliyorâ€¦');
  const dozer = nearestFreeDozer(a);
  if(dozer){
    assignDozerToWall(dozer, walls.length-1);
    log('ğŸšœ KepÃ§e duvara yÃ¶nlendirildi.');
  } else {
    log('âš ï¸ YakÄ±nda boÅŸ kepÃ§e yok. Bir kepÃ§e Ã¼ret veya serbest bÄ±rak.');
  }
}
function nearestFreeDozer(pLL){
  let best=null, bd=1e12;
  for(const u of units){
    if(u.side!==Side.PLAYER) continue;
    if(u.kind!=='dozer') continue;
    if(u.dead) continue;
    if(u.buildTask) continue;
    const d=distanceMeters(u.lat,u.lng,pLL.lat,pLL.lng);
    if(d<bd){ bd=d; best=u; }
  }
  return best;
}
function assignDozerToWall(dozer, wallIndex){
  dozer.buildTask={wallIndex};
  const w = walls[wallIndex];
  dozer.tlat=w.a.lat; dozer.tlng=w.a.lng;
}

// ======================= Ãœretim =======================
function produce(b,k){
  const def=COST[k]; if(!def){ hint('Bilinmeyen Ã¼retim'); return; }
  if(!canAfford(def)){ hint('Yetersiz kaynak'); return; }
  if((PROD_BY_BUILD[b.btype]||[]).indexOf(k)<0){ hint('Bu binada Ã¼retilemez'); return; }
  pay(def);
  setTimeout(()=>{
    const jitter = offsetMeters(b.lat,b.lng, Math.random()*6, Math.random()*Math.PI*2);
    const u=new Unit({lat:jitter.lat,lng:jitter.lng,kind:k,side:Side.PLAYER});
    units.push(u); log(`âœ… ${labelOf(k)} Ã¼retildi`);
  }, def.train*1000/timeScale);
}

// ======================= AI (hafif) =======================
const AI={ t:0, base:null };
function aiInit(){
  const baseLL = offsetMeters(37.200, 38.900, 5000, Math.PI/3); // yakÄ±n bir noktaya
  AI.base=new Building({lat:baseLL.lat, lng:baseLL.lng, btype:'barracks', side:Side.AI});
  buildings.push(AI.base);
  const around = (btype, m, ang)=>{ const p=offsetMeters(baseLL.lat,baseLL.lng,m,ang); buildings.push(new Building({lat:p.lat,lng:p.lng,btype,side:Side.AI})); }
  around('mill', 600, 0.2);
  around('refinery', 650, 1.2);
  around('mine', 700, 2.1);
  around('vehicleFactory', 750, 2.7);
  around('missileLab', 820, 3.4);
  around('airbase', 900, 4.1);
  const u1=offsetMeters(baseLL.lat,baseLL.lng,120,0.3);
  const u2=offsetMeters(baseLL.lat,baseLL.lng,150,0.6);
  units.push(new Unit({lat:u1.lat,lng:u1.lng,kind:'infantry',side:Side.AI}));
  units.push(new Unit({lat:u2.lat,lng:u2.lng,kind:'infantry',side:Side.AI}));
  const u3=offsetMeters(baseLL.lat,baseLL.lng,180,0.9);
  units.push(new Unit({lat:u3.lat,lng:u3.lng,kind:'bradley',side:Side.AI}));
}
function aiUpdate(dt){
  AI.t+=dt; if(AI.t<3) return; AI.t=0;
  const pick=()=>{
    const opts=['infantry','bradley','bmp3','abrams','himars','f16'];
    const k=opts[rand(opts.length)];
    let src='barracks';
    if(['bradley','bmp3','abrams'].includes(k)) src='vehicleFactory';
    if(k==='himars') src='missileLab';
    if(k==='f16') src='airbase';
    const b=buildings.find(x=>x.side===Side.AI && x.btype===src && !x.underConstruction);
    if(!b) return;
    const jitter = offsetMeters(b.lat,b.lng, Math.random()*10, Math.random()*Math.PI*2);
    units.push(new Unit({lat:jitter.lat,lng:jitter.lng,kind:k,side:Side.AI}));
  };
  if(Math.random()<0.7) pick();

  if(Math.random()<0.4){
    const plBuild = (buildings.filter(b=>b.side===Side.PLAYER)[0]);
    const plUnit = (units.filter(u=>u.side===Side.PLAYER)[0]);
    const target = plBuild || plUnit;
    if(target){
      units.filter(u=>u.side===Side.AI).forEach(u=>{ u.target=target; u.tlat=target.lat; u.tlng=target.lng; });
    }
  }
}

// ======================= Ekonomi DÃ¶ngÃ¼sÃ¼ =======================
let econT=0;
function econUpdate(dt){
  econT+=dt; if(econT<RATES.tick) return; econT=0;
  const mills=buildings.filter(b=>b.side===Side.PLAYER && b.btype==='mill' && !b.underConstruction).length;
  const refs =buildings.filter(b=>b.side===Side.PLAYER && b.btype==='refinery' && !b.underConstruction).length;
  const mines=buildings.filter(b=>b.side===Side.PLAYER && b.btype==='mine' && !b.underConstruction).length;
  RES.food += mills*RATES.foodPerMill;
  RES.oil  += refs *RATES.oilPerRef;
  RES.iron += mines*RATES.ironPerMine;
  updateHUD();
}
function updateHUD(){
  HUD.food.textContent=Math.floor(RES.food);
  HUD.oil.textContent=Math.floor(RES.oil);
  HUD.iron.textContent=Math.floor(RES.iron);
  HUD.uInf.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='infantry').length;
  HUD.uAPC.textContent=units.filter(u=>u.side===Side.PLAYER && (u.kind==='bradley'||u.kind==='bmp3')).length;
  HUD.uTank.textContent=units.filter(u=>u.side===Side.PLAYER && (u.kind==='abrams'||u.kind==='leopard2')).length;
  HUD.uHIMARS.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='himars').length;
  HUD.uFighter.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='f16').length;
  HUD.uBomber.textContent=units.filter(u=>u.side===Side.PLAYER && u.kind==='su34').length;
}

// ======================= Hareket / SavaÅŸ (geo) =======================
function unitUpdate(u, dt){
  // Dozer inÅŸa
  if(u.kind==='dozer' && u.buildTask){
    const w = walls[u.buildTask.wallIndex];
    if(!w){ u.buildTask=null; }
    else{
      const Lm = distanceMeters(w.a.lat,w.a.lng,w.b.lat,w.b.lng);
      const built = w.builtMeters;
      if(built < Lm){
        // duvarda ilerle
        const t = built/Lm;
        const pos = lerpLL(w.a, w.b, t);
        moveTowardsLL(u, pos.lat, pos.lng, dt); // duvar baÅŸÄ±na
        const here = {lat:u.lat, lng:u.lng};
        if(distanceMeters(here.lat,here.lng,pos.lat,pos.lng) < 2){
          const add = DOZER_RATE_MPS * dt;
          w.builtMeters = Math.min(Lm, w.builtMeters + add);
          const t2 = w.builtMeters/Lm;
          const pos2 = lerpLL(w.a, w.b, t2);
          u.lat=pos2.lat; u.lng=pos2.lng;
          if(w.builtMeters>=Lm){ log('ğŸ§± Duvar inÅŸasÄ± tamamlandÄ±.'); u.buildTask=null; }
        }
        return;
      }else{
        u.buildTask=null;
      }
    }
  }

  // hedef edinme
  if(u.dps>0 && !u.target){
    const foes = units.concat(buildings).filter(e=> e.side!==u.side && !e.dead);
    let best=null, bestD=1e15;
    for(const f of foes){
      if(f instanceof Unit){
        const isAir=(f.role==='air');
        if(isAir && !u.targets.includes('air')) continue;
        if(!isAir && !u.targets.includes('ground')) continue;
      } else {
        if(!u.targets.includes('ground')) continue;
      }
      const d=distanceMeters(u.lat,u.lng,f.lat,f.lng);
      if(d<bestD && d<u.rangeM+500) { best=f; bestD=d; }
    }
    if(best) u.target=best;
  }

  // ateÅŸ et
  u.fireCd=Math.max(0, u.fireCd - dt);
  if(u.dps>0 && u.target && !u.target.dead){
    const d=distanceMeters(u.lat,u.lng,u.target.lat,u.target.lng);
    if(d<=u.rangeM){
      if(u.fireCd<=0){
        u.target.hp -= u.dps;
        drawShot(u,u.target);
        u.fireCd = 1/ (u.rof||1);
        if(u.target.hp<=0){ destroy(u.target, u); u.target=null; }
      }
    } else {
      u.tlat=u.target.lat; u.tlng=u.target.lng;
    }
  }

  // hareket
  moveTowardsLL(u, u.tlat, u.tlng, dt, true);
}

function moveTowardsLL(u, tlat, tlng, dt, collideWalls=false){
  if(u.immobile) return;
  const distM = distanceMeters(u.lat,u.lng,tlat,tlng);
  if(distM<=0.5) return;
  const mps = (u.speedKmh*1000/3600); // metre/sn
  const step = mps * dt;
  const t = Math.min(1, step/distM);
  const next = lerpLL({lat:u.lat,lng:u.lng}, {lat:tlat,lng:tlng}, t);

  // duvar Ã§arpÄ±ÅŸma (kara)
  if(collideWalls && u.role!=='air'){
    const aP = toPoint(u.lat,u.lng);
    const bP = toPoint(next.lat,next.lng);
    const radiusPx = 10;
    for(const w of walls){
      const builtEnd = pointAlong(w.a, w.b, w.builtMeters);
      const wA = toPoint(w.a.lat,w.a.lng);
      const wB = toPoint(builtEnd.lat,builtEnd.lng);
      const dpx = segDistPx(aP,bP,wA,wB);
      const wPx = metersWidthToPixels(w.widthMeters);
      if(dpx < (wPx/2 + radiusPx)){
        // Ã§arpÄ±ÅŸtÄ±
        u.tlat=u.lat; u.tlng=u.lng;
        return;
      }
    }
  }

  u.lat = next.lat; u.lng = next.lng;
}

function destroy(e,killer){
  e.dead=true;
  if(killer) log(`${killer.side===Side.PLAYER?'Bizim':'AI'} ${labelEnt(killer)} â†’ ${labelEnt(e)} yok etti.`);
}
function labelEnt(e){ return (e instanceof Unit)? labelOf(e.kind) : labelOfBuild(e.btype)+(e.isBase?' (Ãœs)':''); }
function drawShot(a,b){
  const p1=toPoint(a.lat,a.lng), p2=toPoint(b.lat,b.lng);
  shots.push({x1:p1.x,y1:p1.y,x2:p2.x,y2:p2.y,t:0.12});
}
const shots=[];

// ======================= BaÅŸlat =======================
function init(){
  RES.food=60; RES.oil=40; RES.iron=50; // baÅŸlangÄ±Ã§ daha kÄ±sÄ±tlÄ±
  // Oyuncu: ana Ã¼s + 1 kepÃ§e
  const baseLL = map.getCenter();
  buildings.push(new Building({lat:baseLL.lat, lng:baseLL.lng, btype:'barracks', side:Side.PLAYER, isBase:true}));
  const vfLL = offsetMeters(baseLL.lat,baseLL.lng, 200, 0.6);
  buildings.push(new Building({lat:vfLL.lat, lng:vfLL.lng, btype:'vehicleFactory', side:Side.PLAYER}));
  const millLL = offsetMeters(baseLL.lat,baseLL.lng, 250, 2.2);
  buildings.push(new Building({lat:millLL.lat, lng:millLL.lng, btype:'mill', side:Side.PLAYER}));

  const dozerLL = offsetMeters(baseLL.lat,baseLL.lng, 60, 1.0);
  units.push(new Unit({lat:dozerLL.lat,lng:dozerLL.lng,kind:'dozer',side:Side.PLAYER}));

  aiInit();
  updateHUD(); hint('HazÄ±r: YakÄ±nlaÅŸtÄ±r, bina kur, birim Ã¼ret, ğŸ§± duvar Ã§iz, saÄŸ tÄ±kla yÃ¶net.');
  selfTests();
}
init();

// ======================= Ã‡izim =======================
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Duvarlar
  for(const w of walls){
    const Lm = distanceMeters(w.a.lat,w.a.lng,w.b.lat,w.b.lng);
    const t = (Lm>0)? w.builtMeters/Lm : 1;
    const builtEnd = pointAlong(w.a, w.b, w.builtMeters);
    const A = toPoint(w.a.lat,w.a.lng), Bfull = toPoint(w.b.lat,w.b.lng), B = toPoint(builtEnd.lat,builtEnd.lng);

    // plan hattÄ±
    ctx.lineWidth = metersWidthToPixels(w.widthMeters);
    ctx.strokeStyle = 'rgba(255,255,255,.15)';
    ctx.setLineDash([8,8]);
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(Bfull.x,Bfull.y); ctx.stroke();

    // inÅŸa edilen kÄ±sÄ±m
    ctx.setLineDash([]);
    ctx.lineCap='round';
    ctx.strokeStyle = '#94a3b8';
    ctx.shadowColor='rgba(0,0,0,.4)'; ctx.shadowBlur=2;
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();

    // kenar Ã§izgisi
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(229,231,235,.8)';
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
    ctx.shadowBlur=0;
  }

  // Binalar
  for(const b of buildings){
    if(b.dead) continue;
    const p=toPoint(b.lat,b.lng);
    const r=16;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.fillStyle = b.side===Side.PLAYER ? 'rgba(16,185,129,.95)' : 'rgba(96,165,250,.95)';
    ctx.strokeStyle='rgba(0,0,0,.4)'; ctx.lineWidth=3;
    roundedRect(ctx,-r,-r, r*2, r*2, 6); ctx.fill(); ctx.stroke();

    ctx.fillStyle='#081017'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(bIcon(b.btype),0,0);

    const max = b.isBase? 1000 : 500;
    const pct=Math.max(0,Math.min(1,b.hp/max));
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-22, r+6, 44, 4);
    ctx.fillStyle= pct<.33? '#ef4444' : pct<.66? '#f59e0b' : '#22c55e';
    ctx.fillRect(-22, r+6, 44*pct, 4);
    if(b.sel){ ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=2; ctx.strokeRect(-r-3,-r-3,(r*2)+6,(r*2)+6); }
    if(b.underConstruction){
      const p2=Math.min(1,b.elapsed/(b.buildTime||10));
      ctx.fillStyle='rgba(255,255,255,.12)'; ctx.fillRect(-22, -r-8, 44, 4);
      ctx.fillStyle='#fde047'; ctx.fillRect(-22, -r-8, 44*p2, 4);
    }
    ctx.restore();
  }

  // Ãœniteler
  for(const u of units){
    if(u.dead) continue;
    const p=toPoint(u.lat,u.lng);
    const r=10;
    ctx.save(); ctx.translate(p.x,p.y);
    ctx.fillStyle = u.side===Side.PLAYER ? 'rgba(16,185,129,.95)' : 'rgba(96,165,250,.95)';
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='rgba(0,0,0,.4)'; ctx.stroke();
    ctx.fillStyle='#081017'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(uIcon(u.kind),0,0);

    const maxHp = (u.kind==='infantry')?100 : (u.kind==='himars'?260 : (u.kind==='patriot'?420 : (u.kind==='f16'?260:(u.kind==='su34'?360:(u.kind==='abrams'?620:(u.kind==='leopard2'?600:(u.kind==='bradley'?320:(u.kind==='bmp3'?300:280))))))));
    const pct=Math.max(0,Math.min(1,u.hp/maxHp));
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-18, r+5, 36, 3);
    ctx.fillStyle= pct<.33? '#ef4444' : pct<.66? '#f59e0b' : '#22c55e';
    ctx.fillRect(-18, r+5, 36*pct, 3);

    if(u.sel){
      ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,r+4,0,Math.PI*2); ctx.stroke();
      // menzil halkasÄ± (metre â†’ piksel)
      if(u.rangeM>0){
        const rp = metersToPixelsAt(u.lat, u.rangeM);
        ctx.strokeStyle='rgba(253,224,71,.9)'; ctx.fillStyle='rgba(253,224,71,.08)'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.arc(0,0, Math.max(20,rp), 0, Math.PI*2); ctx.fill(); ctx.stroke();
      }
    }
    ctx.restore();
  }

  // AtÄ±ÅŸ efektleri
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i];
    ctx.strokeStyle='#fde047'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(s.x1,s.y1); ctx.lineTo(s.x2,s.y2); ctx.stroke();
    s.t -= frameDt;
    if(s.t<=0) shots.splice(i,1);
  }

  // SeÃ§im kutusu
  if(mouse.down && mouse.drag){
    ctx.strokeStyle='rgba(147,197,253,.9)'; ctx.setLineDash([5,4]); ctx.lineWidth=1;
    ctx.fillStyle='rgba(59,130,246,.15)';
    const x1=Math.min(mouse.downAt.x,mouse.x), x2=Math.max(mouse.downAt.x,mouse.x);
    const y1=Math.min(mouse.downAt.y,mouse.y), y2=Math.max(mouse.downAt.y,mouse.y);
    ctx.fillRect(x1,y1,x2-x1,y2-y1); ctx.strokeRect(x1,y1,x2-x1,y2-y1);
    ctx.setLineDash([]);
  }

  // Duvar Ã§izim Ã¶nizleme
  if(wallMode && wallP1){
    const A = toPoint(wallP1.lat,wallP1.lng);
    const B = {x:mouse.x,y:mouse.y};
    ctx.setLineDash([6,6]); ctx.lineWidth = metersWidthToPixels(WALL_WIDTH_M);
    ctx.strokeStyle='rgba(34,197,94,.8)';
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
    ctx.setLineDash([]);
  }
}

function bIcon(t){ return t==='barracks'?'ğŸ–ï¸': t==='mill'?'ğŸŒ¾': t==='refinery'?'ğŸ›¢ï¸': t==='mine'?'â›ï¸': t==='vehicleFactory'?'ğŸ­': t==='missileLab'?'ğŸš€': t==='airbase'?'ğŸ›¬': t==='adsPlant'?'ğŸ›°ï¸':'ğŸšï¸'; }
function uIcon(k){ return COST[k]?.icon || 'â“'; }
function roundedRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

// ======================= DÃ¶ngÃ¼ =======================
let timeScale=1;
const spd=document.getElementById('speed'), spdLbl=document.getElementById('spdLbl');
function setSpeed(v){ timeScale=v; spd.value=v; spdLbl.textContent=v+'x'; hint('HÄ±z: '+v+'x'); }
spd.oninput=()=> setSpeed(+spd.value);
document.querySelectorAll('[data-s]').forEach(b=> b.onclick=()=> setSpeed(+b.dataset.s));

let last=performance.now(), frameDt=0.016;
function loop(now){
  const rawDt = Math.min(0.05, (now-last)/1000); last=now;
  const dt = rawDt * timeScale; frameDt = rawDt; // efekt sÃ¼releri iÃ§in raw

  // Bina inÅŸaat zamanlarÄ±
  for(const b of buildings){
    if(b.underConstruction){ b.elapsed+=dt; if(b.elapsed>=b.buildTime){ b.underConstruction=false; log(`âœ… ${labelOfBuild(b.btype)} tamamlandÄ±`); } }
  }

  // Ãœniteler
  for(const u of units){ if(!u.dead) unitUpdate(u, dt); }

  // Temizlik
  sweep();

  // Ekonomi + AI
  econUpdate(dt); aiUpdate(dt);

  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function sweep(){
  for(let i=units.length-1;i>=0;i--){ if(units[i].dead) units.splice(i,1); }
  for(let i=buildings.length-1;i>=0;i--){ if(buildings[i].dead) buildings.splice(i,1); }
}

// ======================= Geo YardÄ±mcÄ±lar =======================
function toPoint(lat,lng){ const p=map.latLngToContainerPoint([lat,lng]); return {x:p.x,y:p.y}; }
function distanceMeters(lat1,lng1,lat2,lng2){
  const R=6371000; const toRad=v=>v*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function bearingRad(lat1,lng1,lat2,lng2){
  const toRad=v=>v*Math.PI/180;
  const y=Math.sin(toRad(lng2-lng1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lng2-lng1));
  return Math.atan2(y,x);
}
function offsetMeters(lat,lng, meters, thetaRad){
  const R=6378137;
  const dLat = (meters*Math.cos(thetaRad))/R;
  const dLng = (meters*Math.sin(thetaRad))/(R*Math.cos(lat*Math.PI/180));
  return { lat: lat + dLat*180/Math.PI, lng: lng + dLng*180/Math.PI };
}
function lerpLL(a,b,t){
  // kÃ¼Ã§Ã¼k mesafelerde doÄŸrusal yaklaÅŸÄ±k yeterli
  return { lat: lerp(a.lat,b.lat,t), lng: lerp(a.lng,b.lng,t) };
}
function pointAlong(a,b, meters){
  const L = distanceMeters(a.lat,a.lng,b.lat,b.lng);
  if(L<=0) return {lat:a.lat,lng:a.lng};
  const t = meters/L;
  return lerpLL(a,b, Math.min(1, t));
}
function metersToPixelsAt(lat, meters){
  // 1 px karÅŸÄ±lÄ±ÄŸÄ± metre: iki yakÄ±n latlng arasÄ± projeksiyon
  const p1 = map.latLngToContainerPoint([lat, 0]);
  const p2 = map.latLngToContainerPoint([lat, 0.00001]);
  const mp = distanceMeters(lat,0,lat,0.00001);
  const pxPerM = Math.abs(p2.x-p1.x) / (mp||1);
  return meters * pxPerM;
}
function metersWidthToPixels(wm){ return Math.max(2, metersToPixelsAt(map.getCenter().lat, wm)); }

// Piksel segment uzaklÄ±ÄŸÄ± (Ã§arpÄ±ÅŸma)
function segDistPx(a,b,c,d){
  function pointSegDistPx(p,a,b){
    const vx=b.x-a.x, vy=b.y-a.y, wx=p.x-a.x, wy=p.y-a.y;
    const c1=vx*wx+vy*wy;
    if(c1<=0) return Math.hypot(p.x-a.x,p.y-a.y);
    const c2=vx*vx+vy*vy;
    if(c2<=c1) return Math.hypot(p.x-b.x,p.y-b.y);
    const t=c1/c2;
    const proj={x:a.x+vx*t,y:a.y+vy*t};
    return Math.hypot(p.x-proj.x,p.y-proj.y);
  }
  const samples=6;
  let md=1e9;
  for(let i=0;i<=samples;i++){
    const t=i/samples;
    const px=a.x + (b.x-a.x)*t, py=a.y + (b.y-a.y)*t;
    md=Math.min(md, pointSegDistPx({x:px,y:py}, c, d));
  }
  for(let i=0;i<=samples;i++){
    const t=i/samples;
    const px=c.x + (d.x-c.x)*t, py=c.y + (d.y-c.y)*t;
    md=Math.min(md, pointSegDistPx({x:px,y:py}, a, b));
  }
  return md;
}

// ======================= Self Tests =======================
function selfTests(){
  try{
    Object.keys(PROD_BY_BUILD).forEach(b=>{
      PROD_BY_BUILD[b].forEach(k=>{ console.assert(COST[k], 'COST yok:', k); });
    });
    const bb=buildings.find(x=>x.side===Side.PLAYER && x.btype==='barracks');
    console.assert(!!bb,'Player kÄ±ÅŸla var');
    console.log('âœ… Tests OK');
  }catch(e){ console.error('âŒ Test hata', e); }
}
})();
</script>
</body>
</html>
